
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction to ABACUS: Path to PW calculation - Part 7 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-image-captions/image-captions.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-auto-scroll-table/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-insert-logo/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="develop-path8.html" />
    
    
    <link rel="prev" href="develop-path6.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"MCresearch","repo":"abacus-user-guide","type":"star","size":"middle","count":true}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    ABACUS 使用教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="abacus-gcc.html">
            
                <a href="abacus-gcc.html">
            
                    
                    GCC 编译 ABACUS 教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="abacus-intel.html">
            
                <a href="abacus-intel.html">
            
                    
                    Intel oneAPI 编译 ABACUS 教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="abacus-hpc.html">
            
                <a href="abacus-hpc.html">
            
                    
                    在超算环境编译 ABACUS 的建议
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="abacus-dcu.html">
            
                <a href="abacus-dcu.html">
            
                    
                    ABACUS 在曙光 DCU 集群上的编译与使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="abacus-upf.html">
            
                <a href="abacus-upf.html">
            
                    
                    模守恒赝势生成方法简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="abacus-nac1.html">
            
                <a href="abacus-nac1.html">
            
                    
                    数值原子轨道（一）：ABACUS 中的数值原子轨道命名和使用方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.7" data-path="abacus-nac2.html">
            
                <a href="abacus-nac2.html">
            
                    
                    数值原子轨道（二）：生成给定模守恒赝势的数值原子轨道
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="abacus-nac3.html">
            
                <a href="abacus-nac3.html">
            
                    
                    数值原子轨道（三）：产生高精度数值原子轨道
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.9" data-path="abacus-md.html">
            
                <a href="abacus-md.html">
            
                    
                    ABACUS 分子动力学使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.10" data-path="abacus-sol.html">
            
                <a href="abacus-sol.html">
            
                    
                    ABACUS 隐式溶剂模型使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.11" data-path="abacus-sdft.html">
            
                <a href="abacus-sdft.html">
            
                    
                    ABACUS 随机波函数DFT方法使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.12" data-path="abacus-ofdft.html">
            
                <a href="abacus-ofdft.html">
            
                    
                    ABACUS 无轨道密度泛函理论方法使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.13" data-path="abacus-surface1.html">
            
                <a href="abacus-surface1.html">
            
                    
                    采用 ABACUS 进行表面计算（一）：静电势和功函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.14" data-path="abacus-surface2.html">
            
                <a href="abacus-surface2.html">
            
                    
                    采用 ABACUS 进行表面计算（二）：偶极修正
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.15" data-path="abacus-surface3.html">
            
                <a href="abacus-surface3.html">
            
                    
                    采用 ABACUS 进行表面计算（三）：表面能计算
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.16" data-path="abacus-surface4.html">
            
                <a href="abacus-surface4.html">
            
                    
                    采用 ABACUS 进行表面计算（四）：表面缺陷能和吸附能计算
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.17" data-path="abacus-surface5.html">
            
                <a href="abacus-surface5.html">
            
                    
                    采用 ABACUS 进行表面计算（五）：外加电场
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.18" data-path="abacus-surface6.html">
            
                <a href="abacus-surface6.html">
            
                    
                    采用 ABACUS 进行表面计算（六）：补偿电荷
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.19" data-path="abacus-phonopy.html">
            
                <a href="abacus-phonopy.html">
            
                    
                    ABACUS+Phonopy 计算声子谱
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.20" data-path="abacus-shengbte.html">
            
                <a href="abacus-shengbte.html">
            
                    
                    ABACUS+ShengBTE 计算晶格热导率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.21" data-path="abacus-dpgen.html">
            
                <a href="abacus-dpgen.html">
            
                    
                    ABACUS+DPGEN 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.22" data-path="abacus-libri.html">
            
                <a href="abacus-libri.html">
            
                    
                    ABACUS+LibRI 做杂化泛函计算教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.23" data-path="abacus-candela.html">
            
                <a href="abacus-candela.html">
            
                    
                    ABACUS+Candela 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.24" data-path="abacus-uspex.html">
            
                <a href="abacus-uspex.html">
            
                    
                    ABACUS+USPEX 接口教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.25" data-path="abacus-namd.html">
            
                <a href="abacus-namd.html">
            
                    
                    ABACUS+Hefei NAMD 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.26" data-path="abacus-wannier.html">
            
                <a href="abacus-wannier.html">
            
                    
                    ABACUS+Wannier90 使用教程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    ABACUS 开发者文档
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="develop-C++.html">
            
                <a href="develop-C++.html">
            
                    
                    ABACUS 开源项目 C++ 代码规范
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="develop-format.html">
            
                <a href="develop-format.html">
            
                    
                    ABACUS 中使用格式化工具 clang-format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="develop-dox.html">
            
                <a href="develop-dox.html">
            
                    
                    ABACUS 注释规范：Doxygen 入门 (c++)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="develop-issue.html">
            
                <a href="develop-issue.html">
            
                    
                    ABACUS 的 Github 仓库 Issues 处理流程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="develop-input.html">
            
                <a href="develop-input.html">
            
                    
                    ABACUS 线上文档输入参数撰写规范
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="develop-rule.html">
            
                <a href="develop-rule.html">
            
                    
                    ABACUS 代码存放规范
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="develop-linedete.html">
            
                <a href="develop-linedete.html">
            
                    
                    ABACUS 全局数据结构和代码行数检测
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="develop-test1.html">
            
                <a href="develop-test1.html">
            
                    
                    ABACUS 中的测试（一）：测试的重要性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="develop-test2.html">
            
                <a href="develop-test2.html">
            
                    
                    ABACUS 中的测试（二）：测试工具 gtest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="develop-path1.html">
            
                <a href="develop-path1.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.11" data-path="develop-path2.html">
            
                <a href="develop-path2.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.12" data-path="develop-path3.html">
            
                <a href="develop-path3.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.13" data-path="develop-path4.html">
            
                <a href="develop-path4.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.14" data-path="develop-path5.html">
            
                <a href="develop-path5.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.15" data-path="develop-sm1.html">
            
                <a href="develop-sm1.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Summary 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.16" data-path="develop-path6.html">
            
                <a href="develop-path6.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 6
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.17" data-path="develop-path7.html">
            
                <a href="develop-path7.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 7
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.18" data-path="develop-path8.html">
            
                <a href="develop-path8.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.19" data-path="develop-path9.html">
            
                <a href="develop-path9.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 9
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.20" data-path="develop-path10.html">
            
                <a href="develop-path10.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 10
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.21" data-path="develop-path11.html">
            
                <a href="develop-path11.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 11
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.22" data-path="develop-sm2.html">
            
                <a href="develop-sm2.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Summary Final
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    算法文档
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="algorithm-wannier.html">
            
                <a href="algorithm-wannier.html">
            
                    
                    最大局域化 Wannier 函数方法简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="algorithm-mix.html">
            
                <a href="algorithm-mix.html">
            
                    
                    电荷密度混合算法介绍
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="news.html">
            
                <a href="news.html">
            
                    
                    ABACUS 新闻稿整理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="contribute.html">
            
                <a href="contribute.html">
            
                    
                    如何贡献 ABACUS 使用教程
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Introduction to ABACUS: Path to PW calculation - Part 7</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="introduction-to-abacus-path-to-pw-calculation---part-7"><a name="introduction-to-abacus-path-to-pw-calculation---part-7" class="plugin-anchor" href="#introduction-to-abacus-path-to-pw-calculation---part-7"><i class="fa fa-link" aria-hidden="true"></i></a>Introduction to ABACUS: Path to PW calculation - Part 7</h1>
<p><strong>&#x4F5C;&#x8005;&#xFF1A;&#x9EC4;&#x4E00;&#x73C2;&#xFF0C;&#x90AE;&#x7BB1;&#xFF1A;huangyk@aisi.ac.cn</strong></p>
<p><strong>&#x5BA1;&#x6838;&#xFF1A;&#x9648;&#x9ED8;&#x6DB5;&#xFF0C;&#x90AE;&#x7BB1;&#xFF1A;mohanchen@pku.edu.cn</strong></p>
<p><strong>&#x98DE;&#x4E66;&#x94FE;&#x63A5;&#xFF1A;<a href="https://xmywuqhxb0.feishu.cn/docx/ZPswdc7WAo1GdWxLinicDYtcnwk" target="_blank">Introduction to ABACUS: Path to PW calculation - Part 7</a></strong></p>
<blockquote>
<p>&#x1F4C3;<strong>&#x5199;&#x5728;&#x524D;&#x9762;</strong></p>
<ol>
<li>&#x4E0D;&#x8131;&#x79BB;&#x4EE3;&#x7801;&#x2014;&#x2014;&#x907F;&#x514D;&#x8BFB;&#x8005;&#x770B;&#x5B8C;&#x624B;&#x518C;&#x540E;&#x5BF9;&#x4EE3;&#x7801;&#x6CA1;&#x6709;&#x4E00;&#x4E01;&#x70B9;&#x6982;&#x5FF5;</li>
<li>&#x4E0D;&#x5806;&#x780C;&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#x2014;&#x2014;&#x907F;&#x514D;&#x5E73;&#x5EB8;&#x7684;&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF0C;&#x52AA;&#x529B;&#x517C;&#x987E;&#x62C9;&#x8FD1;&#x8BFB;&#x8005;&#x548C;&#x4EE3;&#x7801;&#x8DDD;&#x79BB;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x505A;&#x5230;&#x63D0;&#x7EB2;&#x6308;&#x9886;&#xFF0C;&#x4E0D;&#x9010;&#x884C;&#x590D;&#x5236;&#x4EE3;&#x7801;&#x540E;&#x8FDB;&#x884C;&#x505C;&#x7559;&#x5728;&#x4EE3;&#x7801;&#x8BED;&#x4E49;&#x4E0A;&#x7684;&#x89E3;&#x91CA;</li>
</ol>
</blockquote>
<p><strong>Driver</strong></p>
<p><strong>Driver::atomic_world()<strong></strong></strong></p>
<p><strong>Driver::driver_run()<strong></strong></strong></p>
<h1 id="&#x591A;&#x5C42;&#x7EE7;&#x627F;&#xFF1A;init-functions-in-esolver-class"><a name="&#x591A;&#x5C42;&#x7EE7;&#x627F;&#xFF1A;init-functions-in-esolver-class" class="plugin-anchor" href="#&#x591A;&#x5C42;&#x7EE7;&#x627F;&#xFF1A;init-functions-in-esolver-class"><i class="fa fa-link" aria-hidden="true"></i></a>&#x591A;&#x5C42;&#x7EE7;&#x627F;&#xFF1A;Init() functions in esolver class</h1>
<p>&#x7EC8;&#x4E8E;&#x6765;&#x5230;&#x548C;&#x539F;&#x672C; <code>p_esolver</code> &#x76F8;&#x540C;&#x7684;&#x7C7B;&#x7684;&#x6210;&#x5458;&#x51FD;&#x6570; <code>Init()</code>&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Input<span class="token operator">&amp;</span> inp<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> ucell<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ESolver_KS</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>inp<span class="token punctuation">,</span> ucell<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- we just leave from here</span>

    <span class="token comment">// Initialize HSolver</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">=</span> <span class="token keyword">new</span> hsolver<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">HSolverPW</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>wf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Initialize ElecState</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec <span class="token operator">=</span> <span class="token keyword">new</span> elecstate<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">ElecStatePW</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>chr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>kv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_rho<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_big<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Initialize the charge density</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>charge<span class="token operator">-&gt;</span><span class="token function">allocate</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>omega <span class="token operator">=</span> GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>omega<span class="token punctuation">;</span>

    <span class="token comment">// Initialize the potential</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>pot <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>pot <span class="token operator">=</span> <span class="token keyword">new</span> elecstate<span class="token double-colon punctuation">::</span><span class="token function">Potential</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_rho<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span>vloc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>sf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>etxc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>vtxc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">Init_GlobalC</span><span class="token punctuation">(</span>inp<span class="token punctuation">,</span> ucell<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>ocp<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span><span class="token function">fixed_weights</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>ocp_kb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="initialization-of-hsolverpw-object"><a name="initialization-of-hsolverpw-object" class="plugin-anchor" href="#initialization-of-hsolverpw-object"><i class="fa fa-link" aria-hidden="true"></i></a>Initialization of HSolverPW object</h2>
<h3 id="constructor"><a name="constructor" class="plugin-anchor" href="#constructor"><i class="fa fa-link" aria-hidden="true"></i></a>Constructor</h3>
<p>&#x9996;&#x5148;&#x6765;&#x5230;&#x6309;&#x7167;&#x6CE8;&#x91CA;&#x5212;&#x5206;&#x7684;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#x201C;Initialize HSolver&#x201D;&#xFF08;line 6&#xFF0C;HSolver &#x5C31;&#x662F;&#x6C42;&#x89E3;&#x4F53;&#x7CFB;&#x54C8;&#x5BC6;&#x987F;&#x91CF;&#x7684;&#x6C42;&#x89E3;&#x5668;&#xFF09;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Input<span class="token operator">&amp;</span> inp<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> ucell<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ESolver_KS</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>inp<span class="token punctuation">,</span> ucell<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize HSolver</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">=</span> <span class="token keyword">new</span> hsolver<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">HSolverPW</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>wf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x5176;&#x5B9E; <code>phsol</code>&#xFF08;&#x6B64;&#x5904;&#x547D;&#x540D;&#x903B;&#x8F91;&#x4E3A; p &#x4EE3;&#x8868; Pointer&#xFF0C;hsol &#x4E3A; HSolver &#x7684;&#x7F29;&#x5199;&#xFF09;&#x5E76;&#x975E;&#x662F; <code>ESolver_KS_PW</code> &#x7C7B;&#x4E2D;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF0C;&#x800C;&#x662F;&#x5728; <code>ESolver_KS</code> &#x4E2D;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740; <code>ESolver_KS</code> &#x7684;&#x6D3E;&#x751F;&#x7C7B;&#x5747;&#x6709;&#x53EF;&#x80FD;&#x4F7F;&#x7528;&#x8FD9;&#x4E00;&#x6570;&#x636E;&#x6210;&#x5458;&#x3002;&#x7A0D;&#x52A0;&#x641C;&#x7D22;&#xFF0C;&#x53D1;&#x73B0; <code>ESolver_KS_LCAO::Init()</code> &#x4E2D;&#x4E5F;&#x6709;&#x7C7B;&#x4F3C;&#x64CD;&#x4F5C;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">ESolver_KS_LCAO</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Input<span class="token operator">&amp;</span> inp<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> ucell<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// init HSolver</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">=</span> <span class="token keyword">new</span> hsolver<span class="token double-colon punctuation">::</span><span class="token function">HSolverLCAO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>LOWF<span class="token punctuation">.</span>ParaV<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol<span class="token operator">-&gt;</span>method <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>KS_SOLVER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x53E6;&#x4E00;&#x70B9;&#x53EF;&#x4EE5;&#x9884;&#x6599;&#x7684;&#x662F;&#xFF0C;&#x5728;&#x57FA;&#x7C7B; <code>ESolver_KS</code> &#x7684;&#x58F0;&#x660E;&#x4E2D;&#xFF0C;<code>phsol</code> &#x8D77;&#x59CB;&#x88AB;&#x58F0;&#x660E;&#x4E3A;&#x57FA;&#x7C7B; <code>HSolver</code> &#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x975E;&#x76F4;&#x63A5;&#x5730; <code>HSolverPW</code> &#x8FD9;&#x4E00;&#x6D3E;&#x751F;&#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E00;&#x64CD;&#x4F5C;&#x518D;&#x6B21;&#x4F53;&#x73B0;&#x4E86; C++ &#x7684;&#x591A;&#x6001;&#x7F16;&#x7A0B;&#x601D;&#x8DEF;&#x3002;&#x5177;&#x4F53;&#x5728;&#x5F53;&#x524D; Init &#x51FD;&#x6570;&#x4E2D;&#xFF0C;<code>phsol</code> &#x88AB;&#x5206;&#x914D;&#x5185;&#x5B58;&#x65F6;&#x8C03;&#x7528;&#x7684; <code>HSolverPW</code> &#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x5F62;&#x53C2;&#x8868;&#x4E2D;&#xFF0C;<code>pw_wfc</code> &#x662F;&#x5C5E;&#x4E8E; <code>PW_Basis_K</code>&#xFF08;&#x4EE5;&#x53CA;&#x5176;&#x6D3E;&#x751F;&#x7C7B; <code>PW_Basis_K_Big</code>&#xFF09;&#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x7EE7;&#x627F;&#x81EA; <code>ESolver_KS</code>&#x3002;<code>wf</code> &#x662F; <code>wavefunc</code> &#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x4E5F;&#x7EE7;&#x627F;&#x81EA; <code>ESolver_KS</code>&#xFF0C;&#x8FD9;&#x4F53;&#x73B0;&#x4E86;&#x4EC5;&#x5BF9;&#x4E8E; <code>ESolver_KS</code> &#x5C42;&#x7EA7;&#x800C;&#x8A00;&#x9700;&#x8981;&#x5E26;&#x6709; k &#x70B9;&#x7684;&#x5E73;&#x9762;&#x6CE2;&#x6CE2;&#x51FD;&#x6570;&#xFF0C;&#x4EE5;&#x53CA;&#x6CE2;&#x51FD;&#x6570;&#x7684;&#x5B58;&#x50A8;&#x7C7B;&#xFF0C;&#x800C;&#x518D;&#x4E0A;&#x4E00;&#x7EA7; <code>ESolver_FP</code> &#x5219;&#x4E0D;&#x4E00;&#x5B9A;&#x9700;&#x8981;&#x8FD9;&#x4E24;&#x8005;&#x3002;&#x5E73;&#x884C;&#x800C;&#x8A00; <code>ESolver_OF</code> &#x4E5F;&#x5C5E;&#x4E8E;&#x201C;FP&#x201D;&#xFF0C;&#x4F46;&#x5728; <code>ESolver_FP</code> &#x7684;&#x6D3E;&#x751F;&#x7C7B; <code>ESolver_OF</code> &#x4E2D;&#xFF0C;&#x4E1D;&#x6BEB;&#x6CA1;&#x6709;&#x5173;&#x4E8E;&#x5E73;&#x9762;&#x6CE2;&#x6CE2;&#x51FD;&#x6570;&#x7684;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF1A;</p>
<p><img src="picture/fig_path7-1.png" alt=""></p>
<p>&#x6D3E;&#x751F;&#x7C7B; <code>HSolverPW</code> &#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5176;&#x7ED3;&#x6784;&#x5341;&#x5206;&#x7B80;&#x5355;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">HSolverPW</span><span class="token punctuation">(</span>ModulePW<span class="token double-colon punctuation">::</span>PW_Basis_K<span class="token operator">*</span> wfc_basis_in<span class="token punctuation">,</span> wavefunc<span class="token operator">*</span> pwf_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>classname <span class="token operator">=</span> <span class="token string">&quot;HSolverPW&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis <span class="token operator">=</span> wfc_basis_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pwf <span class="token operator">=</span> pwf_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>diag_ethr <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>PW_DIAG_THR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#xFF0C;&#x5373;&#x5C06; <code>ESolver_KS::pw_wfc</code> &#x590D;&#x5236;&#x8FDB; HSolverPW &#x7684;&#x6570;&#x636E;&#x6210;&#x5458; <code>wfc_basis</code>&#xFF0C;<code>ESolver_KS::wf</code> &#x5230; <code>HSolverPW::pwf</code>&#x3002;</p>
<h2 id="initialization-of-elecstate-object"><a name="initialization-of-elecstate-object" class="plugin-anchor" href="#initialization-of-elecstate-object"><i class="fa fa-link" aria-hidden="true"></i></a>Initialization of ElecState object</h2>
<h3 id="constructor"><a name="constructor" class="plugin-anchor" href="#constructor"><i class="fa fa-link" aria-hidden="true"></i></a>Constructor</h3>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6765;&#x5230; <code>ESolver_KS_PW::Init()</code>&#x201C;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#x201D;&#x4E2D; <code>ElecState</code> &#x7C7B;&#x5BF9;&#x8C61;&#x7684;&#x521D;&#x59CB;&#x5316;&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Input<span class="token operator">&amp;</span> inp<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> ucell<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// init ElecState,</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec <span class="token operator">=</span> <span class="token keyword">new</span> elecstate<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">ElecStatePW</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token punctuation">,</span>
                                                                 <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>chr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                 <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>kv<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                 <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_rho<span class="token punctuation">,</span>
                                                                 <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_big<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x548C; <code>phsol</code> &#x540C;&#x6837;&#x5730;&#xFF0C;&#x8FD9;&#x4E00;&#x6B21; <code>pelec</code> &#x662F;&#x7EE7;&#x627F;&#x81EA; <code>ESolver_FP</code> &#x7C7B;&#xFF08;&#x56E0;&#x6B64;&#x8BF4;&#x660E; <code>FP</code> &#x4E0D;&#x4EC5; <code>KS</code> &#x6D3E;&#x751F;&#x7C7B;&#x9700;&#x8981;&#x7535;&#x8377;&#x8FD9;&#x4E00;&#x7269;&#x7406;&#x91CF;&#xFF09;&#xFF0C;&#x4F46; <code>pelec</code> &#x5B9E;&#x9645;&#x88AB;&#x58F0;&#x660E;&#x4E3A;&#x57FA;&#x7C7B; <code>ElecState</code> &#x7684;&#x6307;&#x9488;&#xFF0C;&#x5728; <code>ESolver_KS_PW::Init()</code> &#x4E2D;&#x88AB;&#x5206;&#x914D;&#x4EE5;&#x5176;&#x6D3E;&#x751F;&#x7C7B; <code>ElecStatePW</code> &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF08;&#x540C;&#x6837;&#x5730;&#x4E5F;&#x6709; <code>ElecStateLCAO</code> &#x6D3E;&#x751F;&#x7C7B;&#x7B49;&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x8C03;&#x7528;&#x6D3E;&#x751F;&#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token class-name">ElecStatePW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">ElecStatePW</span><span class="token punctuation">(</span>ModulePW<span class="token double-colon punctuation">::</span>PW_Basis_K <span class="token operator">*</span>wfc_basis_in<span class="token punctuation">,</span> Charge<span class="token operator">*</span> chg_in<span class="token punctuation">,</span> K_Vectors <span class="token operator">*</span>pkv_in<span class="token punctuation">,</span> ModulePW<span class="token double-colon punctuation">::</span>PW_Basis<span class="token operator">*</span> rhopw_in<span class="token punctuation">,</span> ModulePW<span class="token double-colon punctuation">::</span>PW_Basis_Big<span class="token operator">*</span> bigpw_in<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">basis</span><span class="token punctuation">(</span>wfc_basis_in<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>classname <span class="token operator">=</span> <span class="token string">&quot;ElecStatePW&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">init_ks</span><span class="token punctuation">(</span>chg_in<span class="token punctuation">,</span> pkv_in<span class="token punctuation">,</span> pkv_in<span class="token operator">-&gt;</span>nks<span class="token punctuation">,</span> rhopw_in<span class="token punctuation">,</span> bigpw_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x8BE5;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x51FD;&#x6570;&#x4F53;&#x5916;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x6210;&#x5458;&#x53D8;&#x91CF; <code>basis</code> &#x4EE5; <code>ESolver_KS::pw_wfc</code>&#x3002;&#x9664;&#x4E86;&#x8BBE;&#x7F6E; <code>ElecStatePW::classname</code> &#x8FD9;&#x4E00;&#x6570;&#x636E;&#x6210;&#x5458;&#x7684;&#x5177;&#x4F53;&#x503C;&#x5916;&#xFF0C;&#x8C03;&#x7528; <code>ElecState::init_ks()</code> &#x51FD;&#x6570;&#xFF08;&#x663E;&#x7136;&#x7EE7;&#x627F;&#x81EA;&#x57FA;&#x7C7B;&#xFF09;&#x3002;</p>
<p><img src="picture/fig_path7-flow.png" alt=""></p>
<h3 id="elecstateinitks"><a name="elecstateinitks" class="plugin-anchor" href="#elecstateinitks"><i class="fa fa-link" aria-hidden="true"></i></a>ElecState::init_ks()</h3>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">ElecState</span><span class="token double-colon punctuation">::</span><span class="token function">init_ks</span><span class="token punctuation">(</span>Charge<span class="token operator">*</span> chg_in<span class="token punctuation">,</span> <span class="token comment">// pointer for class Charge</span>
                        <span class="token keyword">const</span> K_Vectors<span class="token operator">*</span> klist_in<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> nk_in<span class="token punctuation">,</span>
                        ModulePW<span class="token double-colon punctuation">::</span>PW_Basis<span class="token operator">*</span> rhopw_in<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> ModulePW<span class="token double-colon punctuation">::</span>PW_Basis_Big<span class="token operator">*</span> bigpw_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>charge <span class="token operator">=</span> chg_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>charge<span class="token operator">-&gt;</span><span class="token function">set_rhopw</span><span class="token punctuation">(</span>rhopw_in<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span>klist <span class="token operator">=</span> klist_in<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span>bigpw <span class="token operator">=</span> bigpw_in<span class="token punctuation">;</span>

    <span class="token comment">// init nelec_spin with nelec and nupdown</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">init_nelec_spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// autoset and check GlobalV::NBANDS, nelec_spin is used when NSPIN==2</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">cal_nbands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// initialize ekb and wg</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>nk_in<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>wg<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>nk_in<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="link-charge-elecstatecharge-to-charge-esolverfpchg"><a name="link-charge-elecstatecharge-to-charge-esolverfpchg" class="plugin-anchor" href="#link-charge-elecstatecharge-to-charge-esolverfpchg"><i class="fa fa-link" aria-hidden="true"></i></a>Link Charge* ElecState::charge to Charge ESolver_FP::chg</h4>
<p>&#x26A0; &#x6CE8;&#x610F;&#x5728; <code>ElecState</code>/<code>ElecStatePW</code> &#x7C7B;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x6210;&#x5458; <code>charge</code> &#x662F; <code>Charge</code> &#x7C7B;&#x6307;&#x9488;&#xFF0C;&#x88AB;&#x8D4B;&#x503C;&#x4E3A; <code>ESolver_FP</code> &#x7C7B;&#x7684; <code>Charge</code> &#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x5373;&#x4F7F;&#x5F97; <code>ElecState</code> &#x7C7B;&#x7684; <code>Charge</code> &#x7C7B;&#x6307;&#x9488;&#x6307;&#x5411; <code>ESolver_FP</code> &#x7684; <code>chr</code> &#x6570;&#x636E;&#x6210;&#x5458;&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">namespace</span> ModuleESolver
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">ESolver_FP</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ESolver</span></span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pelec <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        Charge chr<span class="token punctuation">;</span>
        ModuleSymmetry<span class="token double-colon punctuation">::</span>Symmetry symm<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        K_Vectors kv<span class="token punctuation">;</span>
</code></pre>
<p>&#x56E0;&#x6B64;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">this</span><span class="token operator">-&gt;</span>charge <span class="token operator">=</span> chg_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>charge<span class="token operator">-&gt;</span><span class="token function">set_rhopw</span><span class="token punctuation">(</span>rhopw_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x7684;&#x610F;&#x4E49;&#x5728;&#x4E8E;&#x7531; <code>ElecState::init_ks()</code> &#x4F5C;&#x4E3A;&#x88AB;&#x5305;&#x542B;&#x5728; <code>ESolver_FP</code>&#xFF08;&#x6216;&#x8BF4; <code>ESolver</code>&#xFF09;&#x5BF9;&#x8C61;&#x4E2D;&#x7684; <code>Charge</code> &#x7C7B;&#x5BF9;&#x8C61; <code>chg</code> &#x548C; <code>PW_Basis</code> &#x7C7B; <code>pw_rho</code> &#x7684;&#x8FDE;&#x63A5;&#x3002;&#xFF08;&#x662F;&#x5426;&#x5197;&#x4F59;&#xFF1F;&#xFF09;</p>
<p>&#x53D8;&#x91CF; <code>ElecState::klist</code>&#x3001;<code>ElecState::bigpw</code>&#x3001;<code>ElecState::rhopw</code> &#x4F20;&#x5165;&#x7684;&#x5B9E;&#x53C2;&#x4E5F;&#x7C7B;&#x4F3C;&#xFF0C;&#x540C;&#x6837;&#x6765;&#x81EA;&#x4E8E; <code>ESolver_FP</code>&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">Charge</span><span class="token double-colon punctuation">::</span><span class="token function">set_rhopw</span><span class="token punctuation">(</span>ModulePW<span class="token double-colon punctuation">::</span>PW_Basis<span class="token operator">*</span> rhopw_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhopw <span class="token operator">=</span> rhopw_in<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>&#x1F914;&#x5728;&#x53D8;&#x91CF;&#x547D;&#x540D;&#x8FC7;&#x7A0B;&#x4E2D;&#x5E94;&#x5F53;&#x6CE8;&#x610F;&#x907F;&#x514D;&#x968F;&#x610F;</p>
</blockquote>
<table>
<thead>
<tr>
<th>context</th>
<th>&#x7528;&#x4E8E;&#x5C55;&#x5F00;&#x7535;&#x8377;&#x7684; PW_Basis &#x7C7B;&#x6307;&#x9488;</th>
<th>&#x5305;&#x542B; Big FFT grid &#x7684;&#x7528;&#x4E8E;&#x7535;&#x8377;&#x5C55;&#x5F00;&#x7684; PW_Basis_Big &#x7C7B;&#x6307;&#x9488;</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ElecState</code> &#x6570;&#x636E;&#x6210;&#x5458;</td>
<td></td>
<td><code>bigpw</code></td>
</tr>
<tr>
<td><code>ElecState::init_ks()</code></td>
<td><code>rhopw_in</code></td>
<td><code>bigpw_in</code></td>
</tr>
<tr>
<td><code>ESolver_KS_PW::Init()</code></td>
<td><code>pw_rho</code></td>
<td><code>pw_big</code></td>
</tr>
<tr>
<td><code>ESolver_FP</code> &#x6570;&#x636E;&#x6210;&#x5458;</td>
<td><code>pw_rho</code></td>
<td><code>pw_big</code></td>
</tr>
<tr>
<td><code>Charge</code> &#x6570;&#x636E;&#x6210;&#x5458;</td>
<td><code>rhopw</code></td>
</tr>
</tbody>
</table>
<h4 id="calculate-numbers-of-electrons-in-different-spin-channels"><a name="calculate-numbers-of-electrons-in-different-spin-channels" class="plugin-anchor" href="#calculate-numbers-of-electrons-in-different-spin-channels"><i class="fa fa-link" aria-hidden="true"></i></a>Calculate numbers of electrons in different spin channels</h4>
<p><code>ElecState::init_nelec_spin()</code> &#x51FD;&#x6570;&#x7684;&#x8C03;&#x7528;&#x4E3A; <code>this-&gt;nelec_spin</code> &#x8D4B;&#x503C;&#xFF0C;&#x5176;&#x4E2D; <code>GlobalV::nupdown</code> &#x7684;&#x610F;&#x4E49;&#x5DF2;&#x7ECF;&#x5728;&#xFF08;<a href="develop-path2.html">Introduction to ABACUS: Path to PW calculation - Part 2</a> &#xFF09;&#x4ECB;&#x7ECD;&#xFF0C;&#x4E3A; up &#x548C; down spin &#x7684;&#x5DEE;&#x503C;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">ElecState</span><span class="token double-colon punctuation">::</span><span class="token function">init_nelec_spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// in fact, when TWO_EFERMI(nupdown in INPUT is not 0.0), nelec_spin will be fixed.</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>nelec <span class="token operator">+</span> GlobalV<span class="token double-colon punctuation">::</span>nupdown<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>nelec <span class="token operator">-</span> GlobalV<span class="token double-colon punctuation">::</span>nupdown<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="get-number-of-bands-to-solve-elecstatecalnbands"><a name="get-number-of-bands-to-solve-elecstatecalnbands" class="plugin-anchor" href="#get-number-of-bands-to-solve-elecstatecalnbands"><i class="fa fa-link" aria-hidden="true"></i></a>Get number of bands to solve: ElecState::cal_nbands()</h4>
<p><code>ElecState::cal_nbands()</code> &#x51FD;&#x6570;&#x7684;&#x8C03;&#x7528;&#x4E3A; <code>GlobalV::NBANDS</code>&#xFF08;&#x9700;&#x8981;&#x8BA1;&#x7B97;&#x7684;&#x80FD;&#x5E26;&#x6570;&#x91CF;&#xFF09;&#x8FD9;&#x4E00;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x6216;&#x5BF9;&#x901A;&#x8FC7; <code>INPUT</code> &#x6587;&#x4EF6;&#x4E2D; <code>nbands</code> &#x5173;&#x952E;&#x8BCD;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x7684;&#x503C;&#x8FDB;&#x884C;&#x5408;&#x7406;&#x6027;&#x68C0;&#x67E5;&#x3002;&#x5BF9;&#x4E8E;&#x672A;&#x5728; <code>INPUT</code> &#x6587;&#x4EF6;&#x4E2D;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5219;&#x5728;&#x6B64;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#x4ECD;&#x7136;&#x4FDD;&#x6301;&#x503C;&#x4E3A; 0&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x8D4B;&#x503C;&#x7B56;&#x7565;&#x4E3A;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">ElecState</span><span class="token double-colon punctuation">::</span><span class="token function">cal_nbands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>LSPINORB <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        occupied_bands <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>nelec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* it can only be the case of uks, but if so, the following method for calculating NBANDS will make this variable meaningless cuz never used! */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>occupied_bands <span class="token operator">-</span> std<span class="token double-colon punctuation">::</span><span class="token function">floor</span><span class="token punctuation">(</span>occupied_bands<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        occupied_bands <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">floor</span><span class="token punctuation">(</span>occupied_bands<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">;</span> <span class="token comment">// mohan fix 2012-04-16</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">OUT</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>ofs_running<span class="token punctuation">,</span> <span class="token string">&quot;occupied bands&quot;</span><span class="token punctuation">,</span> occupied_bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token keyword">int</span> nbands1 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>occupied_bands<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">int</span> nbands2 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1.2</span> <span class="token operator">*</span> occupied_bands<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>nbands1<span class="token punctuation">,</span> nbands2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>BASIS_TYPE <span class="token operator">!=</span> <span class="token string">&quot;pw&quot;</span><span class="token punctuation">)</span>
                GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NLOCAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token keyword">int</span> nbands3 <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>nelec <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">int</span> nbands4 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1.2</span> <span class="token operator">*</span> GlobalV<span class="token double-colon punctuation">::</span>nelec<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>nbands3<span class="token punctuation">,</span> nbands4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>BASIS_TYPE <span class="token operator">!=</span> <span class="token string">&quot;pw&quot;</span><span class="token punctuation">)</span>
                GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NLOCAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">/* max() is because the keyword nupdown can either be positive or negative */</span>
            <span class="token keyword">const</span> <span class="token keyword">double</span> max_occ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">int</span> nbands3 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>max_occ<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">int</span> nbands4 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1.2</span> <span class="token operator">*</span> max_occ<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>nbands3<span class="token punctuation">,</span> nbands4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>BASIS_TYPE <span class="token operator">!=</span> <span class="token string">&quot;pw&quot;</span><span class="token punctuation">)</span>
                GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NLOCAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">AUTO_SET</span><span class="token punctuation">(</span><span class="token string">&quot;NBANDS&quot;</span><span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="picture/fig_path7-2.png" alt=""></p>
<blockquote>
<p>&#x1F914;<strong>&#x601D;&#x8003;&#x65F6;&#x95F4;</strong>
Is there any differences bewteen the ways to assign default values for number of bands to calculate in ABACUS and Quantum ESPRESSO?</p>
</blockquote>
<p>&#x56DE;&#x6EAF;&#xFF1A;<code>GlobalV::nelec</code> &#x7684;&#x503C;&#x4ECE; <code>ESolver_KS::Init()</code> &#x8C03;&#x7528;&#x65F6;&#x786E;&#x5B9A;&#xFF08;&#x5177;&#x4F53;&#x8C03;&#x7528; <code>UnitCell::cal_nelec()</code>&#xFF0C;<a href="develop-path5.html">Introduction to ABACUS: Path to PW calculation - Part 5</a>&#xFF09;&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//module_base/global_variable.cpp</span>
GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//module_io/input.cpp</span>
INPUT<span class="token punctuation">.</span>nbands <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//module_io/input.cpp::Read()</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;nbands&quot;</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// number of atom bands</span>
        <span class="token punctuation">{</span>
            <span class="token function">read_value</span><span class="token punctuation">(</span>ifs<span class="token punctuation">,</span> nbands<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//module_io/input_conv.cpp</span>
    GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">=</span> INPUT<span class="token punctuation">.</span>nbands<span class="token punctuation">;</span>
</code></pre>
<p>&#x5BF9;&#x4E8E;&#x8D4B;&#x503C;&#x7684;&#x60C5;&#x51B5;&#x5219;&#x9700;&#x8981;&#x5BF9;&#x5176;&#x5408;&#x7406;&#x6027;&#x8FDB;&#x884C;&#x68C0;&#x67E5;&#xFF0C;&#x4E00;&#x65B9;&#x9762;&#x662F;&#x5BF9;&#x4F7F;&#x7528; smearing &#x65F6;&#x5019;&#x7684; <code>nbands</code> &#x6570;&#x91CF;&#xFF08;&#x5BF9;&#x4E8E;&#x80FD;&#x7EA7;&#x7B80;&#x5E76;&#x5EA6;&#x8F83;&#x9AD8;&#x7684;&#x60C5;&#x51B5;&#xFF0C;SCF &#x8FC7;&#x7A0B;&#x4E2D;&#x80FD;&#x7EA7;&#x7684;&#x53D8;&#x5316;&#x5C06;&#x5F15;&#x8D77;&#x80FD;&#x91CF;&#x7684;&#x53D8;&#x5316;&#x5267;&#x70C8;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; smearing &#x65B9;&#x6CD5;&#x5F25;&#x6563;&#x6700;&#x9AD8;&#x5360;&#x636E;&#x80FD;&#x7EA7;&#x9644;&#x8FD1;&#x7684;&#x7535;&#x5B50;&#x5E03;&#x5C45;&#xFF0C;&#x4F7F;&#x5F97;&#x80FD;&#x91CF;&#x53D8;&#x5316;&#x5267;&#x70C8;&#x7A0B;&#x5EA6;&#x51CF;&#x5C11;&#x3002;smearing &#x7684;&#x5177;&#x4F53;&#x53C2;&#x7167;&#x4E00;&#x65B9;&#x9762;&#x53EF;&#x4EE5;&#x7531;&#x72EC;&#x7ACB;&#x8D39;&#x7C73;&#x5B50;&#x4F53;&#x7CFB;&#x6240;&#x9075;&#x5FAA; Fermi-Dirac &#x7EDF;&#x8BA1;&#x501F;&#x9274;&#x800C;&#x6765;&#xFF0C;&#x6216;&#x76F4;&#x63A5;&#x91C7;&#x7528; Gauss &#x5206;&#x5E03;&#x3002;&#x63A7;&#x5236; smearing &#x7684;&#x53C2;&#x6570;&#x53D6;&#x503C;&#x8D8A;&#x5927;&#xFF0C;&#x7535;&#x5B50;&#x504F;&#x79BB;&#x201C;0 &#x6E29;&#x201D;&#x8D8A;&#x4E25;&#x91CD;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x52A0;&#x901F;&#x7535;&#x5B50;&#x8FED;&#x4EE3;&#x7684;&#x6536;&#x655B;&#x3002;&#x5B9E;&#x9645;&#x8BA1;&#x7B97;&#x65F6;&#xFF0C;&#x4E00;&#x822C;&#x5BF9;&#x534A;&#x5BFC;&#x4F53;&#x6216;&#x8005;&#x7EDD;&#x7F18;&#x4F53;&#x3001;&#x6216;&#x8005;&#x6709; gap &#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0D;&#x53D6; smearing&#xFF0C;&#x6216;&#x8005; smearing &#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#xFF1B;&#x5982;&#x679C;&#x5BF9;&#x91D1;&#x5C5E;&#x7CFB;&#x7EDF;&#xFF0C;&#x53EF;&#x4EE5;&#x9002;&#x5F53;&#x53D6;&#x4E00;&#x70B9; smearing &#x52A0;&#x901F;&#x6536;&#x655B;&#xFF0C;&#x4F46;&#x592A;&#x5927;&#x5BB9;&#x6613;&#x5F15;&#x8D77;&#x7ED3;&#x679C;&#x4E0D;&#x51C6;&#x786E;&#xFF09;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">ElecState</span><span class="token double-colon punctuation">::</span><span class="token function">cal_nbands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">==</span> occupied_bands<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Occupy</span><span class="token double-colon punctuation">::</span><span class="token function">gauss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;ElecState::cal_nbands&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;for smearing, num. of bands &gt; num. of occupied bands&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><code>Occupy</code> &#x662F;&#x5728; <code>input_conv</code> &#x88AB;&#x8C03;&#x7528;&#x65F6;&#x6240;&#x8D4B;&#x503C;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;</p>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//module_io/input_conv.cpp line 589</span>
    <span class="token class-name">Occupy</span><span class="token double-colon punctuation">::</span><span class="token function">decision</span><span class="token punctuation">(</span>INPUT<span class="token punctuation">.</span>occupations<span class="token punctuation">,</span> INPUT<span class="token punctuation">.</span>smearing_method<span class="token punctuation">,</span> INPUT<span class="token punctuation">.</span>smearing_sigma<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="picture/fig_path7-flow2.png" alt=""></p>
<p>&#x800C; <code>Occupy::gauss()</code> &#x7684;&#x529F;&#x80FD;&#x4EC5;&#x4EC5;&#x4E3A;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">class</span> <span class="token class-name">Occupy</span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">bool</span><span class="token operator">&amp;</span> <span class="token function">gauss</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> use_gaussian_broadening<span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre>
<p>&#x5269;&#x4F59;&#x90E8;&#x5206;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">ElecState</span><span class="token double-colon punctuation">::</span><span class="token function">cal_nbands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">&lt;</span> occupied_bands<span class="token punctuation">)</span>
            <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;unitcell&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Too few bands!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">OUT</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>ofs_running<span class="token punctuation">,</span> <span class="token string">&quot;nelec_up&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;ElecState::cal_nbands&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Too few spin up bands!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NBANDS <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">OUT</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>ofs_running<span class="token punctuation">,</span> <span class="token string">&quot;nelec_down&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nelec_spin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;ElecState::cal_nbands&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Too few spin down bands!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="others"><a name="others" class="plugin-anchor" href="#others"><i class="fa fa-link" aria-hidden="true"></i></a>Others</h3>
<pre class="language-"><code class="lang-cpp">    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>charge<span class="token operator">-&gt;</span><span class="token function">allocate</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>omega <span class="token operator">=</span> GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>omega<span class="token punctuation">;</span>
</code></pre>
<p>&#x7B2C;&#x4E8C;&#x884C;&#x5C06;&#x5F53;&#x524D;&#x6676;&#x80DE;&#x4F53;&#x79EF;&#x8D4B;&#x503C;&#x7ED9; <code>ElecState</code> &#x6307;&#x9488;&#x4E2D;&#x8BE5;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x7B2C;&#x4E00;&#x884C;&#x5219;&#x4E3A; <code>Charge* ElecState::charge</code> &#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">Charge</span><span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> nspin_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">TITLE</span><span class="token punctuation">(</span><span class="token string">&quot;Charge&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;allocate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nrxx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhopw<span class="token operator">-&gt;</span>nrxx<span class="token punctuation">;</span> <span class="token comment">// number of distributed real space grid points</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nxyz <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhopw<span class="token operator">-&gt;</span>nxyz<span class="token punctuation">;</span> <span class="token comment">// total number of real space grid points</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>ngmc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhopw<span class="token operator">-&gt;</span>npw<span class="token punctuation">;</span> <span class="token comment">// number of distributed planewaves</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>allocate_rho <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocate_rho <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>allocate_rho <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nspin <span class="token operator">=</span> nspin_in<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// standard output omitted here</span>

    rho <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token operator">*</span><span class="token punctuation">[</span>nspin<span class="token punctuation">]</span><span class="token punctuation">;</span>
    rhog <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">[</span>nspin<span class="token punctuation">]</span><span class="token punctuation">;</span>
    rho_save <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token operator">*</span><span class="token punctuation">[</span>nspin<span class="token punctuation">]</span><span class="token punctuation">;</span>
    rhog_save <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">[</span>nspin<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        kin_r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token operator">*</span><span class="token punctuation">[</span>nspin<span class="token punctuation">]</span><span class="token punctuation">;</span> kin_r_save <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token operator">*</span><span class="token punctuation">[</span>nspin<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//spin-by-spin (sbs)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> is <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> is <span class="token operator">&lt;</span> nspin<span class="token punctuation">;</span> is<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        rho<span class="token punctuation">[</span>is<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>nrxx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// charge density on distributed realspace grid sbs</span>
        rhog<span class="token punctuation">[</span>is<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>ngmc<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// charge density in reciprocal space sbs</span>
        rho_save<span class="token punctuation">[</span>is<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>nrxx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// backup of rho</span>
        rhog_save<span class="token punctuation">[</span>is<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>ngmc<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// backup of rhog</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// initialize above four arrays of present spin with zeros</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            kin_r<span class="token punctuation">[</span>is<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>nrxx<span class="token punctuation">]</span><span class="token punctuation">;</span> kin_r_save<span class="token punctuation">[</span>is<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>nrxx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// initialize above two arrays of present spin with zeros</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// memory record omitted</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>rho_core <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>nrxx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// core charge in real space</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhog_core <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>ngmc<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// reciprocal core charge</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// initialize above two arrays of present spin with zeros</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// memory record omitted</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>allocate_rho <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="initialization-of-potential"><a name="initialization-of-potential" class="plugin-anchor" href="#initialization-of-potential"><i class="fa fa-link" aria-hidden="true"></i></a>Initialization of Potential</h2>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Input<span class="token operator">&amp;</span> inp<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> ucell<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Initialize the potential.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>pot <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>pot <span class="token operator">=</span> <span class="token keyword">new</span> elecstate<span class="token double-colon punctuation">::</span><span class="token function">Potential</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_rho<span class="token punctuation">,</span>
                                                    <span class="token operator">&amp;</span>GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">,</span>
                                                    <span class="token operator">&amp;</span><span class="token punctuation">(</span>GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span>vloc<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>sf<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>etxc<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>vtxc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5C06;&#x5404;&#x4E0E;&#x52BF;&#x80FD;&#x76F8;&#x5173;&#x53D8;&#x91CF;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#x62C9;&#x53D6;&#x5230; <code>ElecStatePW* ESolver_KS_PW::pelec</code> &#x7684;&#x6307;&#x9488;&#x6210;&#x5458; <code>Potential* pot</code> &#x4E0B;&#xFF08;&#x7EE7;&#x627F;&#x81EA;&#x57FA;&#x7C7B; <code>ElecState</code>&#xFF09;&#xFF0C;<code>Potential</code> &#x7C7B;&#x6784;&#x9020;&#x51FD;&#x6570;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x521D;&#x59CB;&#x5316; <code>pot</code> &#x6307;&#x9488;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">namespace</span> elecstate
<span class="token punctuation">{</span>
    <span class="token class-name">Potential</span><span class="token double-colon punctuation">::</span><span class="token function">Potential</span><span class="token punctuation">(</span><span class="token keyword">const</span> ModulePW<span class="token double-colon punctuation">::</span>PW_Basis<span class="token operator">*</span> rho_basis_in<span class="token punctuation">,</span> <span class="token keyword">const</span> UnitCell<span class="token operator">*</span> ucell_in<span class="token punctuation">,</span> <span class="token keyword">const</span> ModuleBase<span class="token double-colon punctuation">::</span>matrix<span class="token operator">*</span> vloc_in<span class="token punctuation">,</span> Structure_Factor<span class="token operator">*</span> structure_factors_in<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">*</span> etxc_in<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">*</span> vtxc_in<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">ucell_</span><span class="token punctuation">(</span>ucell_in<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vloc_</span><span class="token punctuation">(</span>vloc_in<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">structure_factors_</span><span class="token punctuation">(</span>structure_factors_in<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">etxc_</span><span class="token punctuation">(</span>etxc_in<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vtxc_</span><span class="token punctuation">(</span>vtxc_in<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>rho_basis_ <span class="token operator">=</span> rho_basis_in<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>fixed_mode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>dynamic_mode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// allocate memory for Potential.</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x5728; <code>Potential</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x5F62;&#x53C2;&#x8868;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E86;&#x4ECE;&#x672A;&#x51FA;&#x73B0;&#x8FC7;&#x7684; <code>ModuleBase::matrix* GlobalC::ppcell</code> &#x53D8;&#x91CF;&#xFF0C;&#x4EE5;&#x53CA; <code>fenergy ElecState::f_en</code> &#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x4E9B;&#x53D8;&#x91CF;&#x4EE5;&#x5185;&#x5B58;&#x5730;&#x5740;&#x5F62;&#x5F0F;&#x5B58;&#x5165; <code>ElecStatePW* ESolver_KS_PW::pelec</code> &#x4E2D;&#x3002;&#x5BF9;&#x4E8E; <code>Potential::allocate()</code> &#x51FD;&#x6570;&#xFF0C;&#x5219;&#x4E0D;&#x51FA;&#x4F8B;&#x5916;&#x5730;&#x4E3A;&#x6570;&#x7EC4;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">Potential</span><span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">TITLE</span><span class="token punctuation">(</span><span class="token string">&quot;Potential&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;allocate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nrxx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>rho_basis_<span class="token operator">-&gt;</span>nrxx<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrxx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span>v_effective_fixed<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>nrxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>v_effective<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token punctuation">,</span> nrxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// memory record omitted</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>vofk_effective<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token punctuation">,</span> nrxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// memory record omitted</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>device_flag <span class="token operator">==</span> <span class="token string">&quot;gpu&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>precision_flag <span class="token operator">==</span> <span class="token string">&quot;single&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>d_v_effective <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>v_effective<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>d_vofk_effective <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>vofk_effective<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// There&apos;s no need to allocate memory for double precision pointers while in a CPU environment</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token comment">// module_elecstate/potentials/potential_new.h </span>
<span class="token keyword">class</span> <span class="token class-name">Potential</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">PotBase</span></span>
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//google-style indent?</span>
  <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> v_effective_fixed<span class="token punctuation">;</span> <span class="token comment">//&lt;-line 154</span>
    ModuleBase<span class="token double-colon punctuation">::</span>matrix v_effective<span class="token punctuation">;</span> <span class="token comment">// mixed use of std::vector and self-built matrix?</span>
</code></pre>
<p><code>Potential</code> &#x548C;&#x5176;&#x57FA;&#x7C7B; <code>PotBase</code> &#x62E5;&#x6709;&#x6F02;&#x4EAE;&#x7684;&#x7C7B;&#x6CE8;&#x91CA;&#x6587;&#x6863;&#xFF08;<a href="https://github.com/abacusmodeling/abacus-develop/blob/develop/source/module_elecstate/potentials/potential_new.h" target="_blank">link</a>&#xFF09;&#xFF1A;</p>
<p><img src="picture/fig_path7-3.png" alt=""></p>
<h2 id="initialization-of-rest-parts-of-globalc"><a name="initialization-of-rest-parts-of-globalc" class="plugin-anchor" href="#initialization-of-rest-parts-of-globalc"><i class="fa fa-link" aria-hidden="true"></i></a>Initialization of rest parts of GlobalC</h2>
<p><code>GlobalC</code> &#x548C; <code>GlobalV</code> &#x662F;&#x4E24;&#x4E2A;&#x7279;&#x6B8A;&#x7684;&#x7C7B;&#xFF0C;&#x5982;&#x7B2C;&#x4E00;&#x7248;&#x5F00;&#x53D1;&#x8005;&#x6587;&#x6863;&#x6240;&#x63D0;&#x5230;&#xFF0C;&#x6B64;&#x4E24;&#x79CD;&#x7C7B;&#x7684;&#x6536;&#x76CA;&#x4E3A;&#x907F;&#x514D;&#x8FC7;&#x5927;&#x7684;&#x5F62;&#x53C2;&#x8868;&#xFF0C;&#x4F46;&#x8D1F;&#x5411;&#x6536;&#x76CA;&#x4E3A;&#x5E26;&#x6765;&#x5BF9;&#x4E24;&#x7C7B;&#x4E2D;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x610F;&#x5916;&#x8986;&#x76D6;&#x8BFB;&#x5199;&#x7684;&#x9690;&#x60A3;&#xFF0C;&#x56E0;&#x6B64;&#x5728; ABACUS &#x7684;&#x672A;&#x6765;&#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x4F1A;&#x9010;&#x6B65;&#x5F03;&#x7528; <code>GlobalC</code> &#x548C; <code>GlobalV</code>&#xFF0C;&#x8F6C;&#x800C;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#xFF1A;&#x5229;&#x7528;&#x9AD8;&#x5EA6;&#x4E14;&#x5408;&#x7406;&#x7684;&#x5C01;&#x88C5;&#x65B9;&#x5F0F;&#xFF0C;&#x6BCF;&#x6B21;&#x4F20;&#x5165;&#x5BF9;&#x8C61;&#xFF0C;&#x5BF9;&#x8C61;&#x5305;&#x542B;&#x5404;&#x81EA;&#x76F8;&#x5173;&#x7684;&#x6570;&#x636E;&#x6210;&#x5458;&#x548C;&#x51FD;&#x6570;&#x3002;&#x4F46;&#x5C31;&#x5F53;&#x524D;&#x800C;&#x8A00;&#xFF0C;<code>GlobalC</code> &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x5168;&#x5C40;&#x7C7B;&#x3002;&#x6B64;&#x5904;&#x5269;&#x4F59;&#x7684;&#x4E00;&#x4E9B;&#x5168;&#x5C40;&#x7C7B;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3001;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Init_GlobalC</span><span class="token punctuation">(</span>Input<span class="token operator">&amp;</span> inp<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> cell<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wf<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>kv<span class="token punctuation">.</span>nks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>kv<span class="token punctuation">.</span>ngk<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token operator">-&gt;</span>npwk_max<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// init pseudopotential</span>
    GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>ntype<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>sf<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// initalize local pseudopotential</span>
    GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span><span class="token function">init_vloc</span><span class="token punctuation">(</span>GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span>vloc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_rho<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initalize non local pseudopotential</span>
    GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span><span class="token function">init_vnl</span><span class="token punctuation">(</span>GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span><span class="token function">cal_effective_D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// create GlobalC::ppcell.tab_at , for trial wave functions.</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>wf<span class="token punctuation">.</span><span class="token function">init_at_1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>sf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initial start wave functions</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>wf<span class="token punctuation">.</span><span class="token function">wfcinit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pw_wfc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// denghui added 20221116</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>kspw_psi <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>device_flag <span class="token operator">==</span> <span class="token string">&quot;gpu&quot;</span> <span class="token operator">||</span> GlobalV<span class="token double-colon punctuation">::</span>precision_flag <span class="token operator">==</span> <span class="token string">&quot;single&quot;</span>
                         <span class="token operator">?</span> <span class="token keyword">new</span> psi<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">Psi</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                         <span class="token operator">:</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//memory record omitted here</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>&#x1F4DD;<strong>&#x7B14;&#x8005;&#x7684;&#x8BDD;</strong>
&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x6709;&#x8DA3;&#x7684;&#x4E1C;&#x897F;&#x662F; <code>kspw_psi</code>&#xFF08;&#x5728;&#x6C42;&#x529B;&#x90E8;&#x5206;&#x8FD8;&#x6709; <code>__kspw_psi</code>&#xFF09;&#x3002;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x8BFB;&#x8005;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x67E5;&#x770B;&#x5BF9;&#x4E8E; gpu &#x6216;&#x8005;&#x5355;&#x7CBE;&#x5EA6;&#x60C5;&#x51B5;&#xFF0C;&#x5728;&#x8C03;&#x7528;&#x7684; <code>psi</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#x3002;
&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;<code>kspw_psi</code> &#x652F;&#x6301;&#x4E86;&#x5F02;&#x6784;&#x8BA1;&#x7B97;&#xFF0C;&#x800C; <code>psi</code>&#xFF0C;&#x5982; esolver_fp.h &#x58F0;&#x660E;&#x4E2D;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x53EA;&#x4E3A; <code>psi::Psi&lt;std::complex<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>double</span><span class="token punctuation">&gt;</span></span>, Device = psi::DEVICE_CPU&gt;*</code> &#x7C7B;&#x6307;&#x9488;&#x3002;&#x56E0;&#x6B64;&#x771F;&#x6B63;&#x8BA1;&#x7B97;&#x67B6;&#x6784;-dependent &#x7684;&#x662F; <code>kspw_psi</code>&#x3002;<code>ESolver_KS_PW</code> &#x4E3A;&#x652F;&#x6301;&#x5F02;&#x6784;&#x8BA1;&#x7B97;&#xFF0C;&#x6574;&#x4E2A;&#x7C7B;&#x4E3A;&#x6A21;&#x677F;&#x7C7B;&#x3002;&#x5728; psi &#x88AB;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x540E;&#xFF0C;&#x4E3A; <code>kspw_psi</code> &#x8D4B;&#x4E88;&#x4E86;&#x5176;&#x6570;&#x636E;&#x7684;&#x53EF;&#x8FBE;&#x6027;&#xFF08;accessibility&#xFF09;&#xFF0C;<code>reinterpret_cast</code> &#x6216;&#x8005;&#x590D;&#x5236;&#x5185;&#x5BB9;&#x3002;</p>
</blockquote>
<h3 id="psi"><a name="psi" class="plugin-anchor" href="#psi"><i class="fa fa-link" aria-hidden="true"></i></a>Psi</h3>
<p><code>Psi</code> &#x662F; ABACUS &#x4E2D;&#x4E00;&#x7C7B;&#x7279;&#x6B8A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6CE2;&#x51FD;&#x6570;&#xFF08;&#x5E73;&#x9762;&#x6CE2;&#x57FA;&#x51FD;&#x6570;&#x7CFB;&#x6570;&#xFF09;&#x4FE1;&#x606F;&#x3002;&#x5176;&#x5305;&#x542B;&#x5982;&#x4E0B;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">namespace</span> psi
<span class="token punctuation">{</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span> <span class="token operator">=</span> DEVICE_CPU<span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Psi</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> npol <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">private</span><span class="token operator">:</span>
    T<span class="token operator">*</span> psi <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span> <span class="token comment">// avoid using C++ STL</span>

    AbacusDevice_t device <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// track the device type (CPU, GPU and SYCL are supported currented)</span>
    Device<span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// an context identifier for obtaining the device variable</span>

    <span class="token comment">// dimensions</span>
    <span class="token keyword">int</span> nk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// number of k points</span>
    <span class="token keyword">int</span> nbands <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// number of bands</span>
    <span class="token keyword">int</span> nbasis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// number of basis</span>

    <span class="token keyword">mutable</span> <span class="token keyword">int</span> current_k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// current k point</span>
    <span class="token keyword">mutable</span> <span class="token keyword">int</span> current_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// current band index</span>
    <span class="token keyword">mutable</span> <span class="token keyword">int</span> current_nbasis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// current number of basis of current_k</span>

    <span class="token comment">// current pointer for getting the psi</span>
    <span class="token keyword">mutable</span> T<span class="token operator">*</span> psi_current <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token comment">// psi_current = psi + psi_bias;</span>
    <span class="token keyword">mutable</span> <span class="token keyword">int</span> psi_bias <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> ngk <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> k_first <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="codes"><a name="codes" class="plugin-anchor" href="#codes"><i class="fa fa-link" aria-hidden="true"></i></a>Codes</h4>
<p>&#x6211;&#x4EEC;&#x9996;&#x5148;&#x9605;&#x8BFB;&#x4E3A; <code>Psi</code> &#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x4EE3;&#x7801;</p>
<pre class="language-"><code class="lang-cpp">psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> <span class="token operator">*</span>wavefunc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> nks<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>ngk<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> npwx_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* parameter list:
    nks: number of kpoints distributed on present processor
    ngk: number of planewaves on kpoints respectively on present processor
    npwx_in: maximal number of planewaves across all kpoints distributed on present processor
    */</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>npwx <span class="token operator">=</span> npwx_in<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>npwx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>nks <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// if use spin orbital, do not double nks but double allocate evc and wanf2.</span>
    <span class="token keyword">int</span> prefactor <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span> prefactor <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>NPOL<span class="token punctuation">;</span><span class="token comment">//added by zhengdy-soc</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> nks2 <span class="token operator">=</span> nks<span class="token punctuation">;</span>

    psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token operator">*</span> psi_out <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// non-pw cases are omitted</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        psi_out <span class="token operator">=</span> <span class="token keyword">new</span> psi<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">Psi</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>nks2<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">,</span> npwx <span class="token operator">*</span> GlobalV<span class="token double-colon punctuation">::</span>NPOL<span class="token punctuation">,</span> ngk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// standard output and memory record omitted</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> psi_out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5373; <code>wavefunc::allocate()</code> &#x51FD;&#x6570;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#x4E3A;&#x4E3A;&#x4E0D;&#x540C;&#x57FA;&#x7EC4;&#x7C7B;&#x578B;&#x6309;&#x7167;&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x4ECD;&#x7136;&#x9700;&#x8981;&#x8C03;&#x7528; <code>psi</code> &#x81EA;&#x5DF1;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3002;<code>psi</code> &#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x91CD;&#x8F7D;&#x5171;&#x6709; 6 &#x4E2A;&#xFF08;&#x4EE5;&#x53CA; 1 &#x4E2A;&#x9ED8;&#x8BA4;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF09;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span> <span class="token operator">=</span> DEVICE_CPU<span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Psi</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// Constructor 1: basic</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Constructor 2: specify ngk only, should call resize() later</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> ngk_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;strong&gt;Constructor 3&lt;/strong&gt;: specify nk, nbands, nbasis, ngk, and do not need to call resize() later</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">int</span> nk_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nbd_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nbs_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> ngk_in <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Constructor 4: copy a new Psi which have several k-points and several bands from inputted psi_in</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">const</span> Psi<span class="token operator">&amp;</span> psi_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> nk_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nband_in <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Constructor 5: a wrapper of a data pointer, used for Operator::hPsi()</span>
    <span class="token comment">// in this case, fix_k can not be used</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span>T<span class="token operator">*</span> psi_pointer<span class="token punctuation">,</span> <span class="token keyword">const</span> Psi<span class="token operator">&amp;</span> psi_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> nk_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nband_in <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Constructor 6: initialize a new psi from the given psi_in</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">const</span> Psi<span class="token operator">&amp;</span> psi_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Constructor 7: initialize a new psi from the given psi_in with a different class template</span>
    <span class="token comment">// in this case, psi_in may have a different device type.</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T_in</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device_in</span> <span class="token operator">=</span> Device<span class="token operator">&gt;</span>
    <span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">const</span> Psi<span class="token operator">&lt;</span>T_in<span class="token punctuation">,</span> Device_in<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x6B64;&#x5904;&#x6211;&#x4EEC;&#x8C03;&#x7528;&#x7684;&#x662F;&quot;<strong>Constructor 3</strong>&quot;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span> <span class="token class-name">Psi</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">int</span> nk_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nbd_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nbs_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> ngk_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>ngk <span class="token operator">=</span> ngk_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>npol <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>NPOL<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>device <span class="token operator">=</span> device<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get_device_type</span><span class="token generic class-name"><span class="token operator">&lt;</span>Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">resize</span><span class="token punctuation">(</span>nk_in<span class="token punctuation">,</span> nbd_in<span class="token punctuation">,</span> nbs_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Currently only GPU&apos;s implementation is supported for device recording!</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//device recording omitted</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">Psi</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> nks_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> nbands_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> nbasis_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>nks_in <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nbands_in <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nbasis_in <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// This function will delete the psi array first(if psi exist), then malloc a new memory for it.</span>
    <span class="token function">resize_memory_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">,</span> nks_in <span class="token operator">*</span> nbands_in <span class="token operator">*</span> nbasis_in<span class="token punctuation">,</span> <span class="token string">&quot;no_record&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nk <span class="token operator">=</span> nks_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbands <span class="token operator">=</span> nbands_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbasis <span class="token operator">=</span> nbasis_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_nbasis <span class="token operator">=</span> nbasis_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi_current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">;</span>
    <span class="token comment">// GlobalV::ofs_device &lt;&lt; &quot;allocated xxx MB memory for psi&quot; &lt;&lt; std::endl;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//psi.h line 130</span>
    <span class="token keyword">using</span> resize_memory_op <span class="token operator">=</span> psi<span class="token double-colon punctuation">::</span>memory<span class="token double-colon punctuation">::</span>resize_memory_op<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//module_psi/kernels/memory_op.h</span>
<span class="token keyword">namespace</span> psi <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> memory <span class="token punctuation">{</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span> 
<span class="token keyword">struct</span> <span class="token class-name">resize_memory_op</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> Device<span class="token operator">*</span> dev<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> record_in <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//module_psi/kernels/memory_op.cpp</span>
<span class="token keyword">namespace</span> psi<span class="token punctuation">{</span>
<span class="token keyword">namespace</span> memory<span class="token punctuation">{</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token operator">&gt;</span> 
<span class="token keyword">struct</span> <span class="token class-name">resize_memory_op</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">*</span> dev<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> record_in<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        arr <span class="token operator">=</span> <span class="token punctuation">(</span>FPTYPE<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>FPTYPE<span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>string record_string<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>record_in <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> record_string <span class="token operator">=</span> record_in<span class="token punctuation">;</span>
        <span class="token keyword">else</span> record_string <span class="token operator">=</span> <span class="token string">&quot;no_record&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>record_string <span class="token operator">!=</span> <span class="token string">&quot;no_record&quot;</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">Memory</span><span class="token double-colon punctuation">::</span><span class="token function">record</span><span class="token punctuation">(</span>record_string <span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FPTYPE<span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x56E0;&#x6B64; <code>Psi</code> &#x7C7B;&#x5BF9;&#x8C61;&#x6700;&#x7EC8;&#x4F7F;&#x7528; <code>resize_memory_op()</code> &#x6765;&#x4E3A; <code>Psi::psi</code> &#x6570;&#x636E;&#x6210;&#x5458;&#x8FDB;&#x884C;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6CE2;&#x51FD;&#x6570;&#x4FE1;&#x606F;/&#x5176;&#x540C;&#x6837;&#x662F; 3d-flatten&#xFF0C;&#x5373;&#x7533;&#x8BF7;&#x7684;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x4E00;&#x7EA7;&#x6307;&#x9488;&#xFF0C;&#x89C4;&#x6A21;&#x4E3A; <code>[ikpoint][iband][ibasis]</code>&#x3002;</p>
<h4 id="feature-struct-with-overloaded--extends-the-way-of-defining-functions"><a name="feature-struct-with-overloaded--extends-the-way-of-defining-functions" class="plugin-anchor" href="#feature-struct-with-overloaded--extends-the-way-of-defining-functions"><i class="fa fa-link" aria-hidden="true"></i></a>Feature: struct with overloaded &quot;()&quot;, extends the way of defining functions</h4>
<p><code>Psi</code> &#x7533;&#x8BF7;&#x5185;&#x5B58;&#x65F6;&#x4F7F;&#x7528;&#x4E86;&#x5728;&#x4E4B;&#x524D;&#x4ECB;&#x7ECD;&#x7684; ABACUS &#x4EE3;&#x7801;&#x4E2D;&#x4ECE;&#x672A;&#x51FA;&#x73B0;&#x8FC7;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5373;&#x521B;&#x5EFA;&#x6A21;&#x677F;&#x7C7B;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x4E4B;&#x540E;&#x5728;&#x5176;&#x4E2D;&#x91CD;&#x8F7D;&#x62EC;&#x53F7;&#x8FD0;&#x7B97;&#x7B26;&#xFF0C;&#x4EE5;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x7684;&#x65B9;&#x5F0F;&#x4F7F;&#x7528;&#x91CD;&#x8F7D;&#x7684;&#x62EC;&#x53F7;&#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x4E3A; C++ &#x7ED3;&#x6784;&#x4F53;&#x6240;&#x72EC;&#x6709;&#xFF0C;&#x662F;&#x56FA;&#x5B9A;&#x7279;&#x6027;&#xFF0C;&#x5BF9;&#x539F;&#x672C;&#x7684;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#x4E86;&#x66F4;&#x5927;&#x8303;&#x56F4;&#x7684;&#x62D3;&#x5C55;&#xFF0C;&#x7ED3;&#x5408; <code>using</code> &#x5173;&#x952E;&#x5B57;&#xFF0C;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x6A21;&#x677F;&#x7C7B;&#x5B9E;&#x4F8B;&#x5316;&#x3001;&#x5C01;&#x88C5;&#x3001;&#x591A;&#x6001;&#x7B49;&#x6548;&#x679C;&#x3002;</p>
<p>&#x5E76;&#x4E14;</p>
<pre class="language-"><code class="lang-cpp"><span class="token function">resize_memory_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">,</span> nks_in <span class="token operator">*</span> nbands_in <span class="token operator">*</span> nbasis_in<span class="token punctuation">,</span> <span class="token string">&quot;no_record&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x5B9E;&#x9645;&#x53EF;&#x4EE5;&#x5199;&#x4E3A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token function">resize_memory_op</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">,</span> nks_in <span class="token operator">*</span> nbands_in <span class="token operator">*</span> nbasis_in<span class="token punctuation">,</span> <span class="token string">&quot;no_record&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x548C;&#x539F;&#x672C;&#x7684;&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x66F4;&#x52A0;&#x76F8;&#x4F3C;&#x3002;&#x7C7B;&#x4F3C;&#x7684;&#x4F8B;&#x5B50;&#x8FD8;&#x6709;&#x5173;&#x4E8E; Psi &#x7C7B;&#x5BF9;&#x8C61;&#x5176;&#x4ED6;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x64CD;&#x4F5C;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">namespace</span> psi
<span class="token punctuation">{</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span> <span class="token operator">=</span> DEVICE_CPU<span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Psi</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">using</span> set_memory_op <span class="token operator">=</span> psi<span class="token double-colon punctuation">::</span>memory<span class="token double-colon punctuation">::</span>set_memory_op<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> delete_memory_op <span class="token operator">=</span> psi<span class="token double-colon punctuation">::</span>memory<span class="token double-colon punctuation">::</span>delete_memory_op<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> resize_memory_op <span class="token operator">=</span> psi<span class="token double-colon punctuation">::</span>memory<span class="token double-colon punctuation">::</span>resize_memory_op<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> synchronize_memory_op <span class="token operator">=</span> psi<span class="token double-colon punctuation">::</span>memory<span class="token double-colon punctuation">::</span>synchronize_memory_op<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// end of namespace psi</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">delete_memory_op</span> <span class="token punctuation">{</span>
  <span class="token comment">/// @brief free memory for multi-device</span>
  <span class="token comment">/// \param dev : the type of computing device</span>
  <span class="token comment">/// \param arr : the input array</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> Device<span class="token operator">*</span> dev<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">delete_memory_op</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">*</span> dev<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span> 
<span class="token keyword">struct</span> <span class="token class-name">set_memory_op</span> <span class="token punctuation">{</span>
  <span class="token comment">/// @brief memset for multi-device</span>
  <span class="token comment">/// \param dev : the type of computing device</span>
  <span class="token comment">/// \param var : the specified constant value</span>
  <span class="token comment">/// \param size : array size</span>
  <span class="token comment">/// Output Parameters</span>
  <span class="token comment">/// \param arr : output array initialized by the input value</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> Device<span class="token operator">*</span> dev<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span> arr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> var<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token operator">&gt;</span> 
<span class="token keyword">struct</span> <span class="token class-name">set_memory_op</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">*</span> dev<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span> arr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> var<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">OMP_PARALLEL</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> num_thread<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> beg<span class="token punctuation">,</span> len<span class="token punctuation">;</span>
      <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">BLOCK_TASK_DIST_1D</span><span class="token punctuation">(</span>num_thread<span class="token punctuation">,</span> thread_id<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token number">4096</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>FPTYPE<span class="token punctuation">)</span><span class="token punctuation">,</span> beg<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span>arr <span class="token operator">+</span> beg<span class="token punctuation">,</span> var<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FPTYPE<span class="token punctuation">)</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device_out</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device_in</span><span class="token operator">&gt;</span> 
<span class="token keyword">struct</span> <span class="token class-name">synchronize_memory_op</span> <span class="token punctuation">{</span>
  <span class="token comment">/// @brief memcpy for multi-device</span>
  <span class="token comment">/// \param dev_out : the type of computing device of arr_out</span>
  <span class="token comment">/// \param dev_in : the type of computing device of arr_in</span>
  <span class="token comment">/// \param arr_in : input array</span>
  <span class="token comment">/// \param size : array size</span>
  <span class="token comment">/// Output Parameters</span>
  <span class="token comment">/// \param arr_out : output array initialized by the input array</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> Device_out<span class="token operator">*</span> dev_out<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> Device_in<span class="token operator">*</span> dev_in<span class="token punctuation">,</span> 
      FPTYPE<span class="token operator">*</span> arr_out<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> FPTYPE<span class="token operator">*</span> arr_in<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token operator">&gt;</span> 
<span class="token keyword">struct</span> <span class="token class-name">synchronize_memory_op</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
                  <span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">*</span> dev_out<span class="token punctuation">,</span> 
                  <span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>DEVICE_CPU<span class="token operator">*</span> dev_in<span class="token punctuation">,</span> 
                  FPTYPE<span class="token operator">*</span> arr_out<span class="token punctuation">,</span> 
                  <span class="token keyword">const</span> FPTYPE<span class="token operator">*</span> arr_in<span class="token punctuation">,</span> 
                  <span class="token keyword">const</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">OMP_PARALLEL</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> num_thread<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> beg<span class="token punctuation">,</span> len<span class="token punctuation">;</span>
      <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">BLOCK_TASK_DIST_1D</span><span class="token punctuation">(</span>num_thread<span class="token punctuation">,</span> thread_id<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token number">4096</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>FPTYPE<span class="token punctuation">)</span><span class="token punctuation">,</span> beg<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>arr_out <span class="token operator">+</span> beg<span class="token punctuation">,</span> arr_in <span class="token operator">+</span> beg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FPTYPE<span class="token punctuation">)</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#x4E86;&#x6A21;&#x677F;&#x51FD;&#x6570;&#x7684;&#x504F;&#x7279;&#x5316;&#xFF08;partial specialization&#xFF09;&#x9700;&#x6C42;&#xFF08;<a href="https://en.cppreference.com/w/cpp/language/partial_specialization" target="_blank">see cppreference</a>&#xFF09;&#xFF0C;&#x5373;&#x9996;&#x5148;&#x5B9E;&#x4F8B;&#x5316;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x6A21;&#x677F;&#x53C2;&#x6570;&#xFF0C;&#x4E4B;&#x540E;&#x518D;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x5B9E;&#x4F8B;&#x5316;&#x53E6;&#x4E00;&#x4E2A;&#x3002;&#x5728;&#x66F4;&#x65B0;&#x7684; C++20 &#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x4F7F;&#x7528; concepts&#xFF08;requires, <a href="https://en.cppreference.com/w/cpp/20" target="_blank">see C++20</a>&#xFF09;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x7C7B;&#x4F3C;&#x6548;&#x679C;&#xFF08;<a href="https://www.cppstories.com/2021/concepts-intro/#what-is-a-concept" target="_blank">see cppstories</a>&#xFF09;&#x3002;</p>
<p>&#x5728; ESolver_KS_PW()::init()&#x7684;&#x6700;&#x540E;&#x8FD8;&#x6709;&#x5982;&#x4E0B;&#x8BED;&#x53E5;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">this</span><span class="token operator">-&gt;</span>kspw_psi <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>device_flag <span class="token operator">==</span> <span class="token string">&quot;gpu&quot;</span> <span class="token operator">||</span> GlobalV<span class="token double-colon punctuation">::</span>precision_flag <span class="token operator">==</span> <span class="token string">&quot;single&quot;</span>
                         <span class="token operator">?</span> <span class="token keyword">new</span> psi<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">Psi</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                         <span class="token operator">:</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&#x6211;&#x4EEC;&#x4E0D;&#x8003;&#x8651; GPU &#x548C;&#x5355;&#x7CBE;&#x5EA6;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x56E0;&#x6B64;&#x4EE5;&#x4E0A;&#x7B49;&#x4EF7;&#x4E8E;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">this</span><span class="token operator">-&gt;</span>kspw_psi <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="pseudopotcellvnl"><a name="pseudopotcellvnl" class="plugin-anchor" href="#pseudopotcellvnl"><i class="fa fa-link" aria-hidden="true"></i></a>pseudopot_cell_vnl</h3>
<h4 id="before-init"><a name="before-init" class="plugin-anchor" href="#before-init"><i class="fa fa-link" aria-hidden="true"></i></a>Before init()</h4>
<p>&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x6CA1;&#x6709;&#x7279;&#x522B;&#x5173;&#x6CE8;&#x8FC7;&#x8FD9;&#x4E2A;&#x88AB;&#x58F0;&#x660E;&#x5728; <code>GlobalC</code> &#x91CC;&#x7684;&#x5168;&#x5C40;&#x7C7B;&#xFF08;<a href="https://github.com/abacusmodeling/abacus-develop/blob/develop/source/module_hamilt_pw/hamilt_pwdft/global.h#L284" target="_blank">line 278</a>&#xFF09;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x975E;&#x5E38;&#x7C97;&#x7565;&#x56DE;&#x987E;&#x5176;&#x987E;&#x540D;&#x601D;&#x4E49;&#x7684;&#x975E;&#x5C40;&#x57DF;&#x9879;&#x7684;&#x539F;&#x7406;&#xFF0C;&#x4E4B;&#x540E;&#x5728;&#x4E0B;&#x4E00;&#x7BC7;&#x4E2D;&#x5BF9;&#x8BE5;&#x7C7B;&#x6210;&#x5458;&#x51FD;&#x6570;&#x7684;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x8FDB;&#x884C;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#xFF08;&#x4F46;&#x4ECD;&#x7136;&#x4E0D;&#x4F1A;&#x9010;&#x884C;&#x9010;&#x53E5;&#x8FDB;&#x884C;&#x201C;&#x7FFB;&#x8BD1;&#x201D;&#xFF09;&#x3002;&#x8BE5;&#x7C7B;&#x7684;&#x540D;&#x5B57; <code>pseudopot_cell_vnl</code> &#x5B9E;&#x9645;&#x4E0A;&#x662F; pseudopotential_cell_V(potential)_nonlocal &#x7684;&#x7F29;&#x5199;&#x3002;&#x9996;&#x5148;&#x7B80;&#x5355;&#x4ECB;&#x7ECD; Kleinman-Bylander &#x65B9;&#x6CD5;&#xFF08;<a href="https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.48.1425" target="_blank">Phys. Rev. Lett. </a><strong>48</strong><a href="https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.48.1425" target="_blank">, 1425&#xFF08;1982&#xFF09;</a>&#xFF09;&#x5C06; pseudopotential &#x5206;&#x4E3A;&#x5B8C;&#x5168;&#x975E;&#x5C40;&#x57DF;&#x548C;&#x5C40;&#x57DF;&#x90E8;&#x5206;&#xFF1A;</p>
<blockquote>
<p><script type="math/tex; ">\hat{V}^{\mathrm{KB}}=\sum_{l=0}^{l_{max}}{\sum_{m=-l}^{+l}{\sum_{i=1}{|\chi _{lm,i}\rangle V_{li}^{KB}\langle \chi _{lm,i}|}}}</script>.
Therefore the fully nonlocal part of pp. has projectors of different angular momentum, magnetic quantum number and basis functions. That is to say, this projector will project one state onto some basic states at such kind of resolution.
The basis of projector, is constructed in this way:</p>
<p><script type="math/tex; mode=display">
> \chi _{lm,i}\left( \mathbf{r} \right) =\langle \mathbf{r}|\chi _{lm,i}\rangle =R_{l,i}\left( r \right) Y_{lm}\left( \hat{\mathbf{r}} \right) 
> </script></p>
<p>It is, similar with a hydrogen wavefunction that has radial part and angular part. The angular part, is represented by spherical harmonic function, and basis function, is only used for constructing radial part of the basis of projector <script type="math/tex; ">\hat{V}^{KB}</script>.
However, what is <script type="math/tex; ">V^{KB}_{li}</script> ? How is it calculated?
<script type="math/tex; ">V_{li}^{KB}=\langle \varphi _{li}|\delta V_l|\varphi _{li}\rangle </script>, where <script type="math/tex; ">\delta V_l=V_l(r)-V^{local}(r)</script>, from semilocal pp. <script type="math/tex; ">V_l(r)</script> (the one may directly read from portable pp. files like *.UPF), subtract the local part from it, leaving term <script type="math/tex; ">\delta V_l(r)</script>, is angular momentum-resoluted, while the local part is not.
Imagine <script type="math/tex; ">\delta V_l(r)</script> itself has its eigenspace and for each axis there is an eigenvalue. Any state can be expanded by eigenvectors <script type="math/tex; ">\{|v_{li}\rangle\}</script> of <script type="math/tex; ">\delta V_l(r)</script>-space. Thus,
<script type="math/tex; ">|\varphi _{li}\rangle =\sum_k{c_{ik}|v_{lk}\rangle}</script>,</p>
<p><script type="math/tex; mode=display">
> \langle \varphi _{li}|\delta V_l|\varphi _{li}\rangle =\langle \varphi _{li}|\sum_j{|v_{lj}\rangle v_{lj}\langle v_{lj}|}\varphi _{li}\rangle
> </script></p>
</blockquote>
<p>\
=\sum<em>{k^{\prime}}{c</em>{ik^{\prime}}^{\dagger}\langle v<em>{lk^{\prime}}}|\sum_j{|v</em>{lj}\rangle v<em>{lj}\langle v</em>{lj}|}\sum<em>k{c</em>{ik}|v<em>{lk}\rangle}
\
=\sum</em>{k^{\prime}}{\sum<em>k{\sum_j{c</em>{ik^{\prime}}^{\dagger}c<em>{ik}\langle v</em>{lk^{\prime}}|v<em>{lj}\rangle v</em>{lj}\langle v<em>{lj}|v</em>{lk}\rangle}}}
\
=\sum<em>{k^{\prime}}{\sum_k{\sum_j{c</em>{ik^{\prime}}^{\dagger}c<em>{ik}\delta </em>{k^{\prime}j}\delta <em>{kj}v</em>{lj}}}}
\
=\sum<em>j{c</em>{ij}^{\dagger}c<em>{ij}v</em>{lj}}=\sum<em>j{c</em>{ij}^{2}v<em>{lj}}
\
=v</em>{l1}\left( c<em>{i1}^{2} \right) +v</em>{l2}\left( c<em>{i2}^{2} \right) +...<script type="math/tex; mode=display">

> The result above is, norm of vector/state </script>|\varphi</em>{li}\rangle<script type="math/tex; "> in eigen-space of operator </script>\delta V<em>l<script type="math/tex; ">.
> It is the same for any other kinds of scalar product, thus Schmidt orthogonalization in any arbitrary space has a more general form. For example, states </script>{\varphi</em>{li}}<script type="math/tex; "> is </script>\delta V_l<script type="math/tex; ">-space-orthogonalized version of eigenstates of </script>V_l(r)<script type="math/tex; ">, the semilocal pp employing KS eq.:
>
> </script></p>
<blockquote>
<p>|\varphi <em>{li}\rangle =|\psi </em>{li}\rangle -\sum<em>{i^{\prime}=1}^{i-1}{|\varphi </em>{li^{\prime}}\rangle \frac{\langle \varphi <em>{li^{\prime}}|\delta V_l|\psi </em>{li^{\prime}}\rangle}{\langle \varphi <em>{li^{\prime}}|\delta V_l|\varphi </em>{li^{\prime}}\rangle}}
<script type="math/tex; mode=display">
>
> The term </script>V^{local}<script type="math/tex; "> is however, somewhat arbitrary, a sphericallly symmetrical charge distribution is directly given in this paper as:
>
> </script>
\rho^{local}(r)=A\exp[-(\frac{\sinh(abr)}{\sinh(br)})^2]
<script type="math/tex; mode=display">
>
> Parameters </script>a<script type="math/tex; ">and </script>b<script type="math/tex; "> are arbitrary. In paper </script>a<script type="math/tex; ">is optimized to 1.82/</script>r_{core}$$, b is 1.</p>
</blockquote>
<p>&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x81EA; ABACUS &#x5F00;&#x59CB;&#x8FD0;&#x884C;&#x65F6;&#x4FBF;&#x8C03;&#x7528;&#x5176;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684; <code>pseudopot_cell_vnl</code>&#xFF0C;&#x6709;&#x5982;&#x4E0B;&#x6570;&#x636E;&#x6210;&#x5458;&#x5177;&#x6709;&#x521D;&#x59CB;&#x503C;&#xFF1A;</p>
<table>
<thead>
<tr>
<th>&#x53D8;&#x91CF;</th>
<th>&#x9ED8;&#x8BA4;&#x503C;</th>
<th>&#x610F;&#x4E49;</th>
<th>&#x5907;&#x6CE8;</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>multi_proj</code></td>
<td><code>false</code></td>
<td>&#x662F;&#x5426;&#x4F7F;&#x7528;&#x591A;&#x4E2A;&#x6295;&#x5F71;&#x5B50;&#xFF08;projector&#xFF09;</td>
<td></td>
</tr>
<tr>
<td><code>s_deeq</code>, <code>d_deeq</code>, <code>c_deeq_nc</code>, <code>z_deeq_nc</code></td>
<td><code>nullptr</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>s_nhtol</code>, <code>s_nhtolm</code>, <code>s_indv</code>, <code>s_tab</code></td>
<td><code>nullptr</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>c_vkb</code></td>
<td><code>nullptr</code></td>
<td>Kleinman-Bylander &#x5B8C;&#x5168;&#x975E;&#x5C40;&#x57DF;&#x8D5D;&#x52BF;</td>
<td></td>
</tr>
<tr>
<td><code>d_nhtol</code>, <code>d_nhtolm</code>, <code>d_indv</code>, <code>d_tab</code></td>
<td><code>nullptr</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>z_vkb</code></td>
<td><code>nullptr</code></td>
<td>Kleinman-Bylander &#x5B8C;&#x5168;&#x975E;&#x5C40;&#x57DF;&#x8D5D;&#x52BF;</td>
<td></td>
</tr>
<tr>
<td><code>wfcpw</code></td>
<td><code>nullptr</code></td>
<td>&#x5E73;&#x9762;&#x6CE2;&#x57FA;&#x6CE2;&#x51FD;&#x6570;&#x7684;&#x6307;&#x9488;</td>
<td><code>Init()</code> &#x88AB;&#x8D4B;&#x503C;&#x4E3A; <code>PW_Basis_K* ESolver_KS_PW::pw_wfc</code></td>
</tr>
<tr>
<td><code>psf</code></td>
<td><code>nullptr</code></td>
<td>&#x7ED3;&#x6784;&#x56E0;&#x5B50;&#x6307;&#x9488;</td>
<td><code>Init()</code> &#x88AB;&#x8D4B;&#x503C;&#x4E3A; <code>Structure_Factor* ESolver_KS_PW::sf</code></td>
</tr>
</tbody>
</table>
<p>&#x5728;&#x4E0B;&#x4E00;&#x7BC7;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x66F4;&#x52A0;&#x7EC6;&#x81F4;&#x5730;&#x63A2;&#x7A76;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x5176;&#x4ED6;&#x88AB; <code>Init_GlobalC()</code> &#x51FD;&#x6570;&#x6240;&#x8C03;&#x7528;&#x7684;&#x6210;&#x5458;&#x51FD;&#x6570;&#x3002;</p>
<h1 id="&#x7CFB;&#x5217;&#x94FE;&#x63A5;"><a name="&#x7CFB;&#x5217;&#x94FE;&#x63A5;" class="plugin-anchor" href="#&#x7CFB;&#x5217;&#x94FE;&#x63A5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7CFB;&#x5217;&#x94FE;&#x63A5;</h1>
<p>&#x4E0A;&#x7BC7;&#xFF1A;<a href="develop-path6.html">Introduction to ABACUS: Path to PW calculation - Part 6</a></p>
<p>&#x4E0B;&#x7BC7;&#xFF1A;<a href="develop-path8.html">Introduction to ABACUS: Path to PW calculation - Part 8</a></p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; mcresearch.gitee.io 2023 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x7AE0;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2023-10-05 11:01:13
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="develop-path6.html" class="navigation navigation-prev " aria-label="Previous page: Introduction to ABACUS: Path to PW calculation - Part 6">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="develop-path8.html" class="navigation navigation-next " aria-label="Next page: Introduction to ABACUS: Path to PW calculation - Part 8">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction to ABACUS: Path to PW calculation - Part 7","level":"1.2.17","depth":2,"next":{"title":"Introduction to ABACUS: Path to PW calculation - Part 8","level":"1.2.18","depth":2,"path":"develop-path8.md","ref":"develop-path8.md","articles":[]},"previous":{"title":"Introduction to ABACUS: Path to PW calculation - Part 6","level":"1.2.16","depth":2,"path":"develop-path6.md","ref":"develop-path6.md","articles":[]},"dir":"ltr"},"config":{"plugins":["image-captions","auto-scroll-table","splitter","3-ba","theme-comscore","insert-logo","custom-favicon","intopic-toc","anchors","chapter-fold","expandable-chapters","-lunr","-search","search-plus","prism","-highlight","code","mathjax-pro","hide-element","tbfed-pagefooter","disqus","github-buttons","sharing-plus","-sharing","livereload"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy mcresearch.gitee.io 2023","modify_label":"该文章修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"page-treeview":{"copyright":"Copyright &#169; aleen42","minHeaderCount":"2","minHeaderDeep":"2"},"chapter-fold":{},"prism":{},"disqus":{"useIdentifier":false,"shortName":"abacus-user-guide"},"intopic-toc":{"isCollapsed":true,"isScrollspyActive":true,"label":"In this article","maxDepth":6,"mode":"nested","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true},"livereload":{},"splitter":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"auto-scroll-table":{},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"favicon":"./picture/abacus-logo.jpg","theme-comscore":{},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"github-buttons":{"buttons":[{"user":"MCresearch","repo":"abacus-user-guide","type":"star","size":"middle","count":true}]},"custom-favicon":{},"3-ba":{"configuration":"auto","token":"25153cb8bd9a872cfec60b4b23ac0176"},"mathjax-pro":{"forceSVG":false,"version":"2.7.7"},"sharing":{"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{},"insert-logo":{"style":"background: none;max-height: 70px;width: -webkit-fill-available;max-width: 180px;","url":"./picture/abacus-logo.svg"},"expandable-chapters":{},"search-plus":{},"image-captions":{"caption":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","variable_name":"_pictures"}},"theme":"default","name":"abacus-user-guide","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"_pictures":[{"backlink":"abacus-upf.html#fig1.1.5.1","level":"1.1.5","list_caption":"Figure: 局域势函数与非局域势不同轨道角动量对应的半局域径向势函数","alt":"局域势函数与非局域势不同轨道角动量对应的半局域径向势函数","nro":1,"url":"picture/fig_upf-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"局域势函数与非局域势不同轨道角动量对应的半局域径向势函数","attributes":{},"skip":false,"key":"1.1.5.1"},{"backlink":"abacus-upf.html#fig1.1.5.2","level":"1.1.5","list_caption":"Figure: S赝波函数与全电子波函数对比","alt":"S赝波函数与全电子波函数对比","nro":2,"url":"picture/fig_upf-2.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"S赝波函数与全电子波函数对比","attributes":{},"skip":false,"key":"1.1.5.2"},{"backlink":"abacus-upf.html#fig1.1.5.3","level":"1.1.5","list_caption":"Figure: S的双投影波函数","alt":"S的双投影波函数","nro":3,"url":"picture/fig_upf-3.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"S的双投影波函数","attributes":{},"skip":false,"key":"1.1.5.3"},{"backlink":"abacus-upf.html#fig1.1.5.4","level":"1.1.5","list_caption":"Figure: 不同能级波函数在截断半径处log导数对比，其影响散射性质的计算","alt":"不同能级波函数在截断半径处log导数对比，其影响散射性质的计算","nro":4,"url":"picture/fig_upf-4.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"不同能级波函数在截断半径处log导数对比，其影响散射性质的计算","attributes":{},"skip":false,"key":"1.1.5.4"},{"backlink":"abacus-upf.html#fig1.1.5.5","level":"1.1.5","list_caption":"Figure: 不同轨道角动量对应的截断能","alt":"不同轨道角动量对应的截断能","nro":5,"url":"picture/fig_upf-5.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"不同轨道角动量对应的截断能","attributes":{},"skip":false,"key":"1.1.5.5"},{"backlink":"abacus-surface2.html#fig1.1.14.1","level":"1.1.14","list_caption":"Figure: 锯齿状势场分布图","alt":"锯齿状势场分布图","nro":6,"url":"picture/fig_surface2-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"锯齿状势场分布图","attributes":{},"skip":false,"key":"1.1.14.1"},{"backlink":"abacus-surface2.html#fig1.1.14.2","level":"1.1.14","list_caption":"Figure: 一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","alt":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","nro":7,"url":"picture/fig_surface2-2.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","attributes":{},"skip":false,"key":"1.1.14.2"},{"backlink":"abacus-surface2.html#fig1.1.14.3","level":"1.1.14","list_caption":"Figure: 静电势沿超胞Z轴变化图","alt":"静电势沿超胞Z轴变化图","nro":8,"url":"picture/fig_surface2-3.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"静电势沿超胞Z轴变化图","attributes":{},"skip":false,"key":"1.1.14.3"},{"backlink":"abacus-surface5.html#fig1.1.17.1","level":"1.1.17","list_caption":"Figure: Nanoribbon结构图，黑框代表超胞大小，有真空。超胞里包含32个碳原子（棕色），超胞里接触真空的2个碳原子（每个表面一个碳原子）被2个氢原子（白色）饱和。","alt":"Nanoribbon结构图，黑框代表超胞大小，有真空。超胞里包含32个碳原子（棕色），超胞里接触真空的2个碳原子（每个表面一个碳原子）被2个氢原子（白色）饱和。","nro":9,"url":"picture/fig_surface5-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"Nanoribbon结构图，黑框代表超胞大小，有真空。超胞里包含32个碳原子（棕色），超胞里接触真空的2个碳原子（每个表面一个碳原子）被2个氢原子（白色）饱和。","attributes":{},"skip":false,"key":"1.1.17.1"},{"backlink":"abacus-surface5.html#fig1.1.17.2","level":"1.1.17","list_caption":"Figure: 锯齿状势场分布图","alt":"锯齿状势场分布图","nro":10,"url":"picture/fig_surface2-1.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"锯齿状势场分布图","attributes":{},"skip":false,"key":"1.1.17.2"},{"backlink":"abacus-surface5.html#fig1.1.17.3","level":"1.1.17","list_caption":"Figure: 采用PBE交换关联泛函和非自旋极化得到的二维nanoribbon的能带图，可以看出费米面附近CBM（Conduction Band Minimum）和VBM（Valence Band Maximum）重合，无带隙。","alt":"采用PBE交换关联泛函和非自旋极化得到的二维nanoribbon的能带图，可以看出费米面附近CBM（Conduction Band Minimum）和VBM（Valence Band Maximum）重合，无带隙。","nro":11,"url":"picture/fig_surface5-3.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"采用PBE交换关联泛函和非自旋极化得到的二维nanoribbon的能带图，可以看出费米面附近CBM（Conduction Band Minimum）和VBM（Valence Band Maximum）重合，无带隙。","attributes":{},"skip":false,"key":"1.1.17.3"},{"backlink":"abacus-surface5.html#fig1.1.17.4","level":"1.1.17","list_caption":"Figure: 采用PBE交换关联泛函和自旋极化得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出不加电场时，两个自旋方向的能带图几乎一样，都有带隙。","alt":"采用PBE交换关联泛函和自旋极化得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出不加电场时，两个自旋方向的能带图几乎一样，都有带隙。","nro":12,"url":"picture/fig_surface5-4.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"采用PBE交换关联泛函和自旋极化得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出不加电场时，两个自旋方向的能带图几乎一样，都有带隙。","attributes":{},"skip":false,"key":"1.1.17.4"},{"backlink":"abacus-surface5.html#fig1.1.17.5","level":"1.1.17","list_caption":"Figure: 采用PBE交换关联泛函和自旋极化，再给体系加上0.1 V/Å的电场得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出加了能带之后，其中一个自旋方向的能带图出现费米面附近的交叠，呈现金属性质，另外一个自旋方向的能带图依旧保持在费米面处的能隙。","alt":"采用PBE交换关联泛函和自旋极化，再给体系加上0.1 V/Å的电场得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出加了能带之后，其中一个自旋方向的能带图出现费米面附近的交叠，呈现金属性质，另外一个自旋方向的能带图依旧保持在费米面处的能隙。","nro":13,"url":"picture/fig_surface5-5.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"采用PBE交换关联泛函和自旋极化，再给体系加上0.1 V/Å的电场得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出加了能带之后，其中一个自旋方向的能带图出现费米面附近的交叠，呈现金属性质，另外一个自旋方向的能带图依旧保持在费米面处的能隙。","attributes":{},"skip":false,"key":"1.1.17.5"},{"backlink":"abacus-surface6.html#fig1.1.18.1","level":"1.1.18","list_caption":"Figure: 一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","alt":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","nro":14,"url":"picture/fig_surface6-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","attributes":{},"skip":false,"key":"1.1.18.1"},{"backlink":"abacus-surface6.html#fig1.1.18.2","level":"1.1.18","list_caption":"Figure: 静电势（Electrostatic Potential）沿超胞Z轴变化图","alt":"静电势（Electrostatic Potential）沿超胞Z轴变化图","nro":15,"url":"picture/fig_surface6-2.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"静电势（Electrostatic Potential）沿超胞Z轴变化图","attributes":{},"skip":false,"key":"1.1.18.2"},{"backlink":"develop-path4.html#fig1.2.13.1","level":"1.2.13","list_caption":"Figure: PW_Basis::distribute_r()：设一个pool中有5个processors","alt":"PW_Basis::distribute_r()：设一个pool中有5个processors","nro":16,"url":"picture/fig_path4-2.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"PW_Basis::distribute_r()：设一个pool中有5个processors","attributes":{},"skip":false,"key":"1.2.13.1"},{"backlink":"develop-path4.html#fig1.2.13.2","level":"1.2.13","list_caption":"Figure: this->count_pw_st(st_length2D, st_bottom2D)","alt":"this->count_pw_st(st_length2D, st_bottom2D)","nro":17,"url":"picture/fig_path4-3.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"this->count_pw_st(st_length2D, st_bottom2D)","attributes":{},"skip":false,"key":"1.2.13.2"},{"backlink":"develop-path5.html#fig1.2.14.1","level":"1.2.14","list_caption":"Figure: 善用Ctrl+F","alt":"善用Ctrl+F","nro":18,"url":"picture/fig_path5-9.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"善用Ctrl+F","attributes":{},"skip":false,"key":"1.2.14.1"},{"backlink":"develop-path5.html#fig1.2.14.2","level":"1.2.14","list_caption":"Figure: klist.cpp line 486: K_Vectors::Monkhorst_Pack_formula(), k_type = 0 and 1","alt":"klist.cpp line 486: K_Vectors::Monkhorst_Pack_formula(), k_type = 0 and 1","nro":19,"url":"picture/fig_path5-10.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"klist.cpp line 486: K_Vectors::Monkhorst_Pack_formula(), k_type = 0 and 1","attributes":{},"skip":false,"key":"1.2.14.2"},{"backlink":"develop-path5.html#fig1.2.14.3","level":"1.2.14","list_caption":"Figure: klist.cpp line 520: const int i = mpnx * mpny * (z - 1) + mpnx * (y - 1) + (x - 1)","alt":"klist.cpp line 520: const int i = mpnx * mpny * (z - 1) + mpnx * (y - 1) + (x - 1)","nro":20,"url":"picture/fig_path5-11.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"klist.cpp line 520: const int i = mpnx * mpny * (z - 1) + mpnx * (y - 1) + (x - 1)","attributes":{},"skip":false,"key":"1.2.14.3"},{"backlink":"develop-path5.html#fig1.2.14.4","level":"1.2.14","list_caption":"Figure: 1-dimensional example","alt":"1-dimensional example","nro":21,"url":"picture/fig_path5-12.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"1-dimensional example","attributes":{},"skip":false,"key":"1.2.14.4"},{"backlink":"develop-path5.html#fig1.2.14.5","level":"1.2.14","list_caption":"Figure: 2-dimensional example","alt":"2-dimensional example","nro":22,"url":"picture/fig_path5-13.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"2-dimensional example","attributes":{},"skip":false,"key":"1.2.14.5"},{"backlink":"develop-path6.html#fig1.2.16.1","level":"1.2.16","list_caption":"Figure: update cutoff value based on factorized nx, ny and nz","alt":"update cutoff value based on factorized nx, ny and nz","nro":23,"url":"picture/fig_path6-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"update cutoff value based on factorized nx, ny and nz","attributes":{},"skip":false,"key":"1.2.16.1"},{"backlink":"develop-path10.html#fig1.2.20.1","level":"1.2.20","list_caption":"Figure: parallelization over kpoints","alt":"parallelization over kpoints","nro":24,"url":"picture/fig_path10-3.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"parallelization over kpoints","attributes":{},"skip":false,"key":"1.2.20.1"},{"backlink":"develop-path10.html#fig1.2.20.2","level":"1.2.20","list_caption":"Figure: parts on which we are concentrated now","alt":"parts on which we are concentrated now","nro":25,"url":"picture/fig_path10-4.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"parts on which we are concentrated now","attributes":{},"skip":false,"key":"1.2.20.2"},{"backlink":"develop-path10.html#fig1.2.20.3","level":"1.2.20","list_caption":"Figure: PW和LCAO的代码设计平行关系与调用","alt":"PW和LCAO的代码设计平行关系与调用","nro":26,"url":"picture/fig_path10-5.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"PW和LCAO的代码设计平行关系与调用","attributes":{},"skip":false,"key":"1.2.20.3"},{"backlink":"develop-path10.html#fig1.2.20.4","level":"1.2.20","list_caption":"Figure: Relationship between variables that matter presently","alt":"Relationship between variables that matter presently","nro":27,"url":"picture/fig_path10-6.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"Relationship between variables that matter presently","attributes":{},"skip":false,"key":"1.2.20.4"},{"backlink":"develop-path10.html#fig1.2.20.5","level":"1.2.20","list_caption":"Figure: Higher resolution framework of diag_mock() and relationship with other modules and functions","alt":"Higher resolution framework of diag_mock() and relationship with other modules and functions","nro":28,"url":"picture/fig_path10-9.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"Higher resolution framework of diag_mock() and relationship with other modules and functions","attributes":{},"skip":false,"key":"1.2.20.5"},{"backlink":"develop-path11.html#fig1.2.21.1","level":"1.2.21","list_caption":"Figure: mixing方法的通用框架设计","alt":"mixing方法的通用框架设计","nro":29,"url":"picture/fig_path11-3.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"mixing方法的通用框架设计","attributes":{},"skip":false,"key":"1.2.21.1"},{"backlink":"algorithm-wannier.html#fig1.3.1.1","level":"1.3.1","list_caption":"Figure: 左列：不同k点对应的布洛赫波函数；右列：不同晶格中的Wannier函数。","alt":"左列：不同k点对应的布洛赫波函数；右列：不同晶格中的Wannier函数。","nro":30,"url":"picture/fig_wannier.jpg","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"左列：不同k点对应的布洛赫波函数；右列：不同晶格中的Wannier函数。","attributes":{},"skip":false,"key":"1.3.1.1"}]},"gitbook":"*","description":"国产DFT开源软件ABACUS中文使用教程"},"file":{"path":"develop-path7.md","mtime":"2023-10-05T03:01:13.838Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-01-03T07:22:47.437Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-auto-scroll-table/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-3-ba/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-insert-logo/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mathjax-pro/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

