
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction to ABACUS: Path to PW calculation - Part 10 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-image-captions/image-captions.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-auto-scroll-table/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-insert-logo/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="develop-path11.html" />
    
    
    <link rel="prev" href="develop-path9.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"MCresearch","repo":"abacus-user-guide","type":"star","size":"middle","count":true}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    ABACUS 使用教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="abacus-gcc.html">
            
                <a href="abacus-gcc.html">
            
                    
                    GCC 编译 ABACUS 教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="abacus-intel.html">
            
                <a href="abacus-intel.html">
            
                    
                    Intel oneAPI 编译 ABACUS 教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="abacus-gpu.html">
            
                <a href="abacus-gpu.html">
            
                    
                    编译 Nvidia GPU 版本的 ABACUS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="abacus-hpc.html">
            
                <a href="abacus-hpc.html">
            
                    
                    在超算环境编译 ABACUS 的建议
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="abacus-dcu.html">
            
                <a href="abacus-dcu.html">
            
                    
                    ABACUS 在曙光 DCU 集群上的编译与使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="abacus-upf.html">
            
                <a href="abacus-upf.html">
            
                    
                    模守恒赝势生成方法简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.7" data-path="abacus-nac1.html">
            
                <a href="abacus-nac1.html">
            
                    
                    数值原子轨道（一）：ABACUS 中的数值原子轨道命名和使用方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="abacus-nac2.html">
            
                <a href="abacus-nac2.html">
            
                    
                    数值原子轨道（二）：生成给定模守恒赝势的数值原子轨道
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.9" data-path="abacus-nac3.html">
            
                <a href="abacus-nac3.html">
            
                    
                    数值原子轨道（三）：产生高精度数值原子轨道
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.10" data-path="abacus-md.html">
            
                <a href="abacus-md.html">
            
                    
                    ABACUS 分子动力学使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.11" data-path="abacus-sol.html">
            
                <a href="abacus-sol.html">
            
                    
                    ABACUS 隐式溶剂模型使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.12" data-path="abacus-sdft.html">
            
                <a href="abacus-sdft.html">
            
                    
                    ABACUS 随机波函数DFT方法使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.13" data-path="abacus-ofdft.html">
            
                <a href="abacus-ofdft.html">
            
                    
                    ABACUS 无轨道密度泛函理论方法使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.14" data-path="abacus-surface1.html">
            
                <a href="abacus-surface1.html">
            
                    
                    采用 ABACUS 进行表面计算（一）：静电势和功函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.15" data-path="abacus-surface2.html">
            
                <a href="abacus-surface2.html">
            
                    
                    采用 ABACUS 进行表面计算（二）：偶极修正
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.16" data-path="abacus-surface3.html">
            
                <a href="abacus-surface3.html">
            
                    
                    采用 ABACUS 进行表面计算（三）：表面能计算
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.17" data-path="abacus-surface4.html">
            
                <a href="abacus-surface4.html">
            
                    
                    采用 ABACUS 进行表面计算（四）：表面缺陷能和吸附能计算
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.18" data-path="abacus-surface5.html">
            
                <a href="abacus-surface5.html">
            
                    
                    采用 ABACUS 进行表面计算（五）：外加电场
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.19" data-path="abacus-surface6.html">
            
                <a href="abacus-surface6.html">
            
                    
                    采用 ABACUS 进行表面计算（六）：补偿电荷
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.20" data-path="abacus-phonopy.html">
            
                <a href="abacus-phonopy.html">
            
                    
                    ABACUS+Phonopy 计算声子谱
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.21" data-path="abacus-shengbte.html">
            
                <a href="abacus-shengbte.html">
            
                    
                    ABACUS+ShengBTE 计算晶格热导率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.22" data-path="abacus-dpgen.html">
            
                <a href="abacus-dpgen.html">
            
                    
                    ABACUS+DPGEN 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.23" data-path="abacus-libri.html">
            
                <a href="abacus-libri.html">
            
                    
                    ABACUS+LibRI 做杂化泛函计算教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.24" data-path="abacus-candela.html">
            
                <a href="abacus-candela.html">
            
                    
                    ABACUS+Candela 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.25" data-path="abacus-uspex.html">
            
                <a href="abacus-uspex.html">
            
                    
                    ABACUS+USPEX 接口教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.26" data-path="abacus-namd.html">
            
                <a href="abacus-namd.html">
            
                    
                    ABACUS+Hefei NAMD 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.27" data-path="abacus-wannier.html">
            
                <a href="abacus-wannier.html">
            
                    
                    ABACUS+Wannier90 使用教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.28" data-path="abacus-conv.html">
            
                <a href="abacus-conv.html">
            
                    
                    ABACUS 收敛性问题解决手册
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    ABACUS 开发者文档
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="develop-C++.html">
            
                <a href="develop-C++.html">
            
                    
                    ABACUS 开源项目 C++ 代码规范
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="develop-format.html">
            
                <a href="develop-format.html">
            
                    
                    ABACUS 中使用格式化工具 clang-format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="develop-dox.html">
            
                <a href="develop-dox.html">
            
                    
                    ABACUS 注释规范：Doxygen 入门 (c++)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="develop-issue.html">
            
                <a href="develop-issue.html">
            
                    
                    ABACUS 的 Github 仓库 Issues 处理流程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="develop-input.html">
            
                <a href="develop-input.html">
            
                    
                    ABACUS 线上文档输入参数撰写规范
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="develop-rule.html">
            
                <a href="develop-rule.html">
            
                    
                    ABACUS 代码存放规范
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="develop-linedete.html">
            
                <a href="develop-linedete.html">
            
                    
                    ABACUS 全局数据结构和代码行数检测
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="develop-test1.html">
            
                <a href="develop-test1.html">
            
                    
                    ABACUS 中的测试（一）：测试的重要性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="develop-test2.html">
            
                <a href="develop-test2.html">
            
                    
                    ABACUS 中的测试（二）：测试工具 gtest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="develop-path1.html">
            
                <a href="develop-path1.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.11" data-path="develop-path2.html">
            
                <a href="develop-path2.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.12" data-path="develop-path3.html">
            
                <a href="develop-path3.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.13" data-path="develop-path4.html">
            
                <a href="develop-path4.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.14" data-path="develop-path5.html">
            
                <a href="develop-path5.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.15" data-path="develop-sm1.html">
            
                <a href="develop-sm1.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Summary 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.16" data-path="develop-path6.html">
            
                <a href="develop-path6.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.17" data-path="develop-path7.html">
            
                <a href="develop-path7.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 7
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.18" data-path="develop-path8.html">
            
                <a href="develop-path8.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.19" data-path="develop-path9.html">
            
                <a href="develop-path9.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 9
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.20" data-path="develop-path10.html">
            
                <a href="develop-path10.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 10
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.21" data-path="develop-path11.html">
            
                <a href="develop-path11.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Part 11
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.22" data-path="develop-sm2.html">
            
                <a href="develop-sm2.html">
            
                    
                    Introduction to ABACUS: Path to PW calculation - Summary Final
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.23" data-path="develop-addinp.html">
            
                <a href="develop-addinp.html">
            
                    
                    如何在 ABACUS 中新增一个输入参数（截至 v3.5.3）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.24" data-path="develop-design.html">
            
                <a href="develop-design.html">
            
                    
                    C++ 程序设计的一些想法
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    算法文档
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="algorithm-wannier.html">
            
                <a href="algorithm-wannier.html">
            
                    
                    最大局域化 Wannier 函数方法简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="algorithm-mix.html">
            
                <a href="algorithm-mix.html">
            
                    
                    电荷密度混合算法介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="algorithm-delta.html">
            
                <a href="algorithm-delta.html">
            
                    
                    在 ABACUS 中进行差分测试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="news.html">
            
                <a href="news.html">
            
                    
                    ABACUS 新闻稿整理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="contribute.html">
            
                <a href="contribute.html">
            
                    
                    如何贡献 ABACUS 使用教程
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Introduction to ABACUS: Path to PW calculation - Part 10</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="introduction-to-abacus-path-to-pw-calculation---part-10"><a name="introduction-to-abacus-path-to-pw-calculation---part-10" class="plugin-anchor" href="#introduction-to-abacus-path-to-pw-calculation---part-10"><i class="fa fa-link" aria-hidden="true"></i></a>Introduction to ABACUS: Path to PW calculation - Part 10</h1>
<p><strong>&#x4F5C;&#x8005;&#xFF1A;&#x9EC4;&#x4E00;&#x73C2;&#xFF0C;&#x90AE;&#x7BB1;&#xFF1A;huangyk@aisi.ac.cn</strong></p>
<p><strong>&#x5BA1;&#x6838;&#xFF1A;&#x9648;&#x9ED8;&#x6DB5;&#xFF0C;&#x90AE;&#x7BB1;&#xFF1A;mohanchen@pku.edu.cn</strong></p>
<p><strong>&#x98DE;&#x4E66;&#x94FE;&#x63A5;&#xFF1A;<a href="https://xmywuqhxb0.feishu.cn/docx/MRsZdVLw3o3neTxJxRpcrvvqnMe" target="_blank">Introduction to ABACUS: Path to PW calculation - Part 10</a></strong></p>
<blockquote>
<p>&#x1F4C3;<strong>&#x5199;&#x5728;&#x524D;&#x9762;</strong></p>
<ol>
<li>&#x4E0D;&#x8131;&#x79BB;&#x4EE3;&#x7801;&#x2014;&#x2014;&#x907F;&#x514D;&#x8BFB;&#x8005;&#x770B;&#x5B8C;&#x624B;&#x518C;&#x540E;&#x5BF9;&#x4EE3;&#x7801;&#x6CA1;&#x6709;&#x4E00;&#x4E01;&#x70B9;&#x6982;&#x5FF5;</li>
<li>&#x4E0D;&#x5806;&#x780C;&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#x2014;&#x2014;&#x907F;&#x514D;&#x5E73;&#x5EB8;&#x7684;&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF0C;&#x52AA;&#x529B;&#x517C;&#x987E;&#x62C9;&#x8FD1;&#x8BFB;&#x8005;&#x548C;&#x4EE3;&#x7801;&#x8DDD;&#x79BB;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x505A;&#x5230;&#x63D0;&#x7EB2;&#x6308;&#x9886;&#xFF0C;&#x4E0D;&#x9010;&#x884C;&#x590D;&#x5236;&#x4EE3;&#x7801;&#x540E;&#x8FDB;&#x884C;&#x505C;&#x7559;&#x5728;&#x4EE3;&#x7801;&#x8BED;&#x4E49;&#x4E0A;&#x7684;&#x89E3;&#x91CA;</li>
</ol>
</blockquote>
<p><strong>Relax_Driver::relax_driver()</strong></p>
<h1 id="esolverksrun"><a name="esolverksrun" class="plugin-anchor" href="#esolverksrun"><i class="fa fa-link" aria-hidden="true"></i></a>ESolver_KS::Run()</h1>
<p><img src="picture/fig_path10-1.png" alt=""></p>
<h2 id="hsolverpwsetdiagethr"><a name="hsolverpwsetdiagethr" class="plugin-anchor" href="#hsolverpwsetdiagethr"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::set_diagethr()</h2>
<p>&#x8FDB;&#x5165;&#x8FED;&#x4EE3;&#xFF0C;&#x9996;&#x5148;&#x4EE5; <code>HSolverPW::set_diagethr()</code> &#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x80FD;&#x91CF;&#x6536;&#x655B;&#x9650;&#xFF08;&#x672C;&#x8EAB;&#x5E76;&#x65E0;&#x590D;&#x6742;&#x7684;&#x539F;&#x7406;&#xFF0C;&#x56E0;&#x6B64;&#x5B89;&#x6392;&#x8BFB;&#x8005;&#x81EA;&#x884C;&#x9605;&#x8BFB;&#x4EE3;&#x7801;&#x7EC6;&#x8282;&#xFF08;<a href="https://github.com/abacusmodeling/abacus-develop/blob/develop/source/module_hsolver/hsolver_pw.cpp#L233" target="_blank">link</a>&#xFF09;&#xFF09;&#x3002;<code>HSolverPW</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF08;<a href="https://ucoyxk075n.feishu.cn/docx/X499dN2xWoWmp3xgxg9cb0qHnWb?contentTheme=DARK&amp;theme=LIGHT#L6TKdaSwPoKFnExP309cLYQUnBb" target="_blank">link</a>&#xFF09;&#x5DF2;&#x7ECF;&#x5BF9; <code>HSolverPW::diag_ethr</code> &#x7531;&#x9ED8;&#x8BA4;&#x503C; <code>0.0</code> &#x8D4B;&#x503C;&#x4E3A; <code>GlobalV::PW_DIAG_THR</code>&#xFF0C;&#x5E76;&#x4E14;&#x56DE;&#x6EAF; input_conv.cpp&#xFF08;<a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_io/input_conv.cpp#L338" target="_blank">link</a>&#xFF09;&#x4EE5;&#x53CA; input.cpp&#xFF08;<a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_io/input.cpp#L252" target="_blank">link</a>, <a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_io/input.cpp#L1033" target="_blank">link</a>&#xFF09;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053; <code>GlobalV::PW_DIAG_THR</code> &#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>1.0e-2</code>&#xFF0C;&#x7528;&#x6237;&#x7684;&#x4E00;&#x822C;&#x9ED8;&#x8BA4;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A; <code>1.0e-6</code>&#x3002;&#x56E0;&#x6B64;&#x65E0;&#x8BBA;&#x5982;&#x4F55;&#x5BF9;&#x4E8E;&#x4E0A;&#x8FF0;&#x7A0B;&#x5E8F;&#x5757;&#x7684;&#x7B2C; 7 &#x884C;&#xFF0C;&#x90FD;&#x5224;&#x65AD;&#x4E3A;&#x771F;&#xFF08;&#x6CE8;&#x610F;&#xFF0C;if &#x5224;&#x65AD;&#x4E2D; <code>1.0e-6</code> &#x662F;<strong>&#x6570;&#x503C;&#x5C42;&#x9762;&#x7684;0&#x3002;&#x76F8;&#x8F83;&#x4E8E;&#x7EAF;&#x516C;&#x5F0F;&#x63A8;&#x5BFC;&#xFF0C;&#x6570;&#x503C;&#x8BA1;&#x7B97;&#x8FC7;&#x7A0B;&#x4E2D;&#x5E94;&#x5F53;&#x6CE8;&#x610F;&#x6765;&#x81EA;&#x5404;&#x65B9;&#x9762;&#x53EF;&#x80FD;&#x7684;&#x8BEF;&#x5DEE;&#x6765;&#x6E90;&#xFF1A;</strong></p>
<h3 id="conventional-numerical-errors-due-to-unawareness-provided-by-meta-llama2"><a name="conventional-numerical-errors-due-to-unawareness-provided-by-meta-llama2" class="plugin-anchor" href="#conventional-numerical-errors-due-to-unawareness-provided-by-meta-llama2"><i class="fa fa-link" aria-hidden="true"></i></a>Conventional numerical errors due to unawareness: provided by meta-llama2</h3>
<blockquote>
<ol>
<li>Division by zero: This is a classic example of a numerical error that can occur when calculating a function like sin(x)/x as x approaches zero. When x is close to zero, the denominator (x) becomes very small, and the numerator (sin(x)) may become very large due to the amplification effect of the sine function near zero. This can cause the computation to overflow or underflow, resulting in a NaN (Not a Number) value.</li>
<li>Loss of significance: This occurs when a number becomes too small to be accurately represented by the available floating-point precision. For example, suppose we have two vectors u and v, both with a magnitude of 1.0, but one has a tiny component in the direction of the other. If we subtract the two vectors, the result will be a vector with a magnitude of 0.0, because the difference between the two vectors is smaller than the machine epsilon (the smallest representable number). However, if we then try to normalize this vector, we may find that its length is no longer 0.0, but rather a small positive value, due to roundoff errors. This can cause the vector to appear non-orthogonal, even though it should be orthogonal.</li>
<li>Roundoff errors: These occur when a number is rounded to the nearest representable value, either during computation or when storing intermediate results. Rounding errors can accumulate over time, especially when performing repeated operations, and can eventually cause significant errors in the final result. For example, suppose we compute the dot product of two vectors using the formula dot(u,v) = u_1<em>v_1 + u_2</em>v_2 + ... + u_n*v_n. If any of the components of u or v are very small, roundoff errors may cause the computed dot product to differ significantly from the actual value.</li>
<li>Cancellation errors: These occur when two nearly equal quantities are subtracted, resulting in a much smaller quantity. For example, suppose we compute the difference between two very large vectors, one of which has a slightly larger magnitude than the other. The subtraction operation may cancel out most of the digits, leaving behind only a few significant figures. This can cause the result to be very small, even though the original vectors were very large.</li>
<li>Overflow and underflow: These occur when a computation produces a result that exceeds the maximum or minimum representable value of the available floating-point format. For example, suppose we compute the sum of two very large vectors using the formula sum = u + v. If the sum exceeds the maximum representable value, it will wrap around to a very small value, potentially causing significant errors in downstream computations. Similarly, if the sum is negative and exceeds the minimum representable value in absolute value, it will also wrap around to a very small value.</li>
<li>Truncation errors: These occur when an intermediate result is truncated to fit within the available precision, causing the final result to differ from the exact value. For example, suppose we compute the square root of a number using a binary search algorithm that requires us to repeatedly divide the range of possible values in half until we find the correct interval containing the square root. If the range of possible values is very large, we may need to perform many iterations of the algorithm before finding the correct interval, and each iteration will introduce a small amount of truncation error. Over time, these errors can add up and cause the final result to differ significantly from the exact value.</li>
<li>Aliasing: This occurs when a periodic function is sampled at a rate that is not sufficient to capture its full frequency content. For example, suppose we compute the discrete Fourier transform of a periodic function using a finite number of samples. If the sampling rate is not high enough, aliasing effects may cause the reconstructed function to contain spurious features or artifacts that do not correspond to the underlying physical phenomenon.</li>
<li>Numerical instability: This occurs when a computation involves very large or very small numbers, or when the computation involves unstable mathematical operations like division by zero or taking the inverse of a very small number. Unstable computations can cause the result to vary widely depending on slight changes in the input parameters or intermediate results, leading to non-deterministic or chaotic behavior. An example of numerical instability is the Lorenz attractor, which exhibits chaotic behavior for certain parameter values despite being derived from simple, deterministic equations</li>
</ol>
</blockquote>
<p>&#xFF09;&#xFF0C;<code>HSolverPW::diag_ethr = 1.0e-2</code>&#xFF0C;&#x5230;&#x8FBE;<a href="develop-path10.html">&#x6D41;&#x7A0B;&#x56FE;</a>&#x7684;&#x4E0B;&#x4E00;&#x90E8;&#x5206;&#x3002;</p>
<h2 id="esolverkspweachiterinit"><a name="esolverkspweachiterinit" class="plugin-anchor" href="#esolverkspweachiterinit"><i class="fa fa-link" aria-hidden="true"></i></a>ESolver_KS_PW::eachiterinit()</h2>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
    <span class="token keyword">void</span> <span class="token class-name">ESolver_KS</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> istep<span class="token punctuation">,</span> UnitCell<span class="token operator">&amp;</span> ucell<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> iter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> iter <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>maxniter<span class="token punctuation">;</span> <span class="token operator">++</span>iter<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">eachiterinit</span><span class="token punctuation">(</span>istep<span class="token punctuation">,</span> iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">eachiterinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> istep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> iter<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>p_chgmix<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>deband_harris <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span><span class="token function">cal_delta_eband</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//(2) save change density as previous charge,</span>
    <span class="token comment">// prepared fox mixing.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>MY_STOGROUP <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>charge<span class="token operator">-&gt;</span><span class="token function">save_rho_before_sum_band</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>p_chgmix</code> &#x4E3A; <code>ESolver_KS</code> &#x7684;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF0C;&#x5DF2;&#x7ECF;&#x5728;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x88AB;&#x521D;&#x59CB;&#x5316;&#xFF08;<a href="develop-path5.html">link</a>&#xFF09;&#xFF0C;&#x4E14; <code>mixing_mode</code>, <code>mixing_beta</code>, <code>mixing_ndim</code>, <code>mixing_gg0</code>, <code>mixing_tau</code> &#x5DF2;&#x7ECF;&#x6839;&#x636E; <code>Input</code> &#x7C7B;&#x8D4B;&#x503C;&#xFF08;&#x9ED8;&#x8BA4;&#x503C;&#x6216;&#x7528;&#x6237;&#x7ED9;&#x5B9A;&#xFF09;&#xFF0C;&#x5176;&#x6570;&#x636E;&#x6210;&#x5458; <code>rhopw</code> &#x4E5F;&#x5DF2;&#x8D4B;&#x503C; <code>pw_rho</code>&#x3002;</p>
<p><code>Charge_Mixing::reset()</code> &#x51FD;&#x6570;&#x91CD;&#x7F6E;&#x56DB;&#x4E2A;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">Charge_Mixing</span><span class="token double-colon punctuation">::</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// Peize Lin add 2018-11-01</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>new_e_iteration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    irstep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idstep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> totstep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit irrelevant conditions</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="elecstatecaldeltaeband"><a name="elecstatecaldeltaeband" class="plugin-anchor" href="#elecstatecaldeltaeband"><i class="fa fa-link" aria-hidden="true"></i></a>ElecState::cal_delta_eband()</h3>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">double</span> <span class="token class-name">ElecState</span><span class="token double-colon punctuation">::</span><span class="token function">cal_delta_eband</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> deband0<span class="token punctuation">;</span> <span class="token comment">// is \Delta E in the following formulation</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6B64;&#x5904;&#x6D89;&#x53CA;&#x5230;&#x5177;&#x4F53;&#x4E14;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x7684;&#x8BA1;&#x7B97;&#xFF0C;&#x6211;&#x4EEC;&#x6B64;&#x5904;&#x53EA;&#x9610;&#x660E;&#x539F;&#x7406;&#xFF0C;&#x8BFB;&#x8005;&#x4E4B;&#x540E;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x539F;&#x7406;&#x6765;&#x5BF9;&#x6BD4;&#x4EE3;&#x7801;&#xFF08;<a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_elecstate/elecstate_energy.cpp#L88" target="_blank">link</a>&#xFF09;&#x8FDB;&#x884C;&#x7406;&#x89E3;&#x3002;</p>
<ul>
<li><strong>Harris functional</strong></li>
</ul>
<p><script type="math/tex; mode=display">
E^{\mathrm{Harris}}\left[ \rho ^{\mathrm{in}} \right] =\sum_i{n_{\mathrm{i}}^{\mathrm{out}}\langle \psi _{\mathrm{i}}^{\mathrm{out}}|\hat{H}^{\mathrm{in}}|\psi _{\mathrm{i}}^{\mathrm{out}}\rangle}-\frac{1}{2}\iint{\mathrm{d}\mathbf{r}\mathrm{d}\mathbf{r}^{\prime}\frac{\rho ^{\mathrm{in}}\left( \mathbf{r} \right) \rho ^{\mathrm{in}}\left( \mathbf{r}^{\prime} \right)}{|\mathbf{r}-\mathbf{r}^{\prime}|}}+\int{\mathrm{d}\mathbf{r}\left( \epsilon _{\mathrm{xc}}^{\mathrm{in}}\left( \mathbf{r} \right) -v_{\mathrm{xc}}^{\mathrm{in}}\left( \mathbf{r} \right) \right) \rho ^{\mathrm{in}}\left( \mathbf{r} \right)}+\sum_{I<J}{\frac{Z_IZ_J}{R_{IJ}}}
</script></p>
<ul>
<li><strong>Non-meta-GGA functional, nspin != 4 case</strong></li>
</ul>
<p><script type="math/tex; ">\Delta E=-\frac{\Omega _{\mathrm{cell}}}{\sum_p{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}}\sum_{\omega}^{\alpha ,\beta}{\sum_i^{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}{\{[V_{\mathrm{eff}}^{\omega}(r_i)-V_{\mathrm{fixed}}(r_i)]\rho ^{\omega}(r_i)\}}}-2E_{\mathrm{xx}}</script> (discrete form)</p>
<p><script type="math/tex; ">\Delta E=-\int_{\Omega _{\mathrm{cell}}}{d\mathbf{r}\int{d\omega}(V_{\mathrm{eff}}[\rho]-V_{\mathrm{fixed}}[\rho])\rho (\mathbf{r},\omega )}-2E_{\mathrm{xx}}</script> (continuous form)</p>
<ul>
<li><strong>Meta-GGA functional, nspin != 4 case</strong></li>
</ul>
<p><script type="math/tex; ">\Delta E=-\frac{\Omega _{\mathrm{cell}}}{\sum_p{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}}\sum_{\omega}^{\alpha ,\beta}{\sum_i^{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}{\{[V_{\mathrm{eff}}^{\omega}(r_i)-V_{\mathrm{fixed}}(r_i)]\rho ^{\omega}(r_i)+\tau ^{\omega}(r_i)V_{\mathrm{ofk}}^{\omega}(r_i)\}}}-2E_{\mathrm{xx}}</script> (discrete form)</p>
<p><script type="math/tex; ">\Delta E=-\int_{\Omega _{\mathrm{cell}}}{\mathrm{d}\mathbf{r}\int{\mathrm{d}\omega (V_{\mathrm{eff}}[\rho]-V_{\mathrm{fixed}}[\rho])\rho (\mathbf{r},\omega )+\tau (\mathbf{r},\omega )V_{\mathrm{ofk}}(\mathbf{r})}}-2E_{\mathrm{xx}}</script> (continuous form)</p>
<ul>
<li><strong>Non-meta-GGA functional, nspin = 4 case</strong></li>
</ul>
<p><script type="math/tex; ">\Delta E=-\frac{\Omega _{\mathrm{cell}}}{\sum_p{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}}\left[ \sum_i^{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}{\left( \sum_{\omega}^4{V_{\mathrm{eff}}^{\omega}(r_i)\rho ^{\omega}(r_i)} \right) -V_{\mathrm{fixed}}(r_i)\rho ^0(r_i)} \right] -2E_{\mathrm{xx}}</script> (discrete form)</p>
<ul>
<li><strong>Meta-GGA functional, nspin = 4 case</strong></li>
</ul>
<p><script type="math/tex; ">\Delta E=-\frac{\Omega _{\mathrm{cell}}}{\sum_p{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}}\left[ \sum_i^{n_{\mathrm{grid}}^{\mathrm{rs}}(p)}{\left( \sum_{\omega}^4{V_{\mathrm{eff}}^{\omega}(r_i)\rho ^{\omega}(r_i)} \right) -V_{\mathrm{fixed}}(r_i)\rho ^0(r_i)+\tau ^0(r_i)V_{\mathrm{ofk}}^{0}(r_i)} \right] -2E_{\mathrm{xx}}</script> (discrete form)</p>
<p>, where <script type="math/tex; ">\tau ^{\omega}(r_i)\equiv \frac{1}{2}\sum_i^{\mathrm{occ}}{\left( \nabla \psi _i\left( r_i \right) \right) ^2}</script> is the kinetic energy density mapped on realspace grid (<code>kin_r</code>), <script type="math/tex; ">n_{\mathrm{grid}}^{\mathrm{rs}}(p)</script> is the number of grid points in realspace (<script type="math/tex; ">\text{rs}</script>) distributed on processor <script type="math/tex; ">p</script>&#x3002;</p>
<p>(source code <a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_elecstate/elecstate_energy.cpp#L88" target="_blank">link</a>)</p>
<h3 id="chargesaverhobeforesumband"><a name="chargesaverhobeforesumband" class="plugin-anchor" href="#chargesaverhobeforesumband"><i class="fa fa-link" aria-hidden="true"></i></a>Charge::save_rho_before_sum_band()</h3>
<p>&#x6B64;&#x51FD;&#x6570;&#x5907;&#x4EFD;&#x7535;&#x8377;&#x5BC6;&#x5EA6; <code>rho</code>&#xFF0C;&#x5F53;&#x4F7F;&#x7528; meta-GGA &#x65F6;&#xFF0C;&#x540C;&#x65F6;&#x5907;&#x4EFD;&#x52A8;&#x80FD;&#x5BC6;&#x5EA6; <code>kin_r</code>&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">Charge</span><span class="token double-colon punctuation">::</span><span class="token function">save_rho_before_sum_band</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> is <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> is <span class="token operator">&lt;</span> GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token punctuation">;</span> is<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">DCOPY</span><span class="token punctuation">(</span>rho<span class="token punctuation">[</span>is<span class="token punctuation">]</span><span class="token punctuation">,</span> rho_save<span class="token punctuation">[</span>is<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhopw<span class="token operator">-&gt;</span>nrxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> elecstate<span class="token double-colon punctuation">::</span><span class="token function">get_xc_func_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
            ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">DCOPY</span><span class="token punctuation">(</span>kin_r<span class="token punctuation">[</span>is<span class="token punctuation">]</span><span class="token punctuation">,</span> kin_r_save<span class="token punctuation">[</span>is<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>rhopw<span class="token operator">-&gt;</span>nrxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="esolverkspwhamilt2density"><a name="esolverkspwhamilt2density" class="plugin-anchor" href="#esolverkspwhamilt2density"><i class="fa fa-link" aria-hidden="true"></i></a>ESolver_KS_PW::hamilt2density()</h2>
<p>&#x7136;&#x540E;&#x6765;&#x5230; SCF &#x8FED;&#x4EE3;&#x7684;&#x4E3B;&#x4F53;&#x2014;&#x2014;&#x5BF9;&#x89D2;&#x5316;&#x3002;<code>hamilt2density</code> &#x5373;&#x4E3A; Hamiltonian to electron density&#xFF0C;&#x4ECE;&#x56FA;&#x5B9A;&#x7684; Hamiltonian &#x77E9;&#x9635;&#x5230;&#x65B0;&#x7684;&#x7535;&#x8377;&#x5BC6;&#x5EA6;&#x4FE1;&#x606F;&#x3002;<code>hamilt2density()</code> &#x51FD;&#x6570;&#x7684;&#x4E3B;&#x4F53;&#x6897;&#x6982;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">hamilt2density</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> istep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> iter<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">double</span> ethr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>eband <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token operator">-&gt;</span>f_en<span class="token punctuation">.</span>demet <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>istep <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> istep <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> iter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            hsolver<span class="token double-colon punctuation">::</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>need_subspace <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            hsolver<span class="token double-colon punctuation">::</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>need_subspace <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        hsolver<span class="token double-colon punctuation">::</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>PW_DIAG_THR <span class="token operator">=</span> ethr<span class="token punctuation">;</span>
        hsolver<span class="token double-colon punctuation">::</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>PW_DIAG_NMAX <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>PW_DIAG_NMAX<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol<span class="token operator">-&gt;</span><span class="token function">solve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>p_hamilt<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>kspw_psi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>KS_SOLVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0D;&#x96BE;&#x53D1;&#x73B0; <code>phsol</code>&#xFF08;pointer to HSolver&#xFF09;&#x6240;&#x8C03;&#x7528;&#x5176;&#x6210;&#x5458;&#x51FD;&#x6570; <code>solve()</code> &#x4E00;&#x5B9A;&#x662F;&#x5BF9;&#x89D2;&#x5316;&#x7684;&#x4E3B;&#x4F53;&#xFF0C;HSolver &#x5176;&#x987E;&#x540D;&#x601D;&#x4E49;&#x4E3A; Hamiltonian &#x77E9;&#x9635;&#x7684;&#x6C42;&#x89E3;&#x5668;&#x3002;&#x9488;&#x5BF9;&#x5177;&#x4F53;&#x7684;&#x8F6F;&#x4EF6;&#x7F16;&#x5199;&#xFF0C;&#x6211;&#x4EEC;&#x5173;&#x5FC3;&#x5728;&#x5BF9;&#x89D2;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x7A76;&#x7ADF;&#x9700;&#x8981;&#x54EA;&#x4E9B;&#xFF08;&#x54EA;&#x7C7B;&#xFF09;&#x53D8;&#x91CF;&#x3002;&#x6700;&#x5C0F;&#x5730;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x4E8E; general &#x7684;&#x5BF9;&#x89D2;&#x5316;&#x95EE;&#x9898;&#x6700;&#x7EDF;&#x4E00;&#x7684;&#x9884;&#x60F3;&#x4E3A;&#x4EC5;&#x4EC5;&#x9700;&#x8981; Hamiltonian &#x77E9;&#x9635;&#x81EA;&#x8EAB;&#xFF0C;ABACUS &#x7684;&#x65B9;&#x6848;&#x4E3A;&#xFF1A;</p>
<p><img src="picture/fig_path10-2.png" alt=""></p>
<p><code>p_hamilt</code>: HamiltPW: <a href="develop-path9.html">Introduction to ABACUS: Path to PW calculation - Part 9</a>&#xFF0C;Hamiltonian &#x7684; handle&#xFF08;&#x6307;&#x9488;&#x4E3A; handle &#x5B9E;&#x73B0;&#x7684;&#x5B9E;&#x4F53;&#xFF09;</p>
<p><code>kspw_psi</code>: Psi: <a href="develop-path7.html">Introduction to ABACUS: Path to PW calculation - Part 7</a>&#xFF0C;Kohn-Sham planewave wavefunction &#x7684; handle&#xFF0C;&#x540C;&#x6837;&#x6307;&#x9488;&#x662F; handle &#x5B9E;&#x73B0;&#x5B9E;&#x4F53;</p>
<p><code>pelec</code>: ElecState: <a href="develop-path9.html">Introduction to ABACUS: Path to PW calculation - Part 9</a>&#xFF0C;&#x7535;&#x5B50;&#x6001; handle</p>
<blockquote>
<p>&#x1F914;<strong>&#x4E3A;&#x4E86;&#x660E;&#x5929;</strong>
&#x5BFB;&#x627E;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x7684;&#x53D8;&#x91CF;&#x5197;&#x4F59;&#xFF01;</p>
</blockquote>
<h3 id="hsolverpwsolve"><a name="hsolverpwsolve" class="plugin-anchor" href="#hsolverpwsolve"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::solve()</h3>
<p><code>HSolverPW::solve()</code> &#x4E2D;&#x7F16;&#x5199;&#x4E86; <code>HamiltSolvePsiK()</code> &#x51FD;&#x6570;&#x7684;&#x4E3B;&#x529F;&#x80FD;&#xFF0C;&#x5728; <code>solve</code> &#x4E4B;&#x540E;&#x5219;&#x4EC5;&#x4EC5;&#x4E3A;&#x80FD;&#x9699;&#x7684;&#x8BA1;&#x7B97;&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ESolver_KS_PW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">hamilt2density</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> istep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> iter<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">double</span> ethr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>phsol<span class="token operator">-&gt;</span><span class="token function">solve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>p_hamilt<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>kspw_psi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pelec<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>KS_SOLVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6839;&#x636E;&#x65E9;&#x5148;&#x7684;&#x603B;&#x7ED3;&#xFF0C;ABACUS &#x7684;&#x5E76;&#x884C;&#x7B56;&#x7565;&#x5E94;&#x5F53;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<ol>
<li>&#x6309;&#x7167; <code>GlobalV::KPAR</code> &#x786E;&#x5B9A;&#x5E76;&#x884C;&#x6C60;&#x6570;&#x91CF;</li>
<li>&#x6BCF;&#x4E2A;&#x5E76;&#x884C;&#x6C60;&#x540C;&#x65F6;&#x5904;&#x7406; 1 &#x4E2A; k &#x70B9;&#x7684;&#x8BA1;&#x7B97;&#x4EFB;&#x52A1;</li>
<li>&#x5728; pool &#x4E2D;&#x7684; processor&#xFF0C;&#x5219;&#x6309;&#x7167;&#x539F;&#x5148;&#x5206;&#x53D1;&#x7B56;&#x7565;&#xFF0C;&#x5206;&#x522B;&#x6309;&#x7167;&#x5B9E;&#x7A7A;&#x95F4;&#x548C;&#x5230;&#x7A7A;&#x95F4;&#x8FDB;&#x884C;&#x5E76;&#x884C;&#x8BA1;&#x7B97;&#x3002;</li>
</ol>
<p>&#x4F5C;&#x4E3A;&#x5E73;&#x884C;&#x6BD4;&#x8F83;&#xFF0C;Quantum ESPRESSO &#x5B98;&#x65B9;&#x4E0D;&#x4EC5;&#x63D0;&#x4F9B;&#x4E86;&#x66F4;&#x52A0;&#x7075;&#x6D3B;&#x548C;&#x7CBE;&#x7EC6;&#x7684;&#x5E76;&#x884C;&#x7B56;&#x7565;&#xFF0C;&#x4E5F;&#x63D0;&#x4F9B;&#x4E86;&#x57FA;&#x672C;&#x7684;&#x6559;&#x5B66;&#x6587;&#x6863;&#xFF1A;</p>
<p><a href="https://www.quantum-espresso.org/Doc/user_guide/node18.html" target="_blank">https://www.quantum-espresso.org/Doc/user_guide/node18.html</a></p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">solve</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pes<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string method_in<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">bool</span> skip_charge<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>precondition<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>psi<span class="token punctuation">.</span><span class="token function">get_nbasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span>method <span class="token operator">=</span> method_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">initDiagh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span> <span class="token function">eigenvalues</span><span class="token punctuation">(</span>pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nr <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ik <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ik <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks<span class="token punctuation">;</span> <span class="token operator">++</span>ik<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pHamilt<span class="token operator">-&gt;</span><span class="token function">updateHk</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">updatePsiK</span><span class="token punctuation">(</span>pHamilt<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">update_precondition</span><span class="token punctuation">(</span>precondition<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>npwk<span class="token punctuation">[</span>ik<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">hamiltSolvePsiK</span><span class="token punctuation">(</span>pHamilt<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> eigenvalues<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ik <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>skip_charge<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit output</span>
            DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>avg_iter <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">castmem_2d_2h_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cpu_ctx<span class="token punctuation">,</span> cpu_ctx<span class="token punctuation">,</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>c<span class="token punctuation">,</span> eigenvalues<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nr <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">endDiagh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>skip_charge<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>elecstate<span class="token double-colon punctuation">::</span>ElecStatePW<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pes<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">psiToRho</span><span class="token punctuation">(</span>psi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer and return</span>
<span class="token punctuation">}</span>
</code></pre>
<figure id="fig1.2.20.1"><img src="picture/fig_path10-3.png" alt="parallelization over kpoints"><figcaption>&#x56FE; 1. parallelization over kpoints</figcaption></figure>
<figure id="fig1.2.20.2"><img src="picture/fig_path10-4.png" alt="parts on which we are concentrated now"><figcaption>&#x56FE; 2. parts on which we are concentrated now</figcaption></figure>
<h4 id="hsolverpwinitdiagh"><a name="hsolverpwinitdiagh" class="plugin-anchor" href="#hsolverpwinitdiagh"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::initDiagh()</h4>
<p>&#x521D;&#x59CB;&#x5316;&#x5BF9;&#x89D2;&#x5316;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">initDiagh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>method <span class="token operator">==</span> <span class="token string">&quot;cg&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span>method <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>method<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">delete</span> <span class="token punctuation">(</span>DiagoCG<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">DiagoCG</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>precondition<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span>method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>method<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">DiagoCG</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>precondition<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span>method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>method<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>method <span class="token operator">==</span> <span class="token string">&quot;dav&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        DiagoDavid<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>PW_DIAG_NDIM <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>PW_DIAG_NDIM<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span>method <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>method<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">delete</span> <span class="token punctuation">(</span>DiagoDavid<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">DiagoDavid</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>precondition<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span>method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>method<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">DiagoDavid</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> precondition<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span>method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>method<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x82E5; <code>pdiagh</code> &#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x4E14; diagonalization_method &#x4E00;&#x81F4;&#xFF0C;do nothing&#xFF0C;&#x82E5;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;delete, new &#x4E3A;&#x5F53;&#x524D; method&#x3002;&#x82E5; <code>pdiagh</code> &#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x6309;&#x7167; method new &#x76F8;&#x5E94; method &#x5BF9;&#x5E94;&#x7C7B;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3002;new &#x5177;&#x6709;&#x4E00;&#x81F4;&#x7684;&#x5F62;&#x5F0F;&#x3002;</p>
<figure id="fig1.2.20.3"><img src="picture/fig_path10-5.png" alt="PW&#x548C;LCAO&#x7684;&#x4EE3;&#x7801;&#x8BBE;&#x8BA1;&#x5E73;&#x884C;&#x5173;&#x7CFB;&#x4E0E;&#x8C03;&#x7528;"><figcaption>&#x56FE; 3. PW&#x548C;LCAO&#x7684;&#x4EE3;&#x7801;&#x8BBE;&#x8BA1;&#x5E73;&#x884C;&#x5173;&#x7CFB;&#x4E0E;&#x8C03;&#x7528;</figcaption></figure>
<h4 id="hamiltpwupdatehk-and-operatorinit"><a name="hamiltpwupdatehk-and-operatorinit" class="plugin-anchor" href="#hamiltpwupdatehk-and-operatorinit"><i class="fa fa-link" aria-hidden="true"></i></a>HamiltPW::updateHk() and Operator::init()</h4>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">solve</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pes<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string method_in<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">bool</span> skip_charge<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer and previous lines</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ik <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ik <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks<span class="token punctuation">;</span> <span class="token operator">++</span>ik<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pHamilt<span class="token operator">-&gt;</span><span class="token function">updateHk</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HamiltPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">updateHk</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> ik<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">TITLE</span><span class="token punctuation">(</span><span class="token string">&quot;HamiltPW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;updateHk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">init</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">TITLE</span><span class="token punctuation">(</span><span class="token string">&quot;HamiltPW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;updateHk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">Operator</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> ik_in<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>ik <span class="token operator">=</span> ik_in<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>next_op <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>next_op<span class="token operator">-&gt;</span><span class="token function">init</span><span class="token punctuation">(</span>ik_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ik &#x5B9E;&#x53C2;&#x4E3A; k point index&#xFF0C;&#x56E0;&#x6B64;&#x6700;&#x540E;&#x662F;&#x5C06; k point index &#x8D4B;&#x4E88;&#x6BCF;&#x4E00;&#x4E2A; <code>Operator</code> &#x7684; <code>this-&gt;ik</code> &#x6570;&#x636E;&#x6210;&#x5458;&#x3002;&#x56DE;&#x5FC6;&#x6B64;&#x64CD;&#x4F5C;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x5EFA;&#x7ACB;&#x5728; <code>GlobalV::KPAR</code> &#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;<code>KPAR</code> &#x51B3;&#x5B9A;&#x540C;&#x65F6;&#x6709;&#x591A;&#x5C11; k &#x70B9;&#x5E76;&#x884C;&#x3002;&#x8981;&#x6C42;&#x662F; nproc/KPAR &gt; 1&#xFF0C;&#x56E0;&#x6B64;&#x5B9E;&#x9645;&#x6BCF;&#x4E2A; processor &#x4E0A;&#x4E0D;&#x4F1A;&#x540C;&#x65F6;&#x5B58;&#x5728;&#x591A;&#x4E8E; 1 &#x4E2A; k &#x70B9;&#xFF0C;&#x5373;&#x540C;&#x4E00;&#x4E2A; processor &#x4E0A;&#x4E0D;&#x5B58;&#x5728; Operator &#x88AB;&#x8D4B;&#x4E88;&#x4E0D;&#x540C; ik &#x503C;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x8FD9;&#x4E00;&#x64CD;&#x4F5C;&#x4F7F;&#x5F97;<script type="math/tex; ">H(\mathbf{k})</script>&#x7684;<script type="math/tex; ">\mathbf{k}</script>&#x83B7;&#x5F97;&#x66F4;&#x65B0;&#x3002;</p>
<p>&#x66F4;&#x5177;&#x4F53;&#x800C;&#x8A00;&#xFF0C;&#x6839;&#x636E;&#x6BCF;&#x4E2A; processor &#x4E0A; k &#x70B9;&#x6570;&#x91CF;&#xFF08;&#x5F52;&#x7EA6;&#x540E;&#xFF09;nks&#xFF0C;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE; k vector &#x7684;&#x5177;&#x4F53;&#x5750;&#x6807;&#xFF0C;see&#xFF1A;<a href="develop-path5.html">Introduction to ABACUS: Path to PW calculation - Part 5</a> &#xFF0C;&#x5373;&#x5728;<script type="math/tex; ">H(\mathbf{k})</script>&#x548C;&#x5177;&#x4F53;&#x7684;<script type="math/tex; ">\mathbf{k}</script>&#x4E4B;&#x95F4;&#x8054;&#x7CFB;&#x5B9E;&#x9645;&#x4E5F;&#x6709;&#x5B58;&#x50A8;&#x3002;</p>
<figure id="fig1.2.20.4"><img src="picture/fig_path10-6.png" alt="Relationship between variables that matter presently"><figcaption>&#x56FE; 4. Relationship between variables that matter presently</figcaption></figure>
<h4 id="hsolverpwupdatepsik"><a name="hsolverpwupdatepsik" class="plugin-anchor" href="#hsolverpwupdatepsik"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::updatePsiK()</h4>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">solve</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pes<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string method_in<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">bool</span> skip_charge<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer and previous lines</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ik <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ik <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks<span class="token punctuation">;</span> <span class="token operator">++</span>ik<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">updatePsiK</span><span class="token punctuation">(</span>pHamilt<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">updatePsiK</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                           psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                           <span class="token keyword">const</span> <span class="token keyword">int</span> ik<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    psi<span class="token punctuation">.</span><span class="token function">fix_k</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>initialed_psi<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>BASIS_TYPE<span class="token operator">==</span><span class="token string">&quot;pw&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            hamilt<span class="token double-colon punctuation">::</span><span class="token function">diago_PAO_in_pw_k2</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pwf<span class="token punctuation">,</span> pHamilt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="psifixk"><a name="psifixk" class="plugin-anchor" href="#psifixk"><i class="fa fa-link" aria-hidden="true"></i></a>Psi::fix_k()</h5>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span> <span class="token keyword">void</span> <span class="token class-name">Psi</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">fix_k</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> ik<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ik <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_k <span class="token operator">=</span> ik<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ngk <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>npol <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_nbasis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>ngk<span class="token punctuation">[</span>ik<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_nbasis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbasis<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ik <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nk<span class="token punctuation">)</span> <span class="token comment">// this k point is not in present pool</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// mem_saver case</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi_current <span class="token operator">=</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi_bias <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi_current <span class="token operator">=</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>psi<span class="token punctuation">[</span>ik <span class="token operator">*</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbands <span class="token operator">*</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbasis<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>psi_bias <span class="token operator">=</span> ik <span class="token operator">*</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbands <span class="token operator">*</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbasis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>fix_k()&#x51FD;&#x6570;&#x9501;&#x5B9A;&#x4E86;&#x5F53;&#x524D;&#x7684; k &#x70B9;&#xFF0C;&#x4F7F;&#x5F97; psi_current &#x6307;&#x5411;&#x5F53;&#x524D; psi &#x4E00;&#x7EF4;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x6B63;&#x786E;&#x4F4D;&#x7F6E;&#x3002;&#x6B64;&#x5904;&#x7528;&#x5230;&#x4E86; <code>Psi::ngk</code> &#x548C; <code>Psi::npol</code> &#x503C;&#xFF0C;&#x8FD9;&#x4E24;&#x503C;&#x66FE;&#x7ECF;&#x51FA;&#x73B0;&#x5728; <code>Psi</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span> <span class="token class-name">Psi</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Psi</span><span class="token punctuation">(</span><span class="token keyword">int</span> nk_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nbd_in<span class="token punctuation">,</span> <span class="token keyword">int</span> nbs_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> ngk_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>ngk <span class="token operator">=</span> ngk_in<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>current_k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>npol <span class="token operator">=</span> GlobalV<span class="token double-colon punctuation">::</span>NPOL<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>device <span class="token operator">=</span> device<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get_device_type</span><span class="token generic class-name"><span class="token operator">&lt;</span>Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">resize</span><span class="token punctuation">(</span>nk_in<span class="token punctuation">,</span> nbd_in<span class="token punctuation">,</span> nbs_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Currently only GPU&apos;s implementation is supported for device recording!</span>
    device<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">print_device_info</span><span class="token generic class-name"><span class="token operator">&lt;</span>Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>ofs_device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    device<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">record_device_memory</span><span class="token generic class-name"><span class="token operator">&lt;</span>Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span>
                                         GlobalV<span class="token double-colon punctuation">::</span>ofs_device<span class="token punctuation">,</span>
                                         <span class="token string">&quot;Psi-&gt;resize()&quot;</span><span class="token punctuation">,</span>
                                         <span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> nk_in <span class="token operator">*</span> nbd_in <span class="token operator">*</span> nbs_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x6211;&#x4EEC;&#x7684; psi &#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BBE;&#x5B9A;&#x662F;&#x5728; <code>wavefunc::allocate()</code> &#x51FD;&#x6570;&#xFF08;<a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hamilt_pw/hamilt_pwdft/wavefunc.cpp#L81" target="_blank">link</a>&#xFF09;&#xFF0C;&#x5373;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp">psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> <span class="token operator">*</span>wavefunc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> nks<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>ngk<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> npwx_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// initial psi rather than evc</span>
        psi_out <span class="token operator">=</span> <span class="token keyword">new</span> psi<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">Psi</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>nks2<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token punctuation">,</span> npwx <span class="token operator">*</span> GlobalV<span class="token double-colon punctuation">::</span>NPOL<span class="token punctuation">,</span> ngk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> size_t memory_cost <span class="token operator">=</span> nks2 <span class="token operator">*</span> GlobalV<span class="token double-colon punctuation">::</span>NBANDS<span class="token operator">*</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NPOL<span class="token operator">*</span>npwx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; MEMORY FOR PSI (MB)  : &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">double</span><span class="token punctuation">(</span>memory_cost<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024.0</span><span class="token operator">/</span><span class="token number">1024.0</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">Memory</span><span class="token double-colon punctuation">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string">&quot;Psi_PW&quot;</span><span class="token punctuation">,</span> memory_cost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> psi_out<span class="token punctuation">;</span>

    <span class="token comment">//showMemStats();</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Psi::npol</code> &#x6240;&#x53D6; <code>GlobalV::NPOL</code> &#x5219;&#x5728; <code>input_conv.cpp</code> &#x4E2D;&#x53EF;&#x4EE5;&#x627E;&#x5230;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>INPUT<span class="token punctuation">.</span>noncolin <span class="token operator">||</span> INPUT<span class="token punctuation">.</span>lspinorb<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        GlobalV<span class="token double-colon punctuation">::</span>NONCOLIN <span class="token operator">=</span> INPUT<span class="token punctuation">.</span>noncolin<span class="token punctuation">;</span>
        <span class="token comment">// wavefunctions are spinors with 2 components</span>
        GlobalV<span class="token double-colon punctuation">::</span>NPOL <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">// set the domag variable to make a spin-orbit calculation with zero magnetization</span>
        GlobalV<span class="token double-colon punctuation">::</span>DOMAG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> GlobalV<span class="token double-colon punctuation">::</span>DOMAG_Z <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        GlobalV<span class="token double-colon punctuation">::</span>LSPINORB <span class="token operator">=</span> INPUT<span class="token punctuation">.</span>lspinorb<span class="token punctuation">;</span> GlobalV<span class="token double-colon punctuation">::</span>soc_lambda <span class="token operator">=</span> INPUT<span class="token punctuation">.</span>soc_lambda<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        GlobalV<span class="token double-colon punctuation">::</span>LSPINORB <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> GlobalV<span class="token double-colon punctuation">::</span>NONCOLIN <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        GlobalV<span class="token double-colon punctuation">::</span>DOMAG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> GlobalV<span class="token double-colon punctuation">::</span>DOMAG_Z <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        GlobalV<span class="token double-colon punctuation">::</span>NPOL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h5 id="hamiltdiagopaoinpwk2"><a name="hamiltdiagopaoinpwk2" class="plugin-anchor" href="#hamiltdiagopaoinpwk2"><i class="fa fa-link" aria-hidden="true"></i></a>hamilt::diago_PAO_in_pw_k2()</h5>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5230;&#x8FBE; <code>HSolverPW::updatePsiK()</code> &#x8C03;&#x7528;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x51FD;&#x6570;&#x3002;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">updatePsiK</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                           psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                           <span class="token keyword">const</span> <span class="token keyword">int</span> ik<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>initialed_psi<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>BASIS_TYPE<span class="token operator">==</span><span class="token string">&quot;pw&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            hamilt<span class="token double-colon punctuation">::</span><span class="token function">diago_PAO_in_pw_k2</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>pwf<span class="token punctuation">,</span> pHamilt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token function">diago_PAO_in_pw_k2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>ik<span class="token punctuation">,</span>
                        psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> <span class="token operator">&amp;</span>wvf<span class="token punctuation">,</span>
                        ModulePW<span class="token double-colon punctuation">::</span>PW_Basis_K <span class="token operator">*</span>wfc_basis<span class="token punctuation">,</span>
                        wavefunc <span class="token operator">*</span>p_wf<span class="token punctuation">,</span>
                        hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> <span class="token operator">*</span>phm_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">TITLE</span><span class="token punctuation">(</span><span class="token string">&quot;wavefunc&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;diago_PAO_in_pw_k2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> starting_nw <span class="token operator">=</span> p_wf<span class="token operator">-&gt;</span><span class="token function">get_starting_nw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>starting_nw <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>starting_nw <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> <span class="token function">etatom</span><span class="token punctuation">(</span>starting_nw<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> nbasis <span class="token operator">=</span> wvf<span class="token punctuation">.</span><span class="token function">get_nbasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> nbands <span class="token operator">=</span> wvf<span class="token punctuation">.</span><span class="token function">get_nbands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> current_nbasis <span class="token operator">=</span> wfc_basis<span class="token operator">-&gt;</span>npwk<span class="token punctuation">[</span>ik<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> p_wf<span class="token operator">-&gt;</span>init_wfc<span class="token operator">==</span><span class="token string">&quot;random&quot;</span> <span class="token operator">||</span> <span class="token punctuation">(</span> p_wf<span class="token operator">-&gt;</span>init_wfc<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">&quot;atomic&quot;</span> <span class="token operator">&amp;&amp;</span> GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>natomwfc <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        p_wf<span class="token operator">-&gt;</span><span class="token function">random</span><span class="token punctuation">(</span>wvf<span class="token punctuation">.</span><span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>nbands<span class="token punctuation">,</span>ik<span class="token punctuation">,</span> wfc_basis<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>KS_SOLVER<span class="token operator">==</span><span class="token string">&quot;cg&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>phm_in<span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                hsolver<span class="token double-colon punctuation">::</span><span class="token class-name">DiagoIterAssist</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">diagH_subspace</span><span class="token punctuation">(</span>phm_in<span class="token punctuation">,</span> wvf<span class="token punctuation">,</span> wvf<span class="token punctuation">,</span> etatom<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;wavefunc&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Hamiltonian does not exist!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>p_wf<span class="token operator">-&gt;</span>init_wfc<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">&quot;atomic&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ModuleBase<span class="token double-colon punctuation">::</span>ComplexMatrix <span class="token function">wfcatom</span><span class="token punctuation">(</span>starting_nw<span class="token punctuation">,</span> nbasis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>test_wf<span class="token punctuation">)</span>ModuleBase<span class="token double-colon punctuation">::</span><span class="token class-name">GlobalFunc</span><span class="token double-colon punctuation">::</span><span class="token function">OUT</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>ofs_running<span class="token punctuation">,</span> <span class="token string">&quot;starting_nw&quot;</span><span class="token punctuation">,</span> starting_nw<span class="token punctuation">)</span><span class="token punctuation">;</span>

        p_wf<span class="token operator">-&gt;</span><span class="token function">atomic_wfc</span><span class="token punctuation">(</span>ik<span class="token punctuation">,</span> current_nbasis<span class="token punctuation">,</span> GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>lmax_ppwf<span class="token punctuation">,</span> wfc_basis<span class="token punctuation">,</span>
                         wfcatom<span class="token punctuation">,</span> GlobalC<span class="token double-colon punctuation">::</span>ppcell<span class="token punctuation">.</span>tab_at<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>NQX<span class="token punctuation">,</span> GlobalV<span class="token double-colon punctuation">::</span>DQ<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>p_wf<span class="token operator">-&gt;</span>init_wfc <span class="token operator">==</span> <span class="token string">&quot;atomic+random&quot;</span>
            <span class="token operator">&amp;&amp;</span> starting_nw <span class="token operator">==</span> GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>natomwfc<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            p_wf<span class="token operator">-&gt;</span><span class="token function">atomicrandom</span><span class="token punctuation">(</span>wfcatom<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> starting_nw<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> wfc_basis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        p_wf<span class="token operator">-&gt;</span><span class="token function">random</span><span class="token punctuation">(</span>wfcatom<span class="token punctuation">.</span>c<span class="token punctuation">,</span> GlobalC<span class="token double-colon punctuation">::</span>ucell<span class="token punctuation">.</span>natomwfc<span class="token punctuation">,</span> nbands<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> wfc_basis<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>KS_SOLVER<span class="token operator">==</span><span class="token string">&quot;cg&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>phm_in<span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                hsolver<span class="token double-colon punctuation">::</span><span class="token class-name">DiagoIterAssist</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">diagH_subspace_init</span><span class="token punctuation">(</span>phm_in<span class="token punctuation">,</span> wfcatom<span class="token punctuation">.</span>c<span class="token punctuation">,</span>
                            wfcatom<span class="token punctuation">.</span>nr<span class="token punctuation">,</span> wfcatom<span class="token punctuation">.</span>nc<span class="token punctuation">,</span> wvf<span class="token punctuation">,</span> etatom<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;wavefunc&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Hamiltonian does not exist!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">assert</span><span class="token punctuation">(</span>nbands <span class="token operator">&lt;=</span> wfcatom<span class="token punctuation">.</span>nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ib<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> ib<span class="token operator">&lt;</span>nbands<span class="token punctuation">;</span> ib<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ig<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> ig<span class="token operator">&lt;</span>nbasis<span class="token punctuation">;</span> ig<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">wvf</span><span class="token punctuation">(</span>ib<span class="token punctuation">,</span> ig<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">wfcatom</span><span class="token punctuation">(</span>ib<span class="token punctuation">,</span> ig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E14;&#x6B64;&#x64CD;&#x4F5C;&#x904D;&#x5386; k &#x70B9;&#x3002;</p>
<blockquote>
<p>&#x1F914;<strong>&#x5BB6;&#x5EAD;&#x4F5C;&#x4E1A;</strong>
&#x6211;&#x4EEC;&#x4E0D;&#x6253;&#x7B97;&#x82B1;&#x8D39;&#x592A;&#x591A;&#x65F6;&#x95F4;&#x5728;&#x6CE2;&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;&#x8FD9;&#x4E2A;&#x8BAE;&#x9898;&#x4E0A;&#xFF0C;&#x4F46;&#x662F;&#x4ECD;&#x7136;&#x63A8;&#x8350;&#x4F60;&#x81EA;&#x4E3B;&#x9605;&#x8BFB;&#x5B83;&#xFF01;&#x4ED4;&#x7EC6;&#x770B;&#x770B;&#x6709;&#x65F6;&#x5019;&#x4F60;&#x642C;&#x5F04;&#x7684; <code>starting_wfc</code>/<code>init_wfc</code>/<code>scf_guess</code> &#x5173;&#x952E;&#x8BCD;&#x80CC;&#x540E;&#x5230;&#x5E95;&#x662F;&#x600E;&#x4E48;&#x8FD0;&#x884C;&#x7684;&#x5427;&#xFF01;</p>
</blockquote>
<h4 id="hsolverpwupdateprecondition"><a name="hsolverpwupdateprecondition" class="plugin-anchor" href="#hsolverpwupdateprecondition"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::update_precondition()</h4>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">solve</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pes<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string method_in<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">bool</span> skip_charge<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer and previous lines</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ik <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ik <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks<span class="token punctuation">;</span> <span class="token operator">++</span>ik<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">update_precondition</span><span class="token punctuation">(</span>precondition<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>npwk<span class="token punctuation">[</span>ik<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">update_precondition</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>h_diag<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> ik<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> npw<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    h_diag<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>h_diag<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> precondition_type <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span> tpiba2 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>tpiba2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>precondition_type <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ig <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ig <span class="token operator">&lt;</span> npw<span class="token punctuation">;</span> ig<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            FPTYPE g2kin <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span><span class="token function">getgk2</span><span class="token punctuation">(</span>ik<span class="token punctuation">,</span>ig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> tpiba2<span class="token punctuation">;</span>
            h_diag<span class="token punctuation">[</span>ig<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g2kin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>precondition_type <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ig <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ig <span class="token operator">&lt;</span> npw<span class="token punctuation">;</span> ig<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            FPTYPE g2kin <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span><span class="token function">getgk2</span><span class="token punctuation">(</span>ik<span class="token punctuation">,</span>ig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> tpiba2<span class="token punctuation">;</span>
            h_diag<span class="token punctuation">[</span>ig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> g2kin <span class="token operator">+</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>g2kin <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>g2kin <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>GlobalV<span class="token double-colon punctuation">::</span>NSPIN<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> size <span class="token operator">=</span> h_diag<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ig <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ig <span class="token operator">&lt;</span> npw<span class="token punctuation">;</span> ig<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            h_diag<span class="token punctuation">[</span>ig<span class="token operator">+</span>size<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> h_diag<span class="token punctuation">[</span>ig<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5BF9;&#x89D2;&#x5316;&#x65F6;&#x7684; preconditioner &#x4E00;&#x822C;&#x517C;&#x5177;&#x6570;&#x5B66;&#x548C;&#x6570;&#x503C;&#x8BA1;&#x7B97;&#x7684; trick&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x53EA;&#x89C2;&#x5BDF;&#x5176;&#x5F62;&#x5F0F;&#x800C;&#x4E0D;&#x505A;&#x8FC7;&#x591A;&#x89E3;&#x8BFB;&#x3002;</p>
<p><img src="picture/fig_path10-7.png" alt=""></p>
<p>Preconditioner of CG diagonalization method: <a href="https://gitee.com/mcresearch/abacus-user-guide/blob/master/examples/develop/PreconditionerCGDiag.pdf" target="_blank">PreconditionerCGDiag.pdf</a></p>
<p>Preconditioner of Davidson diagonalization method: <a href="https://gitee.com/mcresearch/abacus-user-guide/blob/master/examples/develop/PreconditionerDavidsonDiag.pdf" target="_blank">PreconditionerDavidsonDiag.pdf</a></p>
<h4 id="hsolverpwhamiltsolvepsik"><a name="hsolverpwhamiltsolvepsik" class="plugin-anchor" href="#hsolverpwhamiltsolvepsik"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::hamiltSolvePsiK()</h4>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">solve</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pes<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string method_in<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">bool</span> skip_charge<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ik <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ik <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks<span class="token punctuation">;</span> <span class="token operator">++</span>ik<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// each column corresponds to one energy band, row corresponds to k point. Therefore it</span>
    <span class="token comment">// is ekb[ikpoint][iband], see declaration in CLASS elecstate</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span> <span class="token function">eigenvalues</span><span class="token punctuation">(</span>pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nr <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">/// solve eigenvector and eigenvalue for H(k), nr, nc are number of rows and columns</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">hamiltSolvePsiK</span><span class="token punctuation">(</span>pHamilt<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> eigenvalues<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ik <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">hamiltSolvePsiK</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> hm<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span> eigenvalue<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token operator">-&gt;</span><span class="token function">diag</span><span class="token punctuation">(</span>hm<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> eigenvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x56DE;&#x5FC6;&#x521A;&#x521A;&#x5728; <code>initDiagh</code> &#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x5BF9;&#x89D2;&#x5316;&#x65B9;&#x6CD5;&#xFF0C;<code>pdiagh</code> &#x88AB;&#x5206;&#x914D;&#x4E0D;&#x540C;&#x6D3E;&#x751F;&#x7C7B;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF08;&#x56E0;&#x6B64; pdiagh &#x5F88;&#x53EF;&#x80FD;&#x4E00;&#x5F00;&#x59CB;&#x88AB;&#x58F0;&#x660E;&#x4E3A; <code>DiagH</code> &#x57FA;&#x7C7B;&#x6307;&#x9488;&#xFF0C;diag &#x53EF;&#x80FD;&#x5728;&#x57FA;&#x7C7B;&#x4E2D;&#x88AB;&#x58F0;&#x660E;&#x4E3A;&#x7EAF;&#x865A;&#x51FD;&#x6570;&#xFF09;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x8DDF;&#x968F; Davidson &#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x6B64; <code>pdiag</code> &#x7684; diag &#x65B9;&#x6CD5;&#x5B9E;&#x9645;&#x4E3A; <code>DiagoDavid::diag()</code>&#x3002;</p>
<p><img src="picture/fig_path10-8.png" alt=""></p>
<h5 id="diagodaviddiag"><a name="diagodaviddiag" class="plugin-anchor" href="#diagodaviddiag"><i class="fa fa-link" aria-hidden="true"></i></a>DiagoDavid::diag()</h5>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">DiagoDavid</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">diag</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> phm_in<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      FPTYPE<span class="token operator">*</span> eigenvalue_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// record the times of trying iterative diagonalization</span>
    <span class="token keyword">int</span> ntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__CUDA<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__ROCM<span class="token punctuation">)</span></span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>device <span class="token operator">==</span> psi<span class="token double-colon punctuation">::</span>GpuDevice<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">resmem_var_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>d_precondition<span class="token punctuation">,</span> psi<span class="token punctuation">.</span><span class="token function">get_nbasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">syncmem_var_h2d_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>cpu_ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>d_precondition<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>precondition<span class="token punctuation">,</span> psi<span class="token punctuation">.</span><span class="token function">get_nbasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">diag_mock</span><span class="token punctuation">(</span>phm_in<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> eigenvalue_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>ntry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">DiagoIterAssist</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">test_exit_cond</span><span class="token punctuation">(</span>ntry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>notconv <span class="token operator">&gt;</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> psi<span class="token punctuation">.</span><span class="token function">get_nbands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n notconv = &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n DiagoDavid::diag&apos;, too many bands are not converged! \n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h6 id="diagodaviddiagmock&#x4E0E;-abacus-blas-lapack-interfaces"><a name="diagodaviddiagmock&#x4E0E;-abacus-blas-lapack-interfaces" class="plugin-anchor" href="#diagodaviddiagmock&#x4E0E;-abacus-blas-lapack-interfaces"><i class="fa fa-link" aria-hidden="true"></i></a>DiagoDavid::diag_mock()&#x4E0E; ABACUS-BLAS, LAPACK interfaces</h6>
<p>Source code link: <a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hsolver/diago_david.cpp#L49" target="_blank">https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hsolver/diago_david.cpp#L49</a></p>
<figure id="fig1.2.20.5"><img src="picture/fig_path10-9.png" alt="Higher resolution framework of diag_mock() and relationship with other modules and functions"><figcaption>&#x56FE; 5. Higher resolution framework of diag_mock() and relationship with other modules and functions</figcaption></figure>
<blockquote>
<p>&#x1F527;<strong>&#x91CD;&#x6784;&#x4FE1;&#x606F;</strong>
<code>diag_mock()</code> will be renamed as <code>diag_once()</code> in the future</p>
<p>&#x1F914;<strong>&#x590D;&#x4E60;</strong>
Try to recall all details introduced from Part.1 to now as many as possible!
In <code>Driver::reading()</code>, it is where <code>Input::Default()</code>, <code>Read()</code> and <code>Default_2()</code>, Input_conv::Convert() are called. From then on, we have parameters defined both from user input and default.
In <code>Driver::atomic_world()</code>, it is where real space grid and planewave distributed. Remember <code>ESolver</code> driven the creation and initialization of <code>pw_rho</code>, <code>pw_wfc</code>? <code>PW_Basis</code> and <code>PW_Basis_K</code>? <code>setuptransform()</code>, <code>initgrids()</code>, <code>distribute_r()</code> and _g()?
In <code>UnitCell::setup_cell()</code>, we read atom positions, pseudopotentials and kpoints,  then we have (ir)reducible k vector list, and so (k+G) the planewave expanded wavefunction.
In present contents, we initialize <code>psi</code>, then construct H|psi&gt;, use <code>HSolver</code> flow to orthogonalize and diagonalize it.</p>
</blockquote>
<p>&#x57FA;&#x4E8E;&#x4E0A;&#x56FE;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x9009;&#x62E9;&#x6570;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#x8FDB;&#x884C;&#x8BF4;&#x660E;&#x3002;</p>
<p>1. &#x5BF9;&#x89D2;&#x5316;&#x7EF4;&#x5EA6;&#xFF08;ndim&#xFF09;&#x8BBE;&#x5B9A;</p>
<p>&#x7531;&#x4E8E;&#x5E73;&#x9762;&#x6CE2;&#x6570;&#x91CF;&#x4F17;&#x591A;-&gt; &#x57FA;&#x51FD;&#x6570;&#x6570;&#x91CF;&#x4F17;&#x591A;-&gt; &#x5F85;&#x5BF9;&#x89D2;&#x5316; Hamiltonian &#x77E9;&#x9635;&#x7EF4;&#x5EA6;&#x5DE8;&#x5927;&#xFF0C;&#x800C;&#x771F;&#x6B63;&#x5173;&#x5FC3;&#x7279;&#x5F81;&#x503C;/&#x672C;&#x5F81;&#x503C;/&#x672C;&#x5F81;&#x6001;&#x6570;&#x91CF;&#x8FDC;&#x5C0F;&#x4E8E;&#x57FA;&#x51FD;&#x6570;&#x6570;&#x91CF;&#xFF0C;&#x56E0;&#x6B64;&#x8003;&#x8651;&#x4F7F;&#x7528;&#x5B50;&#x7A7A;&#x95F4;&#x65B9;&#x6CD5;&#x8FED;&#x4EE3;&#x6C42;&#x89E3;&#x5176;&#x4E2D;&#x80FD;&#x91CF;&#x6700;&#x4F4E;&#x7684; n &#x4E2A;&#x7279;&#x5F81;&#x503C;/&#x7279;&#x5F81;&#x5411;&#x91CF;&#xFF0C;&#x800C;&#x975E;&#x4E00;&#x6B21;&#x6027;&#x8BA1;&#x7B97;&#x5168;&#x90E8;&#x3002;&#x7531;&#x4E8E;&#x5B50;&#x7A7A;&#x95F4;&#x5BF9;&#x89D2;&#x5316;&#x65B9;&#x6CD5;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x5B9E;&#x9645;&#x9700;&#x8981;&#x5BF9;&#x89D2;&#x5316;&#x7684;&#x5B50;&#x7A7A;&#x95F4;&#x7EF4;&#x5EA6;&#x6BD4;&#x7528;&#x6237;&#x6240;&#x9700;&#x80FD;&#x5E26;&#x6570;&#x91CF;&#x8981;&#x591A;&#xFF08;ndim &#x500D;&#xFF09;&#xFF0C;ndim &#x88AB;&#x8BBE;&#x8BA1;&#x4E3A;&#x7528;&#x6237;&#x8BBE;&#x5B9A;&#x53C2;&#x6570;&#xFF1A;</p>
<p><img src="picture/fig_path10-10.png" alt=""></p>
<p><code>nbasis</code>: <a href="develop-path7.html">Introduction to ABACUS: Path to PW calculation - Part 7</a> : npwx*GlobalV::NPOL, npwx: maximal number of planewaves among all kpoints, for non-noncolinear cases, GlobalV::NPOL is 1, otherwise is 2.</p>
<p><code>ngk</code>: <a href="develop-path6.html">Introduction to ABACUS: Path to PW calculation - Part 6</a></p>
<p><code>current_nbasis</code>: ngk[ik] or nbasis</p>
<table>
<thead>
<tr>
<th>ABACUS</th>
<th>Quantum ESPRESSO</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="picture/fig_path10-11.png" alt=""></td>
<td><img src="picture/fig_path10-12.png" alt=""></td>
</tr>
</tbody>
</table>
<p>&#x5728; ABACUS &#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x5BF9;&#x89D2;&#x5316;&#x5B50;&#x7A7A;&#x95F4;&#x7EF4;&#x6570;&#x4E3A; nbnd&#xFF0C;&#x82E5;&#x6709;&#x90E8;&#x5206;&#x672C;&#x5F81;&#x503C;&#x65E0;&#x6CD5;&#x6536;&#x655B;&#xFF0C;&#x5219;&#x4F7F;&#x5B50;&#x7A7A;&#x95F4;&#x7EF4;&#x6570;&#x9012;&#x589E;&#xFF0C;&#x76F4;&#x5230;&#x5B50;&#x7A7A;&#x95F4;&#x7EF4;&#x6570;&#x589E;&#x81F3; ndim*nbnd&#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0;&#x5F00;&#x59CB;&#x8BA1;&#x7B97; Hamiltonian &#x77E9;&#x9635;&#xFF08;refresh()&#xFF0C;&#x4FDD;&#x7559;&#x6700;&#x521D;&#x59CB; psi&#xFF0C;&#x5373; ndim&#x2265;2 &#x5FC5;&#x987B;&#x6EE1;&#x8DB3;&#xFF0C;&#x4ECE; dim=2 &#x5F00;&#x59CB;&#x8986;&#x76D6;&#xFF09;&#xFF0C;&#x76F4;&#x5230;&#x8FBE;&#x5230;&#x6700;&#x5927;&#x8FED;&#x4EE3;&#x6B21;&#x6570;&#x6216;&#x6536;&#x655B;&#x3002;</p>
<p>2. hpsi_info</p>
<p>&#x5728;&#x5BF9;&#x89D2;&#x5316;&#x4E4B;&#x524D;&#xFF0C;&#x786E;&#x8BA4;&#x88AB;&#x5BF9;&#x89D2;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x5177;&#x4F53;&#x5F62;&#x5F0F;&#x5341;&#x5206;&#x91CD;&#x8981;&#x3002;<code>hpsi_info</code> &#x5B58;&#x50A8; <code>hpsi</code> &#x64CD;&#x4F5C;&#x540E;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x51FA;&#x73B0;&#x4E8E;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">DiagoDavid</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">diag_mock</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> phm_in<span class="token punctuation">,</span>
                                           psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                           FPTYPE<span class="token operator">*</span> eigenvalue_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/// initialize H|psi&gt;...</span>
    hpsi_info <span class="token function">dav_hpsi_in</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>basis<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>n_band <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hphi<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pack up |psi&gt;, range (for finding psi on present processor), and H|psi&gt;</span>
    phm_in<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">hPsi</span><span class="token punctuation">(</span>dav_hpsi_in<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">cal_elem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>dim<span class="token punctuation">,</span> nbase<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv<span class="token punctuation">,</span> basis<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hphi<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>sphi<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hcc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>scc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">diag_zhegvx</span><span class="token punctuation">(</span>nbase<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>n_band<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hcc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>scc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbase_x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>eigenvalue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>vcc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p><code>hpsi_info</code> &#x7684;&#x8BBE;&#x8BA1;&#x975E;&#x5E38;&#x7C7B;&#x4F3C;&#x4E8E;&#x88F8;&#x9732;&#x7684;&#xFF0C;&#x5177;&#x6709;&#x8FED;&#x4EE3;&#x5668;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x4E2D;&#x8FED;&#x4EE3;&#x5668;&#x5B9E;&#x9645;&#x6765;&#x6E90;&#x4E8E; <code>psi::range</code> &#x8FD9;&#x4E00; <code>psi</code> namespace &#x4E2D;&#x540D;&#x4E3A; <code>range</code> &#x7684;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x652F;&#x6301;&#x3002;&#x66F4;&#x52A0;&#x5177;&#x4F53;&#x800C;&#x8A00;&#xFF1A;</p>
<p>a. <code>hpsi_info</code>&#x5B9A;&#x4E49;&#x5C01;&#x88C5;</p>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//source/module_hamilt_pwdft/operator_pw/operator_pw.h</span>
    <span class="token comment">/// @brief short name of type hamilt::Operator&lt;std::complex&lt;FPTYPE&gt;, Device&gt;::hpsi_info, which is a tuple std::tuple&lt;const psi::Psi&lt;FPTYPE, Device&gt;*, const psi::Range, FPTYPE*&gt;</span>
    <span class="token comment">/// @param Psi const psi::Psi&lt;FPTYPE, Device&gt;*</span>
    <span class="token comment">/// @param Range const psi::Range, a struct in namespace psi, contains information about range, see source/module_psi/psi.h</span>
    <span class="token comment">/// @param FPTYPE* pointer to the memory of hpsi</span>
    <span class="token comment">/// @note in PW code, different operators donate hPsi independently. run this-&gt;act function for the first operator and run all act() for other nodes in chain table </span>
    <span class="token keyword">using</span> hpsi_info <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token class-name">hamilt</span><span class="token double-colon punctuation">::</span>Operator<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>hpsi_info<span class="token punctuation">;</span>
</code></pre>
<p>b. <code>hpsi_info</code>&#x5B9A;&#x4E49;</p>
<pre class="language-"><code class="lang-cpp"><span class="token comment">//source/module_hamilt_general/operator.h</span>
    <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>tuple<span class="token operator">&lt;</span><span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> psi<span class="token double-colon punctuation">::</span>Range<span class="token punctuation">,</span> FPTYPE<span class="token operator">*</span><span class="token operator">&gt;</span> hpsi_info<span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> hpsi_info <span class="token function">hPsi</span><span class="token punctuation">(</span>hpsi_info<span class="token operator">&amp;</span> input<span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre>
<p>c. psi&#x4E0E;&#x5176;&#x8D5D;&#x8FED;&#x4EE3;&#x5668;range&#xFF1A;<a href="https://ucoyxk075n.feishu.cn/docx/VQlzdDXBeoqzuYxIci2cG5otnOg" target="_blank">psi::Psi::psi&#x7684;&#x591A;&#x7EF4;&#x6570;&#x7EC4;&#x5B58;&#x50A8;</a></p>
<p>d. hpsi_info&#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">typename</span> <span class="token class-name">OperatorPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>hpsi_info <span class="token class-name">OperatorPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">hPsi</span><span class="token punctuation">(</span>
    hpsi_info<span class="token operator">&amp;</span> input<span class="token punctuation">)</span> <span class="token keyword">const</span> 
<span class="token punctuation">{</span>
  ModuleBase<span class="token double-colon punctuation">::</span>timer<span class="token double-colon punctuation">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token string">&quot;OperatorPW&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hPsi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> psi_input <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>tuple<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> psi_info <span class="token operator">=</span> psi_input<span class="token operator">-&gt;</span><span class="token function">to_range</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> n_npwx <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>psi_info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// number of bands or k-points, as explained</span>

  std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span> <span class="token operator">*</span>tmhpsi <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_hpsi</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span> <span class="token operator">*</span>tmpsi_in <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>psi_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>tmpsi_in <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      <span class="token class-name">ModuleBase</span><span class="token double-colon punctuation">::</span><span class="token function">WARNING_QUIT</span><span class="token punctuation">(</span><span class="token string">&quot;OperatorPW&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;please choose correct range of psi for hPsi()!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">act</span><span class="token punctuation">(</span>psi_input<span class="token punctuation">,</span> n_npwx<span class="token punctuation">,</span> tmpsi_in<span class="token punctuation">,</span> tmhpsi<span class="token punctuation">)</span><span class="token punctuation">;</span>
  OperatorPW<span class="token operator">*</span> <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OperatorPW<span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>next_op<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      node<span class="token operator">-&gt;</span><span class="token function">act</span><span class="token punctuation">(</span>psi_input<span class="token punctuation">,</span> n_npwx<span class="token punctuation">,</span> tmpsi_in<span class="token punctuation">,</span> tmhpsi<span class="token punctuation">)</span><span class="token punctuation">;</span>
      node <span class="token operator">=</span> <span class="token punctuation">(</span>OperatorPW<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>next_op<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ModuleBase<span class="token double-colon punctuation">::</span>timer<span class="token double-colon punctuation">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token string">&quot;OperatorPW&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hPsi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token operator">*</span> hpsi_pointer <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>in_place<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      <span class="token function">syncmem_complex_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> hpsi_pointer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hpsi<span class="token operator">-&gt;</span><span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hpsi<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>hpsi<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token operator">-&gt;</span>hpsi <span class="token operator">=</span> <span class="token keyword">new</span> psi<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">Psi</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>hpsi_pointer<span class="token punctuation">,</span> <span class="token operator">*</span>psi_input<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n_npwx<span class="token operator">/</span>psi_input<span class="token operator">-&gt;</span>npol<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>                                     hpsi
  <span class="token keyword">return</span> <span class="token function">hpsi_info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>hpsi<span class="token punctuation">,</span> psi<span class="token double-colon punctuation">::</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n_npwx<span class="token operator">/</span>psi_input<span class="token operator">-&gt;</span>npol<span class="token punctuation">)</span><span class="token punctuation">,</span> hpsi_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>std::get<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>*</span><span class="token punctuation">&gt;</span></span>()</code> &#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x4ECE; tuple &#x5BB9;&#x5668;&#x91CC;&#x63D0;&#x53D6;&#x76F8;&#x5E94;&#x4F4D;&#x7F6E;&#x7684;&#x5143;&#x7D20;&#xFF08;&#x4EE5;&#x5F15;&#x7528;&#x65B9;&#x5F0F;&#xFF09;&#x3002;</p>
<p>3. &#x7EBF;&#x6027;&#x4EE3;&#x6570;&#x76F8;&#x5173;&#x64CD;&#x4F5C;</p>
<p>&#x904D;&#x5E03; <code>SchmidtOrth</code>&#x3001;<code>calc_elem</code>&#x3001;<code>diag_zhegvx</code>&#x3001;<code>calc_grad</code>&#x3001;<code>refresh</code> &#x548C; <code>diag_mock</code> &#x672C;&#x4F53;&#xFF0C;&#x5176;&#x4E2D;&#x5B58;&#x5728;&#x5F88;&#x591A;&#x7C7B;&#x4F3C;&#x4E8E; BLAS &#x548C; LAPACK &#x6570;&#x5B66;&#x5E93;&#x4E2D;&#x64CD;&#x4F5C;&#xFF08;&#x77E2;&#x91CF;&#x3001;&#x77E9;&#x9635;&#xFF09;&#x7684;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#xFF0C;&#x4F8B;&#x5982; <code>gemm_op</code>&#x3001;<code>gemv_op</code> &#x7B49;&#x3002;&#x540C;&#x6837;&#x5730;&#xFF0C;&#x5982;&#x6B64;&#x7EC4;&#x7EC7;&#x64CD;&#x4F5C;&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x5C3D;&#x53EF;&#x80FD;&#x652F;&#x6301;&#x6A21;&#x677F;&#x504F;&#x7279;&#x5316;&#x3002;&#x4E3E;&#x4F8B;&#x6765;&#x8BB2;&#xFF0C;<code>gemm</code> &#x4E3A; general matrix-matrix multiplication&#xFF0C;<code>gemv</code> &#x5219;&#x4E3A; general matrix-vector multiplication&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x89C1; BLAS quick reference &#x4EE5;&#x53CA; LAPACK online documentation&#xFF08;<a href="https://www.netlib.org/lapack/explore-html/index.html" target="_blank">https://www.netlib.org/lapack/explore-html/index.html</a>&#xFF09;&#xFF1A;<a href="https://gitee.com/mcresearch/abacus-user-guide/blob/master/examples/develop/BlasQuickReference.pdf" target="_blank">BlasQuickReference.pdf</a></p>
<blockquote>
<p>&#x1F527;&#x91CD;&#x6784;&#x4FE1;&#x606F;
Present Gram-Schmidt orthogonalization need to optimize both for numerical accurancy and performance reasons.</p>
<p>&#x1F527;&#x91CD;&#x6784;&#x4FE1;&#x606F;
Interfaces between ABACUS and basic math libraries like BLAS, LAPACK are ill-designed &#x1F616;, see: </p>
<ul>
<li><a href="https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hsolver/kernels/math_kernel_op.cpp" target="_blank">https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hsolver/kernels/math_kernel_op.cpp</a></li>
<li><a href="ttps://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hsolver/kernels/dngvd_op.cpp" target="_blank">https://github.com/deepmodeling/abacus-develop/blob/develop/source/module_hsolver/kernels/dngvd_op.cpp</a>
For a better design and implementation, see Armadillo Linear Algebra library (<a href="https://arma.sourceforge.net/" target="_blank">https://arma.sourceforge.net/</a>):
\armadillo-12.6.3\include\armadillo_bits\mul_gemm.hpp:line 245
Consider carefully about what can be avoided to expose to developers who only care about the use but not the mechanism of those math libraries.</li>
</ul>
<p>&#x1F527;&#x91CD;&#x6784;&#x4FE1;&#x606F;
On-going plan: interfaces between ABACUS and basic math libraries will be refactorized for heterogeneous programming (GPU support)</p>
</blockquote>
<p>4/. &#x5B9E;&#x9645;&#x5BF9;&#x89D2;&#x5316;&#x8FC7;&#x7A0B;</p>
<p><img src="picture/fig_path10-13.png" alt=""></p>
<blockquote>
<p>&#x1F914;<strong>&#x6279;&#x5224;&#x6027;&#x601D;&#x8003;</strong>
&#x4F60;&#x8BA4;&#x4E3A;&#x628A; math_kernel_ops.cpp &#x548C;.h &#x6587;&#x4EF6;&#x653E;&#x5728;&#x76EE;&#x5F55; source/module_hsolver/kernels/&#x4E0B;&#x662F;&#x5408;&#x7406;&#x7684;&#x5417;&#xFF1F;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x54EA;&#x91CC;&#x53EF;&#x80FD;&#x662F;&#x66F4;&#x597D;&#x7684;&#x9009;&#x62E9;&#x5462;&#xFF1F;</p>
</blockquote>
<p>5/. diag_mock()&#x5FAA;&#x73AF;&#x7ED3;&#x675F;</p>
<p><img src="picture/fig_path10-14.png" alt=""></p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv <span class="token operator">||</span> <span class="token punctuation">(</span>nbase <span class="token operator">+</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbase_x<span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>dav_iter <span class="token operator">==</span> DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>PW_DIAG_NMAX<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer and comments</span>
            <span class="token function">setmem_complex_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span> psi<span class="token punctuation">.</span><span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n_band <span class="token operator">*</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>dmx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
            <span class="token comment">// haozhihan repalce 2022-10-18</span>
            <span class="token generic-function"><span class="token function">gemm_op</span><span class="token generic class-name"><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span>           <span class="token comment">// fortran-stype comments</span>
                                      <span class="token char">&apos;N&apos;</span><span class="token punctuation">,</span>
                                      <span class="token char">&apos;N&apos;</span><span class="token punctuation">,</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>dim<span class="token punctuation">,</span>           <span class="token comment">// m: row of A,C</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>n_band<span class="token punctuation">,</span>        <span class="token comment">// n: col of B,C</span>
                                      nbase<span class="token punctuation">,</span>               <span class="token comment">// k: col of A, row of B</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>one<span class="token punctuation">,</span>
                                      basis<span class="token punctuation">.</span><span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// A dim * nbase</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>dim<span class="token punctuation">,</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>vcc<span class="token punctuation">,</span>           <span class="token comment">// B nbase * n_band</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>nbase_x<span class="token punctuation">,</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>zero<span class="token punctuation">,</span>
                                      psi<span class="token punctuation">.</span><span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// C dim * n_band</span>
                                      <span class="token keyword">this</span><span class="token operator">-&gt;</span>dmx
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>notconv <span class="token operator">||</span> <span class="token punctuation">(</span>dav_iter <span class="token operator">==</span> DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>PW_DIAG_NMAX<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//omit timer and comments</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre>
<h5 id="diagocg-&#x6982;&#x89C8;"><a name="diagocg-&#x6982;&#x89C8;" class="plugin-anchor" href="#diagocg-&#x6982;&#x89C8;"><i class="fa fa-link" aria-hidden="true"></i></a>DiagoCG &#x6982;&#x89C8;</h5>
<p>&#x5728; Conjugated Gradient&#xFF08;&#x5171;&#x8F6D;&#x68AF;&#x5EA6;&#x6CD5;&#xFF0C;CG&#xFF09;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x9996;&#x5148;&#x8FDB;&#x884C; band-by-band matrix &#x7684;&#x5BF9;&#x89D2;&#x5316;&#xFF1A;</p>
<p><script type="math/tex; ">\mathbf{C}^{\mathbf{\dagger }}\mathbf{H}(\mathbf{G}_1,\mathbf{G}_2)\mathbf{C}</script>&#xFF0C;&#x5176;&#x4E2D;<script type="math/tex; ">\mathbf{H}</script>&#x4E3A;&#x4EE5; pw &#x8868;&#x8C61;&#x7684; Hamiltonian &#x77E9;&#x9635;&#xFF1A;</p>
<p><script type="math/tex; mode=display">
H_{ij}=\langle \mathbf{G}_i|\hat{H}|\mathbf{G}_j\rangle 
\\
=\int{e^{-i\mathbf{G}_i\cdot \mathbf{r}}\hat{H}e^{i\mathbf{G}_j\cdot \mathbf{r}}\mathrm{d}\mathbf{r}}
\\
=\delta _{ij}\frac{1}{2}|\mathbf{G}_i|^2+V\left( |\mathbf{G}_i-\mathbf{G}_j| \right) 
</script></p>
<p><code>psi</code> &#x5B58;&#x50A8;&#x7684;&#x5373;&#x4E3A;$\mathbf{C}$&#x3002;&#x6211;&#x4EEC;&#x5F97;&#x5230; <code>psi</code> &#x540E;&#xFF0C;&#x4F7F;&#x7528; CG &#x65B9;&#x6CD5; line-by-line&#xFF08;band-by-band&#xFF09;&#x8FDB;&#x884C; CG &#x6CD5;&#x4F18;&#x5316;&#x80FD;&#x91CF;&#xFF0C;&#x540C;&#x65F6;&#x4FDD;&#x6301; line &#x4E4B;&#x95F4;&#x6B63;&#x4EA4;&#x3002;</p>
<h4 id="hsolverpwenddiagh"><a name="hsolverpwenddiagh" class="plugin-anchor" href="#hsolverpwenddiagh"><i class="fa fa-link" aria-hidden="true"></i></a>HSolverPW::endDiagh()</h4>
<p>&#x5728;&#x79BB;&#x5F00;&#x5BF9;&#x89D2;&#x5316;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x4ECD;&#x7136;&#x6709;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x3002;&#x9996;&#x5148;&#x518D;&#x6B21;&#x9605;&#x8BFB; <code>HSolverPW::solve()</code> &#x7684; k &#x70B9;&#x5FAA;&#x73AF;&#x90E8;&#x5206;&#xFF1A;</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">solve</span><span class="token punctuation">(</span>hamilt<span class="token double-colon punctuation">::</span>Hamilt<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span> pHamilt<span class="token punctuation">,</span>
                                      psi<span class="token double-colon punctuation">::</span>Psi<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span><span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">&amp;</span> psi<span class="token punctuation">,</span>
                                      elecstate<span class="token double-colon punctuation">::</span>ElecState<span class="token operator">*</span> pes<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string method_in<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">bool</span> skip_charge<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">initDiagh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FPTYPE<span class="token operator">&gt;</span> <span class="token function">eigenvalues</span><span class="token punctuation">(</span>pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nr <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ik <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ik <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks<span class="token punctuation">;</span> <span class="token operator">++</span>ik<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pHamilt<span class="token operator">-&gt;</span><span class="token function">updateHk</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">updatePsiK</span><span class="token punctuation">(</span>pHamilt<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">update_precondition</span><span class="token punctuation">(</span>precondition<span class="token punctuation">,</span> ik<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>npwk<span class="token punctuation">[</span>ik<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">hamiltSolvePsiK</span><span class="token punctuation">(</span>pHamilt<span class="token punctuation">,</span> psi<span class="token punctuation">,</span> eigenvalues<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ik <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token function">castmem_2d_2h_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cpu_ctx<span class="token punctuation">,</span> cpu_ctx<span class="token punctuation">,</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>c<span class="token punctuation">,</span> eigenvalues<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nr <span class="token operator">*</span> pes<span class="token operator">-&gt;</span>ekb<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">endDiagh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;- will be here soon</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>eigenvalues</code> <code>std::vector</code> &#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5B9E;&#x9645;&#x4E3A;&#x4E00;&#x6241;&#x5E73;&#x5316;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#xFF0C;&#x6BCF;&#x4E2A; k &#x70B9;&#x5199;&#x5165;&#x4E00;&#x4E2A;&#x6279;&#x6B21;&#x7684;&#x672C;&#x5F81;&#x503C;&#x6570;&#x636E;&#x4E14;&#x5E73;&#x79FB;&#x6307;&#x9488;&#x5230;&#x76F8;&#x5E94;&#x4F4D;&#x7F6E;&#xFF0C;<code>psi</code> &#x5219;&#x5728;&#x6BCF;&#x6B21;&#x8C03;&#x7528; <code>HSolverPW::updatePsiK()</code> &#x7684;&#x65F6;&#x5019;&#x79FB;&#x52A8;&#x6307;&#x9488;&#xFF0C;&#x5230; <code>psi</code> &#x6241;&#x5E73;&#x5316;&#x4E09;&#x7EF4;&#x6570;&#x7EC4;&#x4E2D;&#x5BF9;&#x5E94; k &#x70B9;&#x4F4D;&#x7F6E;&#x7684;&#x80FD;&#x5E26;-&#x57FA;&#x51FD;&#x6570;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x3002;</p>
<p>k &#x70B9;&#x5FAA;&#x73AF;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x5C06; <code>eigenvalues</code> &#x7684;&#x6570;&#x636E;&#x8D4B;&#x503C;&#x7ED9; <code>pes</code>&#xFF08;pointer to elecstate&#xFF09;&#x7684; <code>ekb</code>&#xFF08;energies of kpoint-band&#xFF09;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528; <code>HSolverPW::endDiagh()</code> &#x51FD;&#x6570;&#xFF0C;&#x5220;&#x9664;&#x5BF9;&#x89D2;&#x5316;&#x6307;&#x9488; <code>pdiag</code>:</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FPTYPE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Device</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">HSolverPW</span><span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">endDiagh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>method <span class="token operator">==</span> <span class="token string">&quot;cg&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>method <span class="token operator">==</span> <span class="token string">&quot;dav&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token punctuation">(</span>DiagoDavid<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>pdiagh <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>avg_iter <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        GlobalV<span class="token double-colon punctuation">::</span>ofs_running<span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Average iterative diagonalization steps: &quot;</span><span class="token operator">&lt;&lt;</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>avg_iter <span class="token operator">/</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>wfc_basis<span class="token operator">-&gt;</span>nks
            <span class="token operator">&lt;&lt;</span><span class="token string">&quot; ; where current threshold is: &quot;</span><span class="token operator">&lt;&lt;</span>DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>PW_DIAG_THR<span class="token operator">&lt;&lt;</span><span class="token string">&quot; . &quot;</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token comment">//reset avg_iter</span>
        DiagoIterAssist<span class="token operator">&lt;</span>FPTYPE<span class="token punctuation">,</span> Device<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>avg_iter <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//psi only should be initialed once for PW</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>initialed_psi<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token operator">-&gt;</span>initialed_psi <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>HSolverPW::solve()</code> &#x51FD;&#x6570;&#x4E2D;&#x6700;&#x540E;&#x8FD8;&#x8C03;&#x7528;&#x4E86; <code>ElecStatePW::psiToRho()</code> &#x51FD;&#x6570;&#xFF0C;&#x987E;&#x540D;&#x601D;&#x4E49;&#x8BE5;&#x51FD;&#x6570;&#x5C06;&#x8F93;&#x51FA;&#x65B0;&#x7684;&#x7535;&#x8377;&#x5BC6;&#x5EA6; rho&#x3002;&#x8003;&#x8651;&#x5230;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4E86;&#x4F17;&#x591A;&#x5B50;&#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x8BE5;&#x51FD;&#x6570;&#x7559;&#x5230;&#x4E0B;&#x4E00;&#x7BC7;&#x3002;</p>
<h1 id="&#x7CFB;&#x5217;&#x94FE;&#x63A5;"><a name="&#x7CFB;&#x5217;&#x94FE;&#x63A5;" class="plugin-anchor" href="#&#x7CFB;&#x5217;&#x94FE;&#x63A5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7CFB;&#x5217;&#x94FE;&#x63A5;</h1>
<p>&#x4E0A;&#x7BC7;&#xFF1A;<a href="develop-path9.html">Introduction to ABACUS: Path to PW calculation - Part 9</a></p>
<p>&#x4E0B;&#x7BC7;&#xFF1A;<a href="develop-path11.html">Introduction to ABACUS: Path to PW calculation - Part 11</a></p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; mcresearch.gitee.io 2023 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x7AE0;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2023-10-05 17:43:52
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="develop-path9.html" class="navigation navigation-prev " aria-label="Previous page: Introduction to ABACUS: Path to PW calculation - Part 9">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="develop-path11.html" class="navigation navigation-next " aria-label="Next page: Introduction to ABACUS: Path to PW calculation - Part 11">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction to ABACUS: Path to PW calculation - Part 10","level":"1.2.20","depth":2,"next":{"title":"Introduction to ABACUS: Path to PW calculation - Part 11","level":"1.2.21","depth":2,"path":"develop-path11.md","ref":"develop-path11.md","articles":[]},"previous":{"title":"Introduction to ABACUS: Path to PW calculation - Part 9","level":"1.2.19","depth":2,"path":"develop-path9.md","ref":"develop-path9.md","articles":[]},"dir":"ltr"},"config":{"plugins":["image-captions","auto-scroll-table","splitter","3-ba","theme-comscore","insert-logo","custom-favicon","intopic-toc","anchors","chapter-fold","expandable-chapters","-lunr","-search","search-plus","prism","-highlight","code","mathjax-pro","hide-element","tbfed-pagefooter","disqus","github-buttons","sharing-plus","-sharing","livereload"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy mcresearch.gitee.io 2023","modify_label":"该文章修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"page-treeview":{"copyright":"Copyright &#169; aleen42","minHeaderCount":"2","minHeaderDeep":"2"},"chapter-fold":{},"prism":{},"disqus":{"useIdentifier":false,"shortName":"abacus-user-guide"},"intopic-toc":{"isCollapsed":true,"isScrollspyActive":true,"label":"In this article","maxDepth":6,"mode":"nested","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true},"livereload":{},"splitter":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"auto-scroll-table":{},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"favicon":"./picture/abacus-logo.jpg","theme-comscore":{},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"github-buttons":{"buttons":[{"user":"MCresearch","repo":"abacus-user-guide","type":"star","size":"middle","count":true}]},"custom-favicon":{},"3-ba":{"configuration":"auto","token":"25153cb8bd9a872cfec60b4b23ac0176"},"mathjax-pro":{"forceSVG":false,"version":"2.7.7"},"sharing":{"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{},"insert-logo":{"style":"background: none;max-height: 70px;width: -webkit-fill-available;max-width: 180px;","url":"./picture/abacus-logo.svg"},"expandable-chapters":{},"search-plus":{},"image-captions":{"caption":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","variable_name":"_pictures"}},"theme":"default","name":"abacus-user-guide","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"_pictures":[{"backlink":"abacus-upf.html#fig1.1.6.1","level":"1.1.6","list_caption":"Figure: 局域势函数与非局域势不同轨道角动量对应的半局域径向势函数","alt":"局域势函数与非局域势不同轨道角动量对应的半局域径向势函数","nro":1,"url":"picture/fig_upf-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"局域势函数与非局域势不同轨道角动量对应的半局域径向势函数","attributes":{},"skip":false,"key":"1.1.6.1"},{"backlink":"abacus-upf.html#fig1.1.6.2","level":"1.1.6","list_caption":"Figure: S赝波函数与全电子波函数对比","alt":"S赝波函数与全电子波函数对比","nro":2,"url":"picture/fig_upf-2.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"S赝波函数与全电子波函数对比","attributes":{},"skip":false,"key":"1.1.6.2"},{"backlink":"abacus-upf.html#fig1.1.6.3","level":"1.1.6","list_caption":"Figure: S的双投影波函数","alt":"S的双投影波函数","nro":3,"url":"picture/fig_upf-3.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"S的双投影波函数","attributes":{},"skip":false,"key":"1.1.6.3"},{"backlink":"abacus-upf.html#fig1.1.6.4","level":"1.1.6","list_caption":"Figure: 不同能级波函数在截断半径处log导数对比，其影响散射性质的计算","alt":"不同能级波函数在截断半径处log导数对比，其影响散射性质的计算","nro":4,"url":"picture/fig_upf-4.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"不同能级波函数在截断半径处log导数对比，其影响散射性质的计算","attributes":{},"skip":false,"key":"1.1.6.4"},{"backlink":"abacus-upf.html#fig1.1.6.5","level":"1.1.6","list_caption":"Figure: 不同轨道角动量对应的截断能","alt":"不同轨道角动量对应的截断能","nro":5,"url":"picture/fig_upf-5.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"不同轨道角动量对应的截断能","attributes":{},"skip":false,"key":"1.1.6.5"},{"backlink":"abacus-surface2.html#fig1.1.15.1","level":"1.1.15","list_caption":"Figure: 锯齿状势场分布图","alt":"锯齿状势场分布图","nro":6,"url":"picture/fig_surface2-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"锯齿状势场分布图","attributes":{},"skip":false,"key":"1.1.15.1"},{"backlink":"abacus-surface2.html#fig1.1.15.2","level":"1.1.15","list_caption":"Figure: 一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","alt":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","nro":7,"url":"picture/fig_surface2-2.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","attributes":{},"skip":false,"key":"1.1.15.2"},{"backlink":"abacus-surface2.html#fig1.1.15.3","level":"1.1.15","list_caption":"Figure: 静电势沿超胞Z轴变化图","alt":"静电势沿超胞Z轴变化图","nro":8,"url":"picture/fig_surface2-3.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"静电势沿超胞Z轴变化图","attributes":{},"skip":false,"key":"1.1.15.3"},{"backlink":"abacus-surface5.html#fig1.1.18.1","level":"1.1.18","list_caption":"Figure: Nanoribbon结构图，黑框代表超胞大小，有真空。超胞里包含32个碳原子（棕色），超胞里接触真空的2个碳原子（每个表面一个碳原子）被2个氢原子（白色）饱和。","alt":"Nanoribbon结构图，黑框代表超胞大小，有真空。超胞里包含32个碳原子（棕色），超胞里接触真空的2个碳原子（每个表面一个碳原子）被2个氢原子（白色）饱和。","nro":9,"url":"picture/fig_surface5-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"Nanoribbon结构图，黑框代表超胞大小，有真空。超胞里包含32个碳原子（棕色），超胞里接触真空的2个碳原子（每个表面一个碳原子）被2个氢原子（白色）饱和。","attributes":{},"skip":false,"key":"1.1.18.1"},{"backlink":"abacus-surface5.html#fig1.1.18.2","level":"1.1.18","list_caption":"Figure: 锯齿状势场分布图","alt":"锯齿状势场分布图","nro":10,"url":"picture/fig_surface2-1.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"锯齿状势场分布图","attributes":{},"skip":false,"key":"1.1.18.2"},{"backlink":"abacus-surface5.html#fig1.1.18.3","level":"1.1.18","list_caption":"Figure: 采用PBE交换关联泛函和非自旋极化得到的二维nanoribbon的能带图，可以看出费米面附近CBM（Conduction Band Minimum）和VBM（Valence Band Maximum）重合，无带隙。","alt":"采用PBE交换关联泛函和非自旋极化得到的二维nanoribbon的能带图，可以看出费米面附近CBM（Conduction Band Minimum）和VBM（Valence Band Maximum）重合，无带隙。","nro":11,"url":"picture/fig_surface5-3.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"采用PBE交换关联泛函和非自旋极化得到的二维nanoribbon的能带图，可以看出费米面附近CBM（Conduction Band Minimum）和VBM（Valence Band Maximum）重合，无带隙。","attributes":{},"skip":false,"key":"1.1.18.3"},{"backlink":"abacus-surface5.html#fig1.1.18.4","level":"1.1.18","list_caption":"Figure: 采用PBE交换关联泛函和自旋极化得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出不加电场时，两个自旋方向的能带图几乎一样，都有带隙。","alt":"采用PBE交换关联泛函和自旋极化得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出不加电场时，两个自旋方向的能带图几乎一样，都有带隙。","nro":12,"url":"picture/fig_surface5-4.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"采用PBE交换关联泛函和自旋极化得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出不加电场时，两个自旋方向的能带图几乎一样，都有带隙。","attributes":{},"skip":false,"key":"1.1.18.4"},{"backlink":"abacus-surface5.html#fig1.1.18.5","level":"1.1.18","list_caption":"Figure: 采用PBE交换关联泛函和自旋极化，再给体系加上0.1 V/Å的电场得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出加了能带之后，其中一个自旋方向的能带图出现费米面附近的交叠，呈现金属性质，另外一个自旋方向的能带图依旧保持在费米面处的能隙。","alt":"采用PBE交换关联泛函和自旋极化，再给体系加上0.1 V/Å的电场得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出加了能带之后，其中一个自旋方向的能带图出现费米面附近的交叠，呈现金属性质，另外一个自旋方向的能带图依旧保持在费米面处的能隙。","nro":13,"url":"picture/fig_surface5-5.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"采用PBE交换关联泛函和自旋极化，再给体系加上0.1 V/Å的电场得到的二维nanoribbon的能带图。蓝色和红色代表自旋极化方向不同时对应的两副能带图像，可以看出加了能带之后，其中一个自旋方向的能带图出现费米面附近的交叠，呈现金属性质，另外一个自旋方向的能带图依旧保持在费米面处的能隙。","attributes":{},"skip":false,"key":"1.1.18.5"},{"backlink":"abacus-surface6.html#fig1.1.19.1","level":"1.1.19","list_caption":"Figure: 一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","alt":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","nro":14,"url":"picture/fig_surface6-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"一个水分子位于超胞中，红色代表氧原子，白色代表氢原子","attributes":{},"skip":false,"key":"1.1.19.1"},{"backlink":"abacus-surface6.html#fig1.1.19.2","level":"1.1.19","list_caption":"Figure: 静电势（Electrostatic Potential）沿超胞Z轴变化图","alt":"静电势（Electrostatic Potential）沿超胞Z轴变化图","nro":15,"url":"picture/fig_surface6-2.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"静电势（Electrostatic Potential）沿超胞Z轴变化图","attributes":{},"skip":false,"key":"1.1.19.2"},{"backlink":"develop-path4.html#fig1.2.13.1","level":"1.2.13","list_caption":"Figure: PW_Basis::distribute_r()：设一个pool中有5个processors","alt":"PW_Basis::distribute_r()：设一个pool中有5个processors","nro":16,"url":"picture/fig_path4-2.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"PW_Basis::distribute_r()：设一个pool中有5个processors","attributes":{},"skip":false,"key":"1.2.13.1"},{"backlink":"develop-path4.html#fig1.2.13.2","level":"1.2.13","list_caption":"Figure: this->count_pw_st(st_length2D, st_bottom2D)","alt":"this->count_pw_st(st_length2D, st_bottom2D)","nro":17,"url":"picture/fig_path4-3.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"this->count_pw_st(st_length2D, st_bottom2D)","attributes":{},"skip":false,"key":"1.2.13.2"},{"backlink":"develop-path5.html#fig1.2.14.1","level":"1.2.14","list_caption":"Figure: 善用Ctrl+F","alt":"善用Ctrl+F","nro":18,"url":"picture/fig_path5-9.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"善用Ctrl+F","attributes":{},"skip":false,"key":"1.2.14.1"},{"backlink":"develop-path5.html#fig1.2.14.2","level":"1.2.14","list_caption":"Figure: klist.cpp line 486: K_Vectors::Monkhorst_Pack_formula(), k_type = 0 and 1","alt":"klist.cpp line 486: K_Vectors::Monkhorst_Pack_formula(), k_type = 0 and 1","nro":19,"url":"picture/fig_path5-10.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"klist.cpp line 486: K_Vectors::Monkhorst_Pack_formula(), k_type = 0 and 1","attributes":{},"skip":false,"key":"1.2.14.2"},{"backlink":"develop-path5.html#fig1.2.14.3","level":"1.2.14","list_caption":"Figure: klist.cpp line 520: const int i = mpnx * mpny * (z - 1) + mpnx * (y - 1) + (x - 1)","alt":"klist.cpp line 520: const int i = mpnx * mpny * (z - 1) + mpnx * (y - 1) + (x - 1)","nro":20,"url":"picture/fig_path5-11.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"klist.cpp line 520: const int i = mpnx * mpny * (z - 1) + mpnx * (y - 1) + (x - 1)","attributes":{},"skip":false,"key":"1.2.14.3"},{"backlink":"develop-path5.html#fig1.2.14.4","level":"1.2.14","list_caption":"Figure: 1-dimensional example","alt":"1-dimensional example","nro":21,"url":"picture/fig_path5-12.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"1-dimensional example","attributes":{},"skip":false,"key":"1.2.14.4"},{"backlink":"develop-path5.html#fig1.2.14.5","level":"1.2.14","list_caption":"Figure: 2-dimensional example","alt":"2-dimensional example","nro":22,"url":"picture/fig_path5-13.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"2-dimensional example","attributes":{},"skip":false,"key":"1.2.14.5"},{"backlink":"develop-path6.html#fig1.2.16.1","level":"1.2.16","list_caption":"Figure: update cutoff value based on factorized nx, ny and nz","alt":"update cutoff value based on factorized nx, ny and nz","nro":23,"url":"picture/fig_path6-1.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"update cutoff value based on factorized nx, ny and nz","attributes":{},"skip":false,"key":"1.2.16.1"},{"backlink":"develop-path10.html#fig1.2.20.1","level":"1.2.20","list_caption":"Figure: parallelization over kpoints","alt":"parallelization over kpoints","nro":24,"url":"picture/fig_path10-3.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"parallelization over kpoints","attributes":{},"skip":false,"key":"1.2.20.1"},{"backlink":"develop-path10.html#fig1.2.20.2","level":"1.2.20","list_caption":"Figure: parts on which we are concentrated now","alt":"parts on which we are concentrated now","nro":25,"url":"picture/fig_path10-4.png","index":2,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"parts on which we are concentrated now","attributes":{},"skip":false,"key":"1.2.20.2"},{"backlink":"develop-path10.html#fig1.2.20.3","level":"1.2.20","list_caption":"Figure: PW和LCAO的代码设计平行关系与调用","alt":"PW和LCAO的代码设计平行关系与调用","nro":26,"url":"picture/fig_path10-5.png","index":3,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"PW和LCAO的代码设计平行关系与调用","attributes":{},"skip":false,"key":"1.2.20.3"},{"backlink":"develop-path10.html#fig1.2.20.4","level":"1.2.20","list_caption":"Figure: Relationship between variables that matter presently","alt":"Relationship between variables that matter presently","nro":27,"url":"picture/fig_path10-6.png","index":4,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"Relationship between variables that matter presently","attributes":{},"skip":false,"key":"1.2.20.4"},{"backlink":"develop-path10.html#fig1.2.20.5","level":"1.2.20","list_caption":"Figure: Higher resolution framework of diag_mock() and relationship with other modules and functions","alt":"Higher resolution framework of diag_mock() and relationship with other modules and functions","nro":28,"url":"picture/fig_path10-9.png","index":5,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"Higher resolution framework of diag_mock() and relationship with other modules and functions","attributes":{},"skip":false,"key":"1.2.20.5"},{"backlink":"develop-path11.html#fig1.2.21.1","level":"1.2.21","list_caption":"Figure: mixing方法的通用框架设计","alt":"mixing方法的通用框架设计","nro":29,"url":"picture/fig_path11-3.png","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"mixing方法的通用框架设计","attributes":{},"skip":false,"key":"1.2.21.1"},{"backlink":"algorithm-wannier.html#fig1.3.1.1","level":"1.3.1","list_caption":"Figure: 左列：不同k点对应的布洛赫波函数；右列：不同晶格中的Wannier函数。","alt":"左列：不同k点对应的布洛赫波函数；右列：不同晶格中的Wannier函数。","nro":30,"url":"picture/fig_wannier.jpg","index":1,"caption_template":"图 _PAGE_IMAGE_NUMBER_. _CAPTION_","label":"左列：不同k点对应的布洛赫波函数；右列：不同晶格中的Wannier函数。","attributes":{},"skip":false,"key":"1.3.1.1"}]},"gitbook":"*","description":"国产DFT开源软件ABACUS中文使用教程"},"file":{"path":"develop-path10.md","mtime":"2023-10-05T09:43:52.216Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-04-03T08:28:30.646Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-auto-scroll-table/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-3-ba/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-insert-logo/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mathjax-pro/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

